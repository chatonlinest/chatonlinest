<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHAT-ONLINE-ST</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-storage.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .message-container {
            display: flex;
            align-items: flex-end;
            margin-bottom: 16px;
            position: relative;
            animation: fadeInUp 0.3s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .my-message-container {
            justify-content: flex-end;
            flex-direction: row;
        }
        
        .other-message-container {
            justify-content: flex-start;
            flex-direction: row;
        }
        
        .message-bubble {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #1a202c;
            padding: 12px 16px;
            border-radius: 20px 20px 20px 4px;
            max-width: 70%;
            word-wrap: break-word;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }

        .message-bubble.system-message {
            border: 1px dashed rgba(255, 255, 255, 0.6);
        }

        .message-container.stia-message .message-bubble {
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            color: #fff;
            box-shadow: 0 10px 30px rgba(14, 165, 233, 0.35);
        }

        .message-container.stia-message .message-time {
            color: rgba(255, 255, 255, 0.85);
        }

        .message-container.stia-message .user-avatar {
            border-color: rgba(14, 165, 233, 0.8);
            box-shadow: 0 6px 18px rgba(14, 165, 233, 0.45);
        }

        .stia-badge {
            background: rgba(14, 165, 233, 0.15);
            color: #0ea5e9;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 999px;
            margin-left: 8px;
            letter-spacing: 0.05em;
        }
        
        .message-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .my-message-container .message-bubble {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-radius: 20px 20px 4px 20px;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-right: 12px;
        }
        
        .my-message-container .user-info {
            order: 1;
            margin-left: 12px;
            margin-right: 0;
            align-items: flex-end;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 4px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: white;
            cursor: pointer;
            position: relative;
        }
        
        .user-avatar:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.6);
        }
        
        .user-avatar::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            background-color: #94a3b8; /* Default offline color */
            transition: background-color 0.3s ease;
        }
        
        .user-avatar.online::after {
            background-color: #22c55e; /* Online color */
        }
        
        .user-nickname {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .my-message-container .user-nickname {
            color: #cbd5e1;
        }
        
        .message-time {
            font-size: 0.65rem;
            color: #94a3b8;
            text-align: right;
            margin-top: 6px;
            font-weight: 400;
        }
        
        .my-message-container .message-time {
            color: rgba(255, 255, 255, 0.8);
            text-align: left;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 0;
            margin: 0;
            overflow: hidden;
            box-shadow: none;
        }
        
        #chat-messages, #private-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background: transparent;
            border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        }
        
        .message-input-area {
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            border-top: 1px solid rgba(226, 232, 240, 0.5);
        }
        
        .input-row {
            display: flex;
            width: 100%;
            align-items: center;
            gap: 12px;
        }
        
        .message-input-area input {
            flex-grow: 1;
            border: 2px solid rgba(226, 232, 240, 0.5);
            padding: 12px 16px;
            border-radius: 25px;
            background: rgba(248, 250, 252, 0.8);
            font-size: 0.95rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        .message-input-area input:focus {
            outline: none;
            border-color: #4f46e5;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .message-input-area button {
            padding: 12px 16px;
            border-radius: 25px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        #send-button, #private-send-button {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        #send-button:hover, #private-send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
        }
        
        #media-button, #private-media-button {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3);
        }
        
        #media-button:hover, #private-media-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(100, 116, 139, 0.4);
        }
        
        .delete-message-button, .download-media-button, .reply-message-button {
            position: absolute;
            top: -10px;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        
        .delete-message-button {
            right: -10px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .delete-message-button:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: scale(1.1);
        }
        
        .download-media-button {
            right: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .download-media-button:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: scale(1.1);
        }
        
        .reply-message-button {
            right: 50px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .reply-message-button:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: scale(1.1);
        }
        
        .my-message-container .delete-message-button {
            left: -10px;
            right: auto;
        }
        
        .my-message-container .download-media-button {
            left: 20px;
            right: auto;
        }
        
        .my-message-container .reply-message-button {
            left: 50px;
            right: auto;
        }
        
        .message-bubble:hover .delete-message-button,
        .message-bubble:hover .download-media-button,
        .message-bubble:hover .reply-message-button {
            opacity: 1;
        }
        
        .admin-icon {
            margin-left: 6px;
            font-size: 0.9em;
            vertical-align: middle;
            display: inline-block;
            transform: translateY(-1px);
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
        }
        
        .stevest-crown {
            font-size: 1.3em;
            color: #ffd700;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.8), 0 0 16px rgba(255, 215, 0, 0.6);
            animation: pulse-gold 2s infinite alternate;
        }
        
        @keyframes pulse-gold {
            0% { 
                transform: scale(1) translateY(-1px); 
                opacity: 1; 
                filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
            }
            100% { 
                transform: scale(1.15) translateY(-2px); 
                opacity: 0.9; 
                filter: drop-shadow(0 0 12px rgba(255, 215, 0, 1));
            }
        }
        
        .level-5-crown { 
            color: #8a2be2; 
            text-shadow: 0 0 6px rgba(138, 43, 226, 0.8); 
        }
        
        .level-4-crown { 
            color: #00ced1; 
            text-shadow: 0 0 6px rgba(0, 206, 209, 0.8); 
        }
        
        .level-3-crown { 
            color: #ff4500; 
            text-shadow: 0 0 6px rgba(255, 69, 0, 0.8); 
        }
        
        .level-2-crown { 
            color: #1e90ff; 
            text-shadow: 0 0 6px rgba(30, 144, 255, 0.8); 
        }
        
        .level-1-crown { 
            color: #32cd32; 
            text-shadow: 0 0 6px rgba(50, 205, 50, 0.8); 
        }
        
        .premium-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .custom-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .custom-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            width: 90%;
            max-width: 420px;
            text-align: center;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .custom-modal-overlay.show .custom-modal-content {
            transform: scale(1) translateY(0);
        }
        
        .custom-modal-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }
        
        .custom-modal-icon.success { color: #22c55e; }
        .custom-modal-icon.error { color: #ef4444; }
        .custom-modal-icon.info { color: #3b82f6; }
        .custom-modal-icon.warning { color: #f59e0b; }
        
        .custom-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 16px;
            letter-spacing: -0.025em;
        }
        
        .custom-modal-message {
            font-size: 1rem;
            color: #4b5563;
            margin-bottom: 28px;
            line-height: 1.6;
        }
        
        .custom-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        
        .custom-modal-button {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-family: inherit;
            font-size: 0.95rem;
        }
        
        .custom-modal-button.confirm {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .custom-modal-button.confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }
        
        .custom-modal-button.cancel {
            background: rgba(243, 244, 246, 0.8);
            color: #374151;
            border: 2px solid rgba(209, 213, 219, 0.5);
            backdrop-filter: blur(10px);
        }
        
        .custom-modal-button.cancel:hover {
            background: rgba(229, 231, 235, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .custom-modal-button.alert-ok {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .custom-modal-button.alert-ok:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
        }
        
        .media-thumbnail {
            width: 180px;
            height: 180px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 8px;
            display: block;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .media-thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .media-container {
            margin-bottom: 12px;
        }
        
        .upload-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .upload-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .upload-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            text-align: center;
            width: 90%;
            max-width: 380px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .upload-modal-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 24px;
            letter-spacing: -0.025em;
        }
        
        .upload-progress-bar-container {
            background-color: rgba(226, 232, 240, 0.8);
            border-radius: 12px;
            height: 20px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .upload-progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transition: width 0.3s ease;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }
        
        .upload-percentage-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #374151;
        }
        
        #media-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #media-viewer-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        #media-viewer-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        #media-viewer-close-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 201;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        #media-viewer-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        #reply-preview-container, #private-reply-preview-container {
            background: linear-gradient(135deg, rgba(240, 244, 248, 0.9) 0%, rgba(226, 232, 240, 0.9) 100%);
            border-left: 4px solid #4f46e5;
            padding: 12px 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        #reply-preview-container.hidden, #private-reply-preview-container.hidden {
            display: none;
        }
        
        #reply-preview-content, #private-reply-preview-content {
            flex-grow: 1;
            padding-right: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        #reply-preview-content strong, #private-reply-preview-content strong {
            color: #1f2937;
            font-weight: 600;
            margin-right: 8px;
        }
        
        #reply-preview-content span, #private-reply-preview-content span {
            color: #4b5563;
            font-size: 0.9rem;
        }
        
        #reply-cancel-button, #private-reply-cancel-button {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 1.3rem;
            cursor: pointer;
            padding: 8px;
            transition: all 0.2s ease;
            border-radius: 50%;
        }
        
        #reply-cancel-button:hover, #private-reply-cancel-button:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            transform: scale(1.1);
        }
        
        .reply-original-message {
            background: rgba(209, 213, 219, 0.8);
            border-left: 3px solid #4f46e5;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #4b5563;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            backdrop-filter: blur(10px);
            position: relative;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .reply-original-message:hover {
            background: rgba(209, 213, 219, 0.95);
            transform: translateX(2px);
        }
        
        .my-message-container .reply-original-message {
            background: rgba(96, 165, 250, 0.8);
            border-left-color: #1e40af;
            color: white;
        }
        
        .my-message-container .reply-original-message:hover {
            background: rgba(96, 165, 250, 0.95);
        }
        
        .reply-media-preview {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .reply-media-thumbnail {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .reply-media-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            color: white;
        }
        
        .reply-media-icon.image {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .reply-media-icon.video {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .reply-indicator {
            position: absolute;
            top: -8px;
            left: 12px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 5;
        }
        
        .my-message-container .reply-indicator {
            left: auto;
            right: 12px;
        }
        
        @keyframes replyPulse {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
        
        .message-bubble.has-reply {
            animation: replyPulse 1.5s ease-out;
        }
        
        .reply-count {
            position: absolute;
            bottom: -8px;
            right: 12px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 5;
        }
        
        .my-message-container .reply-count {
            right: auto;
            left: 12px;
        }
        
        .replies-list {
            margin-top: 12px;
            padding-left: 16px;
            border-left: 2px dashed rgba(79, 70, 229, 0.3);
        }
        
        .reply-item {
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(241, 245, 249, 0.7);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .reply-item:hover {
            background: rgba(241, 245, 249, 0.9);
            transform: translateX(4px);
        }
        
        .reply-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .reply-item-sender {
            font-weight: 600;
            color: #4f46e5;
        }
        
        .reply-item-time {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .expand-replies-button {
            background: none;
            border: none;
            color: #4f46e5;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .expand-replies-button:hover {
            background: rgba(79, 70, 229, 0.1);
        }
        
        /* Sistema de notícias melhorado */
        .news-system {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.9) 0%, rgba(124, 58, 237, 0.9) 100%);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            max-height: 50px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 2px 10px rgba(79, 70, 229, 0.2);
            transition: all 0.3s ease;
        }
        
        .news-system:hover {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.95) 0%, rgba(124, 58, 237, 0.95) 100%);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }
        
        .news-ticker {
            display: flex;
            align-items: center;
            height: 34px;
            white-space: nowrap;
            animation: scroll-news 40s linear infinite;
        }
        
        .news-item {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            margin-right: 50px;
            display: inline-flex;
            align-items: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
            transition: all 0.2s ease;
        }
        
        .news-item:hover {
            transform: scale(1.02);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .news-item .news-icon {
            margin-right: 8px;
            font-size: 1.1rem;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
            animation: pulse-icon 2s infinite alternate;
        }
        
        @keyframes pulse-icon {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        
        .news-item.dono {
            color: #ffd700;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.7), 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .news-item.admin {
            color: #e0e7ff;
        }
        
        @keyframes scroll-news {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .news-system:hover .news-ticker {
            animation-play-state: paused;
        }
        
        .news-system.empty {
            display: none;
        }
        
        .admin-screen-container,
        .users-screen-container,
        .profile-screen-container,
        .news-history-screen-container,
        .visit-profile-screen-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            backdrop-filter: blur(20px);
            border-radius: 0;
            margin: 0;
            overflow: hidden;
            box-shadow: none;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 50;
        }
        
        .admin-screen-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);
        }
        
        .admin-screen-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .admin-screen-subtitle {
            margin: 8px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .admin-close-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .admin-close-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .admin-screen-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            padding-bottom: 100px; /* Espaço para a navegação inferior */
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }
        
        .admin-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .admin-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }
        
        .admin-card.stevest-only {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 193, 7, 0.1) 100%);
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .admin-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(226, 232, 240, 0.5);
        }
        
        .admin-card-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .admin-card-icon {
            font-size: 1.5rem;
            margin-right: 12px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
        }
        
        .ban-icon { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .mute-icon { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .delete-icon { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        .danger-icon { background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); }
        .crown-icon { background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%); color: #1f2937; }
        .stats-icon { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .users-icon { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .news-history-icon { background: linear-gradient(135deg, #6d28d9 0%, #7e22ce 100%); }
        .private-chat-icon { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .premium-icon { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        
        .admin-card-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .admin-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(226, 232, 240, 0.5);
            border-radius: 12px;
            background: rgba(248, 250, 252, 0.8);
            font-size: 0.95rem;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .admin-select:focus {
            outline: none;
            border-color: #4f46e5;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .admin-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(226, 232, 240, 0.5);
            border-radius: 12px;
            background: rgba(248, 250, 252, 0.8);
            font-size: 0.95rem;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .admin-input:focus {
            outline: none;
            border-color: #4f46e5;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .admin-input-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .admin-button {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .admin-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .admin-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .ban-button { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .mute-button { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .delete-button { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        .danger-button { background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); }
        .crown-button { background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%); color: #1f2937; }
        .news-history-button { background: linear-gradient(135deg, #6d28d9 0%, #7e22ce 100%); }
        .private-chat-button { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .premium-button { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .stat-item {
            background: rgba(248, 250, 252, 0.8);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(226, 232, 240, 0.5);
            backdrop-filter: blur(10px);
        }
        
        .stat-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .stat-value {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .users-screen-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
        
        .users-screen-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .users-screen-subtitle {
            margin: 8px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .users-close-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .users-close-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .users-screen-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .user-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
        }
        
        .user-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }
        
        .user-card-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            color: white;
            position: relative;
        }
        
        .user-card-avatar::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            background-color: #94a3b8; /* Default offline color */
            transition: background-color 0.3s ease;
        }
        
        .user-card-avatar.online::after {
            background-color: #22c55e; /* Online color */
        }
        
        .user-card-info {
            flex: 1;
            min-width: 0;
        }
        
        .user-card-nickname {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1f2937;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-card-status {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-banned {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .status-muted {
            background: rgba(249, 115, 22, 0.1);
            color: #ea580c;
            border: 1px solid rgba(249, 115, 22, 0.3);
        }
        
        .status-online {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .status-offline {
            background: rgba(148, 163, 184, 0.1);
            color: #64748b;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }
        
        .status-locked {
            background: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
            border: 1px solid rgba(79, 70, 229, 0.3);
        }
        
        .status-premium {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .profile-screen-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }
        
        .profile-screen-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .profile-screen-subtitle {
            margin: 8px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .profile-close-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .profile-close-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .profile-screen-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .stia-profile-card {
            width: 100%;
            max-width: 640px;
            margin-top: 32px;
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 15px 35px rgba(15, 23, 42, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.15);
        }

        .stia-profile-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 16px;
        }

        .stia-profile-card-header h2 {
            margin: 0;
            font-size: 1.25rem;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stia-profile-description {
            margin: 0;
            color: #4b5563;
            font-size: 0.95rem;
        }

        .stia-profile-chip {
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            color: white;
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .stia-profile-assets {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .stia-profile-cover-container {
            position: relative;
            width: 100%;
            height: 160px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.1);
        }

        .stia-profile-cover-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
        }

        .stia-profile-avatar-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .stia-profile-avatar-img {
            width: 120px;
            height: 120px;
            border-radius: 999px;
            border: 4px solid rgba(99, 102, 241, 0.4);
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.15);
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            font-weight: 700;
            color: white;
        }

        .stia-profile-identity {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-top: 16px;
        }

        .stia-profile-lock-alert {
            margin-top: 12px;
            font-size: 0.9rem;
            text-align: center;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px dashed rgba(99, 102, 241, 0.4);
            color: #4338ca;
            background: rgba(59, 130, 246, 0.08);
        }

        .stia-profile-lock-alert.locked {
            color: #b91c1c;
            border-color: rgba(220, 38, 38, 0.4);
            background: rgba(248, 113, 113, 0.15);
        }

        .stia-profile-lock-alert.unlocked {
            color: #065f46;
            border-color: rgba(16, 185, 129, 0.4);
            background: rgba(16, 185, 129, 0.15);
        }
        
        .profile-cover-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 200px;
            margin-bottom: 24px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .profile-cover-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        
        .profile-cover-upload-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.2s ease;
        }

        .profile-cover-upload-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .profile-cover-upload-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .profile-avatar-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin-bottom: 24px;
            margin-top: -60px;
            z-index: 10;
        }
        
        .profile-avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid rgba(59, 130, 246, 0.5);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 48px;
            color: white;
        }
        
        .profile-upload-button {
            position: absolute;
            bottom: 0;
            right: 0;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.2s ease;
        }
        
        .profile-upload-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .profile-upload-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .profile-form-group {
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }
        
        .profile-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 8px;
        }
        
        .profile-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(226, 232, 240, 0.5);
            border-radius: 12px;
            background: rgba(248, 250, 252, 0.8);
            font-size: 1rem;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .profile-input:focus {
            outline: none;
            border-color: #4f46e5;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .profile-button {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }
        
        .profile-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .profile-button.save {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            margin-bottom: 12px;
        }
        
        .profile-button.logout {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .profile-toggle-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            margin-bottom: 12px;
        }
        
        .remember-me-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 400px;
        }
        
        .remember-me-checkbox {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .remember-me-label {
            font-size: 0.9rem;
            color: #4b5563;
            cursor: pointer;
        }
        
        header {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.5);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(241, 245, 249, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
        }
        
        @media (max-width: 768px) {
            .admin-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .admin-screen-header {
                padding: 16px;
            }
            
            .admin-screen-title {
                font-size: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .users-grid {
                grid-template-columns: 1fr;
            }
            
            .users-screen-header {
                padding: 16px;
            }
            
            .users-screen-title {
                font-size: 1.5rem;
            }
            
            .message-bubble {
                max-width: 85%;
            }
            
            .custom-modal-content {
                padding: 24px;
                margin: 20px;
            }
            
            .media-thumbnail {
                width: 150px;
                height: 150px;
            }
            
            .news-item {
                font-size: 0.8rem;
                margin-right: 30px;
            }
            
            .profile-screen-header {
                padding: 16px;
            }
            
            .profile-screen-title {
                font-size: 1.5rem;
            }
            
            .profile-cover-container {
                height: 150px;
            }
            
            .profile-avatar-container {
                width: 100px;
                height: 100px;
                margin-top: -50px;
            }
            
            .news-system {
                padding: 6px 12px;
                max-height: 40px;
            }
            
            .news-ticker {
                height: 28px;
            }
            
            .news-item {
                font-size: 0.8rem;
                margin-right: 30px;
            }
        }
        
        .private-chat-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        
        .private-chat-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .private-chat-header .user-avatar {
            width: 36px;
            height: 36px;
            margin-right: 12px;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .private-chat-close-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .private-chat-close-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        #private-chat {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
            z-index: 60;
        }
        
        .news-history-screen-header {
            background: linear-gradient(135deg, #6d28d9 0%, #7e22ce 100%);
            color: white;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(109, 40, 217, 0.3);
        }
        
        .news-history-screen-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .news-history-screen-subtitle {
            margin: 8px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .news-history-close-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .news-history-close-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .news-history-screen-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .news-history-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .news-history-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .news-history-item-info {
            flex-grow: 1;
        }
        
        .news-history-item-text {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .news-history-item-time {
            font-size: 0.8rem;
            color: #64748b;
        }
        
        .news-history-item-delete-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .news-history-item-delete-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .new-messages-indicator {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            z-index: 10;
            transition: all 0.2s ease;
            display: none;
        }
        
        .new-messages-indicator:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
        }
        
        .visit-profile-screen-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
        
        .visit-profile-screen-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .visit-profile-screen-subtitle {
            margin: 8px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .visit-profile-close-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .visit-profile-close-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .visit-profile-screen-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .visit-profile-cover-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 200px;
            margin-bottom: 24px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .visit-profile-cover-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .visit-profile-avatar-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin-bottom: 24px;
            margin-top: -60px;
            z-index: 10;
        }
        
        .visit-profile-avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid rgba(16, 185, 129, 0.5);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 48px;
            color: white;
        }
        
        .visit-profile-info {
            width: 100%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .visit-profile-nickname {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .visit-profile-status {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }
        
        .visit-profile-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        
        .visit-profile-button {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .visit-profile-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .visit-profile-button.chat {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        
        .visit-profile-button.back {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }
        
        /* Navegação inferior para o painel de administração */
        .admin-bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -4px 20px rgba(79, 70, 229, 0.3);
            z-index: 100;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .admin-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 8px 0;
            position: relative;
        }
        
        .admin-nav-item.active {
            color: white;
        }
        
        .admin-nav-item.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: white;
            border-radius: 0 0 3px 3px;
        }
        
        .admin-nav-item:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .admin-nav-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }
        
        .admin-nav-text {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        .danger-tab {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .danger-tab .admin-nav-item.active {
            color: white;
        }
        
        .danger-tab .admin-nav-item.active::after {
            background: white;
        }
        
        .danger-tab .admin-nav-item:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .danger-tab .admin-nav-icon {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .danger-tab .admin-nav-item.active .admin-nav-icon {
            color: white;
        }
        
        .danger-tab .admin-nav-item:hover .admin-nav-icon {
            color: white;
        }
        
        .light-tab {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .light-tab .admin-nav-item.active {
            color: white;
        }
        
        .light-tab .admin-nav-item.active::after {
            background: white;
        }
        
        .light-tab .admin-nav-item:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .light-tab .admin-nav-icon {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .light-tab .admin-nav-item.active .admin-nav-icon {
            color: white;
        }
        
        .light-tab .admin-nav-item:hover .admin-nav-icon {
            color: white;
        }
        
        /* Estilos para o modal de GIF */
        .gif-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .gif-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .gif-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .gif-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .gif-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .gif-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .gif-modal-close:hover {
            color: #1f2937;
            transform: scale(1.1);
        }
        
        .gif-search-container {
            display: flex;
            margin-bottom: 20px;
        }
        
        .gif-search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(226, 232, 240, 0.5);
            border-radius: 12px 0 0 12px;
            background: rgba(248, 250, 252, 0.8);
            font-size: 1rem;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s ease;
            border-right: none;
        }
        
        .gif-search-input:focus {
            outline: none;
            border-color: #4f46e5;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .gif-search-button {
            padding: 12px 20px;
            border: 2px solid rgba(226, 232, 240, 0.5);
            border-radius: 0 12px 12px 0;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: none;
        }
        
        .gif-search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .gif-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .gif-category {
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(226, 232, 240, 0.8);
            color: #4b5563;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .gif-category:hover, .gif-category.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }
        
        .gif-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .gif-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .gif-item:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .gif-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }
        
        .gif-item-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .gif-item:hover .gif-item-overlay {
            opacity: 1;
        }
        
        .gif-select-button {
            padding: 8px 16px;
            border-radius: 8px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .gif-select-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .gif-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .gif-loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(79, 70, 229, 0.3);
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .gif-error {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .gif-pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .gif-pagination button {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: rgba(226, 232, 240, 0.8);
            color: #4b5563;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .gif-pagination button:hover, .gif-pagination button.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }
        
        .gif-pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .premium-notice {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.1) 100%);
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
            color: #92400e;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.1);
        }
        
        .premium-notice-icon {
            font-size: 1.5rem;
            margin-right: 8px;
            color: #f59e0b;
        }
        
        /* Novos estilos para o seletor de usuários melhorado */
        .user-selector-container {
            position: relative;
            width: 100%;
        }
        
        .user-selector-input {
            width: 100%;
            padding: 12px 16px;
            padding-right: 40px;
            border: 2px solid rgba(226, 232, 240, 0.5);
            border-radius: 12px;
            background: rgba(248, 250, 252, 0.8);
            font-size: 0.95rem;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .user-selector-input:focus {
            outline: none;
            border-color: #4f46e5;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .user-selector-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 50;
            margin-top: 5px;
            display: none;
        }
        
        .user-selector-dropdown.show {
            display: block;
        }
        
        .user-selector-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(226, 232, 240, 0.3);
        }
        
        .user-selector-item:last-child {
            border-bottom: none;
        }
        
        .user-selector-item:hover {
            background: rgba(79, 70, 229, 0.1);
        }
        
        .user-selector-item.selected {
            background: rgba(79, 70, 229, 0.2);
        }
        
        .user-selector-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }
        
        .user-selector-info {
            flex: 1;
            min-width: 0;
        }
        
        .user-selector-nickname {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-selector-status {
            display: flex;
            gap: 6px;
            margin-top: 2px;
        }
        
        .user-selector-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .user-selector-badge.admin {
            background: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
        }
        
        .user-selector-badge.banned {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        
        .user-selector-badge.muted {
            background: rgba(249, 115, 22, 0.1);
            color: #ea580c;
        }
        
        .user-selector-badge.premium {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .user-selector-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6b7280;
            font-size: 1rem;
            cursor: pointer;
            display: none;
        }
        
        .user-selector-clear.show {
            display: block;
        }
        
        .user-selector-clear:hover {
            color: #ef4444;
        }
        
        /* Estilos para o sistema de navegação com histórico */
        .back-button {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
            margin-right: 12px;
        }
        
        .back-button:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(107, 114, 128, 0.4);
        }
        
        .navigation-breadcrumb {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 6px 12px;
            margin-left: 12px;
            font-size: 0.85rem;
            color: white;
            opacity: 0.8;
        }
        
        .navigation-breadcrumb-item {
            display: flex;
            align-items: center;
        }
        
        .navigation-breadcrumb-item:not(:last-child)::after {
            content: '›';
            margin: 0 6px;
            opacity: 0.7;
        }
        
        /* Estilos para o upload de GIF do dispositivo */
        .gif-upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed rgba(79, 70, 229, 0.5);
            border-radius: 12px;
            background: rgba(248, 250, 252, 0.8);
            margin-bottom: 20px;
            transition: all 0.2s ease;
        }
        
        .gif-upload-container:hover {
            background: rgba(248, 250, 252, 0.95);
            border-color: rgba(79, 70, 229, 0.8);
        }
        
        .gif-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        
        .gif-upload-icon {
            font-size: 2rem;
            color: #4f46e5;
            margin-bottom: 10px;
        }
        
        .gif-upload-text {
            font-size: 0.9rem;
            font-weight: 500;
            color: #4b5563;
            text-align: center;
        }
        
        .gif-upload-input {
            display: none;
        }
        
        .gif-preview-container {
            display: none;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .gif-preview-container.show {
            display: block;
        }
        
        .gif-preview-image {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 10px;
        }
        
        .gif-preview-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .gif-preview-button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .gif-preview-button.use {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }
        
        .gif-preview-button.use:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .gif-preview-button.cancel {
            background: rgba(243, 244, 246, 0.8);
            color: #374151;
            border: 1px solid rgba(209, 213, 219, 0.5);
        }
        
        .gif-preview-button.cancel:hover {
            background: rgba(229, 231, 235, 0.9);
        }
        
        /* Melhorias no sistema de respostas */
        .reply-container {
            position: relative;
            margin-bottom: 8px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .reply-container:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .reply-header {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            background: rgba(79, 70, 229, 0.1);
            border-bottom: 1px solid rgba(79, 70, 229, 0.2);
        }
        
        .reply-header-text {
            font-size: 0.75rem;
            font-weight: 600;
            color: #4f46e5;
            display: flex;
            align-items: center;
        }
        
        .reply-header-text i {
            margin-right: 4px;
        }
        
        .reply-content {
            display: flex;
            padding: 8px 10px;
            background: rgba(240, 244, 248, 0.8);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .reply-content:hover {
            background: rgba(240, 244, 248, 1);
        }
        
        .reply-text {
            flex: 1;
            font-size: 0.85rem;
            color: #4b5563;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .reply-media {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            margin-left: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .reply-media-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            color: white;
            margin-left: 8px;
        }
        
        .reply-media-icon.image {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .reply-media-icon.video {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .my-message-container .reply-header {
            background: rgba(96, 165, 250, 0.2);
            border-bottom-color: rgba(96, 165, 250, 0.3);
        }
        
        .my-message-container .reply-header-text {
            color: #1e40af;
        }
        
        .my-message-container .reply-content {
            background: rgba(96, 165, 250, 0.2);
        }
        
        .my-message-container .reply-text {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .highlight-message {
            animation: highlightPulse 2s ease-out;
        }
        
        @keyframes highlightPulse {
            0% { 
                background-color: rgba(79, 70, 229, 0.3);
                transform: scale(1);
            }
            50% { 
                background-color: rgba(79, 70, 229, 0.5);
                transform: scale(1.02);
            }
            100% { 
                background-color: transparent;
                transform: scale(1);
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen overflow-hidden">
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm z-30">
                <div class="h-16 flex items-center px-4 relative">
                    <div class="relative">
                        <button id="config-button" class="bg-gradient-to-r from-gray-500 to-gray-700 text-white px-4 py-2 rounded-lg font-semibold hover:from-gray-600 hover:to-gray-800 transition-all duration-200 shadow-lg mr-3">
                            <i class="fas fa-cogs mr-2"></i>
                        </button>
                        <div id="config-menu" class="absolute top-full left-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-40 hidden">
                            <button id="profile-screen-button" class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-md transition-colors duration-150">
                                <i class="fas fa-user-circle mr-2"></i>PERFIL
                            </button>
                            <button id="users-screen-button" class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-md transition-colors duration-150">
                                <i class="fas fa-users mr-2"></i>USUÁRIOS
                            </button>
                            <button id="admin-screen-button" class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-md transition-colors duration-150">
                                <i class="fas fa-cog mr-2"></i>ADMINISTRAÇÃO
                            </button>
                            <button id="news-history-screen-button" class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-md transition-colors duration-150">
                                <i class="fas fa-history mr-2"></i>HISTÓRICO DE NOTÍCIAS
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            <div id="news-system" class="news-system empty">
                <div id="news-ticker" class="news-ticker">
                </div>
            </div>
            <div id="profile-screen" class="hidden flex-1 overflow-hidden bg-gray-50 relative">
                <div class="profile-screen-container">
                    <div class="profile-screen-header">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <button id="back-to-main-from-profile" class="back-button">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <h1 class="profile-screen-title">
                                    <i class="fas fa-user-circle mr-3"></i>
                                    MEU PERFIL
                                </h1>
                            </div>
                            <button id="close-profile-screen" class="profile-close-button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p class="profile-screen-subtitle">Gerencie suas informações de perfil</p>
                    </div>
                    <div class="profile-screen-content">
                        <div class="profile-cover-container">
                            <div id="profile-cover" class="profile-cover-img"></div>
                            <input type="file" id="profile-cover-upload" class="hidden" accept="image/*">
                            <button id="profile-cover-photo-button" onclick="document.getElementById('profile-cover-upload').click()" class="profile-cover-upload-button">
                                <i class="fas fa-camera text-lg"></i>
                            </button>
                            <button id="profile-cover-gif-button" class="profile-cover-upload-button" style="bottom: 60px;">
                                <i class="fas fa-film text-lg"></i>
                            </button>
                        </div>
                        <div class="profile-avatar-container">
                            <div id="profile-pic" class="profile-avatar-img"></div>
                            <input type="file" id="profile-upload" class="hidden" accept="image/*">
                            <button id="profile-photo-button" onclick="document.getElementById('profile-upload').click()" class="profile-upload-button">
                                <i class="fas fa-camera text-lg"></i>
                            </button>
                            <button id="profile-gif-button" class="profile-upload-button" style="bottom: 60px;">
                                <i class="fas fa-film text-lg"></i>
                            </button>
                        </div>
                        <div id="display-nickname" class="text-xl font-bold text-gray-800 mb-4"></div>
                        
                        <div class="profile-form-group">
                            <label for="nickname" class="profile-label">APELIDO</label>
                            <input id="nickname" type="text" class="profile-input" placeholder="SEU APELIDO">
                        </div>
                        <div class="profile-form-group">
                            <label for="password" class="profile-label">SENHA</label>
                            <input id="password" type="password" class="profile-input" placeholder="SUA SENHA">
                        </div>
                        <div class="remember-me-container">
                            <input type="checkbox" id="remember-me" class="remember-me-checkbox">
                            <label for="remember-me" class="remember-me-label">Lembrar de mim</label>
                        </div>
                        <button id="save-profile" class="profile-button save">
                            SALVAR PERFIL
                        </button>
                        <button id="toggle-private-messages" class="profile-button profile-toggle-button">
                            <i class="fas fa-lock mr-2"></i>CHAT 🔒
                        </button>
                        <button id="logout-button" class="profile-button logout">
                            SAIR
                        </button>
                        <div id="stia-profile-editor" class="stia-profile-card hidden">
                            <div class="stia-profile-card-header">
                                <div>
                                    <h2><i class="fas fa-robot"></i> Perfil da STIA</h2>
                                    <p class="stia-profile-description">Personalize a aparência da guardiã do chat sempre que ela liberar os botões.</p>
                                </div>
                                <span class="stia-profile-chip">Somente STEVEST</span>
                            </div>
                            <div class="stia-profile-assets">
                                <div class="stia-profile-cover-container">
                                    <div id="stia-profile-cover" class="stia-profile-cover-img"></div>
                                    <input type="file" id="stia-profile-cover-upload" class="hidden" accept="image/*">
                                    <button id="stia-profile-cover-button" onclick="document.getElementById('stia-profile-cover-upload').click()" class="profile-cover-upload-button">
                                        <i class="fas fa-camera text-lg"></i>
                                    </button>
                                </div>
                                <div class="stia-profile-avatar-container">
                                    <div id="stia-profile-pic" class="stia-profile-avatar-img">S</div>
                                    <input type="file" id="stia-profile-upload" class="hidden" accept="image/*">
                                    <button id="stia-profile-photo-button" onclick="document.getElementById('stia-profile-upload').click()" class="profile-upload-button">
                                        <i class="fas fa-camera text-lg"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="stia-profile-name" class="stia-profile-identity">STIA</div>
                            <p id="stia-profile-lock-alert" class="stia-profile-lock-alert locked">Peça para a STIA liberar os botões antes de alterar o visual dela.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="visit-profile-screen" class="hidden flex-1 overflow-hidden bg-gray-50 relative">
                <div class="visit-profile-screen-container">
                    <div class="visit-profile-screen-header">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <button id="back-to-users-from-visit-profile" class="back-button">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <h1 class="visit-profile-screen-title">
                                    <i class="fas fa-user-circle mr-3"></i>
                                    PERFIL DO USUÁRIO
                                </h1>
                            </div>
                            <button id="close-visit-profile-screen" class="visit-profile-close-button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p class="visit-profile-screen-subtitle">Visualize informações do usuário</p>
                    </div>
                    <div class="visit-profile-screen-content">
                        <div class="visit-profile-cover-container">
                            <div id="visit-profile-cover" class="visit-profile-cover-img"></div>
                        </div>
                        <div class="visit-profile-avatar-container">
                            <div id="visit-profile-pic" class="visit-profile-avatar-img"></div>
                        </div>
                        <div class="visit-profile-info">
                            <div id="visit-profile-nickname" class="visit-profile-nickname"></div>
                            <div id="visit-profile-status" class="visit-profile-status"></div>
                            <div class="visit-profile-actions">
                                <button id="visit-profile-chat-button" class="visit-profile-button chat">
                                    <i class="fas fa-comment mr-2"></i>INICIAR CHAT
                                </button>
                                <button id="visit-profile-back-button" class="visit-profile-button back">
                                    <i class="fas fa-arrow-left mr-2"></i>VOLTAR
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="users-screen" class="hidden flex-1 overflow-hidden bg-gray-50 relative">
                <div class="users-screen-container">
                    <div class="users-screen-header">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <button id="back-to-main-from-users" class="back-button">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <h1 class="users-screen-title">
                                    <i class="fas fa-users mr-3"></i>
                                    LISTA DE USUÁRIOS
                                </h1>
                            </div>
                            <button id="close-users-screen" class="users-close-button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p class="users-screen-subtitle">Visualize todos os usuários conectados ao chat</p>
                    </div>
                    <div class="users-screen-content">
                        <div id="users-grid" class="users-grid">
                        </div>
                    </div>
                </div>
            </div>
            <div id="admin-screen" class="hidden flex-1 overflow-hidden bg-gray-50 relative">
                <div class="admin-screen-container">
                    <div class="admin-screen-header">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <button id="back-to-main-from-admin" class="back-button">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <h1 class="admin-screen-title">
                                    <i class="fas fa-shield-alt mr-3"></i>
                                    PAINEL DE ADMINISTRAÇÃO
                                </h1>
                            </div>
                            <button id="close-admin-screen" class="admin-close-button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p class="admin-screen-subtitle">Gerencie usuários e configurações do chat</p>
                    </div>
                    <div class="admin-screen-content">
                        <!-- Conteúdo da aba PERIGOSA -->
                        <div id="danger-tab-content" class="admin-tab-content active">
                            <div class="admin-grid">
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <i class="fas fa-user-slash admin-card-icon danger-icon"></i>
                                        <h3>DELETAR PERFIS</h3>
                                    </div>
                                    <div class="admin-card-content">
                                        <div class="user-selector-container">
                                            <input type="text" id="delete-user-profile-input" class="user-selector-input" placeholder="DELETAR PERFIL DE:">
                                            <button id="delete-user-profile-clear" class="user-selector-clear">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <div id="delete-user-profile-dropdown" class="user-selector-dropdown"></div>
                                        </div>
                                        <button id="delete-user-profile-btn-admin" class="admin-button danger-button">DELETAR PERFIL</button>
                                    </div>
                                </div>
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <i class="fas fa-trash-alt admin-card-icon delete-icon"></i>
                                        <h3>LIMPAR MENSAGENS</h3>
                                    </div>
                                    <div class="admin-card-content">
                                        <div class="user-selector-container">
                                            <input type="text" id="clear-user-messages-input" class="user-selector-input" placeholder="LIMPAR MENSAGENS DE:">
                                            <button id="clear-user-messages-clear" class="user-selector-clear">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <div id="clear-user-messages-dropdown" class="user-selector-dropdown"></div>
                                        </div>
                                        <button id="clear-user-messages-btn-admin" class="admin-button delete-button">LIMPAR MENSAGENS</button>
                                        <button id="clear-all-messages-btn-admin" class="admin-button delete-button mt-3">LIMPAR TODAS AS MENSAGENS</button>
                                    </div>
                                </div>
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <i class="fas fa-ban admin-card-icon ban-icon"></i>
                                        <h3>GERENCIAR BANIMENTOS</h3>
                                    </div>
                                    <div class="admin-card-content">
                                        <div class="user-selector-container">
                                            <input type="text" id="ban-toggle-user-input" class="user-selector-input" placeholder="SELECIONAR USUÁRIO PARA BANIR/DESBANIR:">
                                            <button id="ban-toggle-user-clear" class="user-selector-clear">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <div id="ban-toggle-user-dropdown" class="user-selector-dropdown"></div>
                                        </div>
                                        <button id="ban-toggle-btn-admin" class="admin-button ban-button">SELECIONE UM USUÁRIO</button>
                                    </div>
                                </div>
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <i class="fas fa-microphone-slash admin-card-icon mute-icon"></i>
                                        <h3>GERENCIAR SILENCIAMENTOS</h3>
                                    </div>
                                    <div class="admin-card-content">
                                        <div class="user-selector-container">
                                            <input type="text" id="mute-toggle-user-input" class="user-selector-input" placeholder="SELECIONAR USUÁRIO PARA SILENCIAR/DESSILENCIAR:">
                                            <button id="mute-toggle-user-clear" class="user-selector-clear">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <div id="mute-toggle-user-dropdown" class="user-selector-dropdown"></div>
                                        </div>
                                        <div class="admin-input-group">
                                            <input type="number" id="mute-duration-admin" placeholder="MINUTOS" min="1" value="5" class="admin-input">
                                            <button id="mute-toggle-btn-admin" class="admin-button mute-button">SELECIONE UM USUÁRIO</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conteúdo da aba RIGOROSA -->
                        <div id="rigorous-tab-content" class="admin-tab-content">
                            <div class="admin-grid">
                                <div class="admin-card stevest-only">
                                    <div class="admin-card-header">
                                        <i class="fas fa-crown admin-card-icon crown-icon"></i>
                                        <h3>GERENCIAR ADMINISTRADORES</h3>
                                    </div>
                                    <div class="admin-card-content">
                                        <div class="user-selector-container">
                                            <input type="text" id="toggle-admin-user-input" class="user-selector-input" placeholder="SELECIONAR USUÁRIO PARA TORNAR/REMOVER ADMIN:">
                                            <button id="toggle-admin-user-clear" class="user-selector-clear">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <div id="toggle-admin-user-dropdown" class="user-selector-dropdown"></div>
                                        </div>
                                        <select id="admin-level-select-admin" class="admin-select">
                                            <option value="0">REMOVER ADMIN</option>
                                            <option value="1">NÍVEL 1 - ⭐</option>
                                            <option value="2">NÍVEL 2 - 🎖️</option>
                                            <option value="3">NÍVEL 3 - 🏆</option>
                                            <option value="4">NÍVEL 4 - ⚜️</option>
                                            <option value="5">NÍVEL 5 - 🔱</option>
                                        </select>
                                        <button id="toggle-admin-btn-admin" class="admin-button crown-button">SELECIONE UM USUÁRIO</button>
                                    </div>
                                </div>
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <i class="fas fa-comment-dots admin-card-icon private-chat-icon"></i>
                                        <h3>ACESSO A CHATS PRIVADOS</h3>
                                    </div>
                                    <div class="admin-card-content">
                                        <div class="user-selector-container">
                                            <input type="text" id="admin-private-chat-user-input" class="user-selector-input" placeholder="SELECIONAR USUÁRIO PARA ACESSAR CHAT PRIVADO:">
                                            <button id="admin-private-chat-user-clear" class="user-selector-clear">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <div id="admin-private-chat-user-dropdown" class="user-selector-dropdown"></div>
                                        </div>
                                        <button id="admin-private-chat-btn" class="admin-button private-chat-button">ACESSAR CHAT PRIVADO</button>
                                    </div>
                                </div>
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <i class="fas fa-history admin-card-icon news-history-icon"></i>
                                        <h3>HISTÓRICO DE NOTÍCIAS</h3>
                                    </div>
                                    <div class="admin-card-content">
                                        <button id="view-news-history-btn-admin" class="admin-button news-history-button">VER HISTÓRICO DE NOTÍCIAS</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conteúdo da aba LEVE -->
                        <div id="light-tab-content" class="admin-tab-content">
                            <div class="admin-grid">
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <i class="fas fa-chart-bar admin-card-icon stats-icon"></i>
                                        <h3>ESTATÍSTICAS DO CHAT</h3>
                                    </div>
                                    <div class="admin-card-content">
                                        <div class="stats-grid">
                                            <div class="stat-item">
                                                <span class="stat-label">USUÁRIOS ONLINE:</span>
                                                <span id="online-users-count" class="stat-value">0</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">USUÁRIOS BANIDOS:</span>
                                                <span id="banned-users-count" class="stat-value">0</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">USUÁRIOS SILENCIADOS:</span>
                                                <span id="muted-users-count" class="stat-value">0</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">ADMINISTRADORES:</span>
                                                <span id="admin-users-count" class="stat-value">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <i class="fas fa-users admin-card-icon users-icon"></i>
                                        <h3>GERENCIAR USUÁRIOS</h3>
                                    </div>
                                    <div class="admin-card-content">
                                        <button id="manage-users-btn-admin" class="admin-button news-history-button">GERENCIAR TODOS OS USUÁRIOS</button>
                                    </div>
                                </div>
                                <!-- Novo card para gerenciar Premium -->
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <i class="fas fa-star admin-card-icon premium-icon"></i>
                                        <h3>GERENCIAR PREMIUM</h3>
                                    </div>
                                    <div class="admin-card-content">
                                        <div class="user-selector-container">
                                            <input type="text" id="premium-user-input" class="user-selector-input" placeholder="SELECIONAR USUÁRIO PARA GERENCIAR PREMIUM:">
                                            <button id="premium-user-clear" class="user-selector-clear">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <div id="premium-user-dropdown" class="user-selector-dropdown"></div>
                                        </div>
                                        <div class="admin-input-group">
                                            <input type="number" id="premium-duration-admin" placeholder="DIAS" min="1" value="30" class="admin-input">
                                            <button id="grant-premium-btn-admin" class="admin-button premium-button">CONCEDER PREMIUM</button>
                                        </div>
                                        <button id="revoke-premium-btn-admin" class="admin-button danger-button mt-3">REVOGAR PREMIUM</button>
                                        <button id="self-premium-btn-admin" class="admin-button premium-button mt-3">ATIVAR PREMIUM ILIMITADO</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navegação inferior -->
                    <div class="admin-bottom-navigation">
                        <div class="admin-nav-item active" data-tab="danger">
                            <i class="fas fa-exclamation-triangle admin-nav-icon"></i>
                            <span class="admin-nav-text">PERIGOSA</span>
                        </div>
                        <div class="admin-nav-item" data-tab="rigorous">
                            <i class="fas fa-shield-alt admin-nav-icon"></i>
                            <span class="admin-nav-text">RIGOROSA</span>
                        </div>
                        <div class="admin-nav-item" data-tab="light">
                            <i class="fas fa-chart-line admin-nav-icon"></i>
                            <span class="admin-nav-text">LEVE</span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="news-history-screen" class="hidden flex-1 overflow-hidden bg-gray-50 relative">
                <div class="news-history-screen-container">
                    <div class="news-history-screen-header">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <button id="back-to-admin-from-news-history" class="back-button">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <h1 class="news-history-screen-title">
                                    <i class="fas fa-history mr-3"></i>
                                    HISTÓRICO DE NOTÍCIAS
                                </h1>
                            </div>
                            <button id="close-news-history-screen" class="news-history-close-button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p class="news-history-screen-subtitle">Visualize e gerencie as notícias antigas do chat</p>
                    </div>
                    <div class="news-history-screen-content">
                        <div id="news-history-list" class="news-history-list">
                        </div>
                    </div>
                </div>
            </div>
            <main class="flex-1 overflow-hidden bg-gray-50 relative">
                <div id="main-chat" class="chat-container">
                    <div id="chat-messages"></div>
                    <button id="new-messages-indicator" class="new-messages-indicator">NOVAS MENSAGENS</button>
                    <div class="message-input-area">
                        <div id="reply-preview-container" class="hidden">
                            <div id="reply-preview-content"></div>
                            <button id="reply-cancel-button"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="input-row">
                            <input type="file" id="media-upload" class="hidden" accept="image/*,video/*">
                            <button id="media-button" class="bg-gray-200 text-gray-600 hover:bg-gray-300 transition-colors p-3 rounded-full mr-2">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input id="message-input" type="text" placeholder="DIGITE SUA MENSAGEM...">
                            <button id="send-button" class="bg-blue-500 text-white hover:bg-blue-600 transition-colors">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="private-chat" class="chat-container hidden">
                    <div class="private-chat-header">
                        <button id="back-to-main-chat" class="private-chat-close-button">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 id="private-chat-target-user-info">
                        </h2>
                        <button id="close-private-chat" class="private-chat-close-button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="private-chat-messages" class="flex-grow overflow-y-auto p-5 bg-transparent border-b border-gray-200">
                    </div>
                    <button id="private-new-messages-indicator" class="new-messages-indicator">NOVAS MENSAGENS</button>
                    <div class="message-input-area">
                        <div id="private-reply-preview-container" class="hidden">
                            <div id="private-reply-preview-content"></div>
                            <button id="private-reply-cancel-button"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="input-row">
                            <input type="file" id="private-media-upload" class="hidden" accept="image/*,video/*">
                            <button id="private-media-button" class="bg-gray-200 text-gray-600 hover:bg-gray-300 transition-colors p-3 rounded-full mr-2">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input id="private-message-input" type="text" placeholder="DIGITE SUA MENSAGEM PRIVADA...">
                            <button id="private-send-button" class="bg-blue-500 text-white hover:bg-blue-600 transition-colors">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modal de GIF -->
    <div id="gif-modal-overlay" class="gif-modal-overlay">
        <div class="gif-modal-content">
            <div class="gif-modal-header">
                <h2 class="gif-modal-title">SELECIONE UM GIF</h2>
                <button id="gif-modal-close" class="gif-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Aba para upload de GIF do dispositivo -->
            <div class="gif-upload-container">
                <label for="gif-upload-input" class="gif-upload-label">
                    <i class="fas fa-upload gif-upload-icon"></i>
                    <span class="gif-upload-text">CARREGAR GIF DO SEU DISPOSITIVO</span>
                </label>
                <input type="file" id="gif-upload-input" class="gif-upload-input" accept="image/gif">
            </div>
            
            <div id="gif-preview-container" class="gif-preview-container">
                <img id="gif-preview-image" class="gif-preview-image" alt="Preview do GIF">
                <div class="gif-preview-buttons">
                    <button id="gif-preview-use" class="gif-preview-button use">USAR ESTE GIF</button>
                    <button id="gif-preview-cancel" class="gif-preview-button cancel">CANCELAR</button>
                </div>
            </div>
            
            <div class="gif-search-container">
                <input type="text" id="gif-search-input" class="gif-search-input" placeholder="Pesquisar GIFs...">
                <button id="gif-search-button" class="gif-search-button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div class="gif-categories">
                <div class="gif-category active" data-category="trending">EM ALTA</div>
            </div>
            <div id="gif-grid" class="gif-grid">
                <div class="gif-loading">
                    <div class="gif-loading-spinner"></div>
                </div>
            </div>
            <div id="gif-pagination" class="gif-pagination">
                <button id="gif-prev-page" disabled><i class="fas fa-chevron-left"></i></button>
                <span id="gif-page-info">Página 1</span>
                <button id="gif-next-page"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>
    
    <div id="custom-modal-overlay" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <i id="modal-icon" class="custom-modal-icon fas"></i>
            <h3 id="modal-title" class="custom-modal-title"></h3>
            <p id="modal-message" class="modal-message"></p>
            <div id="modal-buttons" class="custom-modal-buttons">
            </div>
        </div>
    </div>
    <div id="upload-modal-overlay" class="upload-modal-overlay">
        <div class="upload-modal-content">
            <h3 class="upload-modal-title">ENVIANDO MÍDIA...</h3>
            <div class="upload-progress-bar-container">
                <div id="upload-progress-bar" class="upload-progress-bar"></div>
            </div>
            <div id="upload-percentage-text" class="upload-percentage-text">0%</div>
        </div>
    </div>
    <div id="media-viewer-modal">
        <button id="media-viewer-close-btn">&times;</button>
        <img id="media-viewer-image" src="" alt="MÍDIA" class="hidden" />
        <video id="media-viewer-video" src="" controls class="hidden"></video>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCeDWypTlIp0w8nebFFXEkmJWSpScBTHfI",
            authDomain: "seu-projeto.firebaseapp.com",
            databaseURL: "https://stevest-sr-default-rtdb.firebaseio.com",
            projectId: "seu-projeto",
            storageBucket: "stevest-sr.appspot.com",
            messagingSenderId: "seu-sender-id",
            appId: "1:227540325631:android:e8c018a5cbd147aaa728ca"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const mediaUploadInput = document.getElementById('media-upload');
        const mediaButton = document.getElementById('media-button');
        const newMessagesIndicator = document.getElementById('new-messages-indicator');
        
        const uploadModalOverlay = document.getElementById('upload-modal-overlay');
        const uploadPercentageText = document.getElementById('upload-percentage-text');
        const uploadProgressBar = document.getElementById('upload-progress-bar');
        
        const replyPreviewContainer = document.getElementById('reply-preview-container');
        const replyPreviewContent = document.getElementById('reply-preview-content');
        const replyCancelButton = document.getElementById('reply-cancel-button');
        let replyingToMessage = null;
        
        const DEFAULT_PROFILE_PIC = "https://firebasestorage.googleapis.com/v0/b/stevest-sr.appspot.com/o/CHAT-ONLINE-ST%2FInShot_20241224_213837756.jpg?alt=media&token=7d07c51a-70ba-4a86-a0aa-243f3d54ef49";
        const DEFAULT_PROFILE_COVER = "https://firebasestorage.googleapis.com/v0/b/stevest-sr.appspot.com/o/CHAT-ONLINE-ST%2Fdefault-cover.jpg?alt=media&token=7d07c51a-70ba-4a86-a0aa-243f3d54ef49";
        const STIA_NAME = 'STIA';
        const STIA_PROFILE_PIC = DEFAULT_PROFILE_PIC;
        const STIA_PROTECTED_OWNER = 'STEVEST';
        const STIA_DEFAULT_PRIVATE_PARTNER = 'STEVEST';
        const STIA_ADMIN_PUNISHMENT_PATTERN = /(BAN|MUT|SILEN|PUNI|DESBAN|DESMUT|ALERTA|AVIS|EXPUL)/i;
        const chaveDaApi = "AIzaSyA9GrY2SQeyy3Gw1ee1m0VdpKGUh68TRFM";
        const urlDaApi = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${chaveDaApi}`;

        const chatMessagesMap = new Map();
        const privateChatMessagesMap = new Map();

        const messagesRef = database.ref('messages');
        const usersProfileRef = database.ref('users/profile');
        const usersStatusRef = database.ref('users/status');
        const newsRef = database.ref('news');
        const privateMessagesRef = database.ref('private_messages');
        const stiaProcessedMessages = new Set();
        let stiaMonitoringEnabled = false;
        
        let currentUserNickname = localStorage.getItem('chat_nickname') || 'USUÁRIO ANÔNIMO';
        let currentUserPassword = localStorage.getItem('chat_password') || '';
        let currentUserProfilePic = DEFAULT_PROFILE_PIC;
        let currentUserProfileCover = DEFAULT_PROFILE_COVER;
        let isUserMuted = false;
        let currentUserIsAdmin = false;
        let currentUserAdminLevel = 0;
        let isPrivateMessagesLocked = true; // Por padrão, mensagens privadas são bloqueadas
        let currentUserIsPremium = false; // Status Premium do usuário atual
        let currentUserPremiumExpiry = null; // Data de expiração do Premium
        let rememberMeState = false; // Estado da caixa "Lembrar de mim"
        let stiaStevestProfilePhotoUnlocked = false;
        let stiaStevestProfileCoverUnlocked = false;
        let stiaOwnProfilePhotoUnlocked = false;
        let stiaOwnProfileCoverUnlocked = false;

        const userProfilesCache = {};
        let allUsersData = {};
        let onlineUsers = new Set();
        
        // Sistema de histórico de navegação
        let navigationHistory = ['main']; // Começa com o chat principal
        let currentScreen = 'main';
        
        const configButton = document.getElementById('config-button');
        const configMenu = document.getElementById('config-menu');
        
        const adminScreen = document.getElementById('admin-screen');
        const adminScreenButton = document.getElementById('admin-screen-button');
        const closeAdminScreenButton = document.getElementById('close-admin-screen');
        
        const usersScreen = document.getElementById('users-screen');
        const usersScreenButton = document.getElementById('users-screen-button');
        const closeUsersScreenButton = document.getElementById('close-users-screen');
        const usersGrid = document.getElementById('users-grid');
        
        const profileScreen = document.getElementById('profile-screen');
        const profileScreenButton = document.getElementById('profile-screen-button');
        const closeProfileScreenButton = document.getElementById('close-profile-screen');
        const profilePic = document.getElementById('profile-pic');
        const profileCover = document.getElementById('profile-cover');
        const profileUpload = document.getElementById('profile-upload');
        const profileCoverUpload = document.getElementById('profile-cover-upload');
        const profilePhotoButton = document.getElementById('profile-photo-button');
        const profileCoverPhotoButton = document.getElementById('profile-cover-photo-button');
        const stiaProfileEditorSection = document.getElementById('stia-profile-editor');
        const stiaProfilePicElement = document.getElementById('stia-profile-pic');
        const stiaProfileCoverElement = document.getElementById('stia-profile-cover');
        const stiaProfileUploadInput = document.getElementById('stia-profile-upload');
        const stiaProfileCoverUploadInput = document.getElementById('stia-profile-cover-upload');
        const stiaProfilePhotoButton = document.getElementById('stia-profile-photo-button');
        const stiaProfileCoverButton = document.getElementById('stia-profile-cover-button');
        const stiaProfileLockAlert = document.getElementById('stia-profile-lock-alert');
        const stiaProfileNameLabel = document.getElementById('stia-profile-name');
        const nicknameInput = document.getElementById('nickname');
        const passwordInput = document.getElementById('password');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const saveProfileBtn = document.getElementById('save-profile');
        const logoutButton = document.getElementById('logout-button');
        const displayNickname = document.getElementById('display-nickname');
        const togglePrivateMessagesBtn = document.getElementById('toggle-private-messages');
        
        // Botões para GIF
        const profileGifButton = document.getElementById('profile-gif-button');
        const profileCoverGifButton = document.getElementById('profile-cover-gif-button');
        
        const visitProfileScreen = document.getElementById('visit-profile-screen');
        const closeVisitProfileScreenButton = document.getElementById('close-visit-profile-screen');
        const visitProfilePic = document.getElementById('visit-profile-pic');
        const visitProfileCover = document.getElementById('visit-profile-cover');
        const visitProfileNickname = document.getElementById('visit-profile-nickname');
        const visitProfileStatus = document.getElementById('visit-profile-status');
        const visitProfileChatButton = document.getElementById('visit-profile-chat-button');
        const visitProfileBackButton = document.getElementById('visit-profile-back-button');
        let currentVisitProfileUser = null;

        function updateStevestProfileButtonState() {
            const isStevest = currentUserNickname === STIA_PROTECTED_OWNER;
            const lockPhoto = isStevest && !stiaStevestProfilePhotoUnlocked;
            const lockCover = isStevest && !stiaStevestProfileCoverUnlocked;

            if (profileUpload) {
                profileUpload.disabled = lockPhoto;
            }
            if (profilePhotoButton) {
                profilePhotoButton.disabled = lockPhoto;
            }
            if (profileCoverUpload) {
                profileCoverUpload.disabled = lockCover;
            }
            if (profileCoverPhotoButton) {
                profileCoverPhotoButton.disabled = lockCover;
            }
        }

        function updateStiaProfileButtonState() {
            if (!stiaProfileEditorSection) return;
            const isStevest = currentUserNickname === STIA_PROTECTED_OWNER;
            const photoLocked = !stiaOwnProfilePhotoUnlocked;
            const coverLocked = !stiaOwnProfileCoverUnlocked;
            const disablePhoto = !isStevest || photoLocked;
            const disableCover = !isStevest || coverLocked;

            if (stiaProfileUploadInput) {
                stiaProfileUploadInput.disabled = disablePhoto;
            }
            if (stiaProfilePhotoButton) {
                stiaProfilePhotoButton.disabled = disablePhoto;
            }
            if (stiaProfileCoverUploadInput) {
                stiaProfileCoverUploadInput.disabled = disableCover;
            }
            if (stiaProfileCoverButton) {
                stiaProfileCoverButton.disabled = disableCover;
            }

            if (stiaProfileLockAlert) {
                const showLocked = !isStevest || photoLocked || coverLocked;
                stiaProfileLockAlert.classList.toggle('locked', showLocked);
                stiaProfileLockAlert.classList.toggle('unlocked', isStevest && !photoLocked && !coverLocked);

                if (!isStevest) {
                    stiaProfileLockAlert.textContent = 'Faça login como STEVEST para alterar o visual da STIA.';
                } else if (photoLocked && coverLocked) {
                    stiaProfileLockAlert.textContent = 'Peça para a STIA liberar os botões antes de enviar novas imagens para o perfil dela.';
                } else if (!photoLocked && coverLocked) {
                    stiaProfileLockAlert.textContent = 'O botão da foto já está liberado. Falta a STIA liberar a capa.';
                } else if (photoLocked && !coverLocked) {
                    stiaProfileLockAlert.textContent = 'O botão da capa já está liberado. Falta a STIA liberar a foto.';
                } else {
                    stiaProfileLockAlert.textContent = 'Todos os botões estão liberados! Envie as novas imagens da STIA quando quiser.';
                }
            }
        }

        function updateStiaProfileEditorUI() {
            if (!stiaProfileEditorSection) return;
            const isStevest = currentUserNickname === STIA_PROTECTED_OWNER;
            if (!isStevest) {
                stiaProfileEditorSection.classList.add('hidden');
                updateStiaProfileButtonState();
                return;
            }

            stiaProfileEditorSection.classList.remove('hidden');
            const stiaProfileData = allUsersData[STIA_NAME] || {
                nickname: STIA_NAME,
                profilePicture: DEFAULT_PROFILE_PIC,
                profileCover: DEFAULT_PROFILE_COVER
            };

            if (stiaProfileNameLabel) {
                stiaProfileNameLabel.textContent = stiaProfileData.nickname || STIA_NAME;
            }

            if (stiaProfileCoverElement) {
                if (stiaProfileData.profileCover && stiaProfileData.profileCover !== DEFAULT_PROFILE_COVER) {
                    stiaProfileCoverElement.style.backgroundImage = `url(${stiaProfileData.profileCover})`;
                    stiaProfileCoverElement.style.backgroundSize = 'cover';
                    stiaProfileCoverElement.style.backgroundPosition = 'center';
                } else {
                    stiaProfileCoverElement.style.backgroundImage = '';
                    stiaProfileCoverElement.style.background = 'linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%)';
                }
            }

            if (stiaProfilePicElement) {
                if (stiaProfileData.profilePicture && stiaProfileData.profilePicture !== DEFAULT_PROFILE_PIC) {
                    stiaProfilePicElement.style.backgroundImage = `url(${stiaProfileData.profilePicture})`;
                    stiaProfilePicElement.style.backgroundSize = 'cover';
                    stiaProfilePicElement.style.backgroundPosition = 'center';
                    stiaProfilePicElement.textContent = '';
                } else {
                    stiaProfilePicElement.style.backgroundImage = '';
                    generateAvatarWithInitial(stiaProfileData.nickname || STIA_NAME, stiaProfilePicElement);
                }
            }

            updateStiaProfileButtonState();
        }

        function resetStevestProfileButtonUnlocks() {
            stiaStevestProfilePhotoUnlocked = false;
            stiaStevestProfileCoverUnlocked = false;
            stiaOwnProfilePhotoUnlocked = false;
            stiaOwnProfileCoverUnlocked = false;
            updateStevestProfileButtonState();
            updateStiaProfileButtonState();
        }
        
        const chatMain = document.getElementById('main-chat');
        
        // Elementos para seleção de usuários melhorada
        const deleteUserProfileInput = document.getElementById('delete-user-profile-input');
        const deleteUserProfileClear = document.getElementById('delete-user-profile-clear');
        const deleteUserProfileDropdown = document.getElementById('delete-user-profile-dropdown');
        const deleteUserProfileBtnAdmin = document.getElementById('delete-user-profile-btn-admin');
        
        const clearUserMessagesInput = document.getElementById('clear-user-messages-input');
        const clearUserMessagesClear = document.getElementById('clear-user-messages-clear');
        const clearUserMessagesDropdown = document.getElementById('clear-user-messages-dropdown');
        const clearUserMessagesBtnAdmin = document.getElementById('clear-user-messages-btn-admin');
        
        const banToggleUserInput = document.getElementById('ban-toggle-user-input');
        const banToggleUserClear = document.getElementById('ban-toggle-user-clear');
        const banToggleUserDropdown = document.getElementById('ban-toggle-user-dropdown');
        const banToggleButtonAdmin = document.getElementById('ban-toggle-btn-admin');
        
        const muteToggleUserInput = document.getElementById('mute-toggle-user-input');
        const muteToggleUserClear = document.getElementById('mute-toggle-user-clear');
        const muteToggleUserDropdown = document.getElementById('mute-toggle-user-dropdown');
        const muteToggleButtonAdmin = document.getElementById('mute-toggle-btn-admin');
        const muteDurationAdmin = document.getElementById('mute-duration-admin');
        
        const toggleAdminUserInput = document.getElementById('toggle-admin-user-input');
        const toggleAdminUserClear = document.getElementById('toggle-admin-user-clear');
        const toggleAdminUserDropdown = document.getElementById('toggle-admin-user-dropdown');
        const toggleAdminButtonAdmin = document.getElementById('toggle-admin-btn-admin');
        const adminLevelSelectAdmin = document.getElementById('admin-level-select-admin');
        
        const adminPrivateChatUserInput = document.getElementById('admin-private-chat-user-input');
        const adminPrivateChatUserClear = document.getElementById('admin-private-chat-user-clear');
        const adminPrivateChatUserDropdown = document.getElementById('admin-private-chat-user-dropdown');
        const adminPrivateChatBtn = document.getElementById('admin-private-chat-btn');
        
        const premiumUserInput = document.getElementById('premium-user-input');
        const premiumUserClear = document.getElementById('premium-user-clear');
        const premiumUserDropdown = document.getElementById('premium-user-dropdown');
        const premiumDurationAdmin = document.getElementById('premium-duration-admin');
        const grantPremiumBtnAdmin = document.getElementById('grant-premium-btn-admin');
        const revokePremiumBtnAdmin = document.getElementById('revoke-premium-btn-admin');
        const selfPremiumBtnAdmin = document.getElementById('self-premium-btn-admin');
        
        const clearAllMessagesBtnAdmin = document.getElementById('clear-all-messages-btn-admin');
        const viewNewsHistoryBtnAdmin = document.getElementById('view-news-history-btn-admin');
        
        const onlineUsersCount = document.getElementById('online-users-count');
        const bannedUsersCount = document.getElementById('banned-users-count');
        const mutedUsersCount = document.getElementById('muted-users-count');
        const adminUsersCount = document.getElementById('admin-users-count');
        
        const customModalOverlay = document.getElementById('custom-modal-overlay');
        const modalIcon = document.getElementById('modal-icon'); 
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');
        
        const mediaViewerModal = document.getElementById('media-viewer-modal');
        const mediaViewerCloseBtn = document.getElementById('media-viewer-close-btn');
        const mediaViewerImage = document.getElementById('media-viewer-image');
        const mediaViewerVideo = document.getElementById('media-viewer-video');
        
        const newsSystem = document.getElementById('news-system');
        const newsTicker = document.getElementById('news-ticker');
        
        const privateChat = document.getElementById('private-chat');
        const privateChatMessages = document.getElementById('private-chat-messages');
        const privateMessageInput = document.getElementById('private-message-input');
        const privateSendButton = document.getElementById('private-send-button');
        const privateMediaUploadInput = document.getElementById('private-media-upload');
        const privateMediaButton = document.getElementById('private-media-button');
        const privateChatTargetUserInfo = document.getElementById('private-chat-target-user-info');
        const closePrivateChatButton = document.getElementById('close-private-chat');
        const backToMainChatButton = document.getElementById('back-to-main-chat');
        const privateReplyPreviewContainer = document.getElementById('private-reply-preview-container');
        const privateReplyPreviewContent = document.getElementById('private-reply-preview-content');
        const privateReplyCancelButton = document.getElementById('private-reply-cancel-button');
        const privateNewMessagesIndicator = document.getElementById('private-new-messages-indicator');
        let privateReplyingToMessage = null;
        let currentPrivateChatUser = null;
        let isAdminAccessingPrivateChat = false; // Flag para indicar se um admin está acessando um chat privado
        
        const newsHistoryScreen = document.getElementById('news-history-screen');
        const newsHistoryScreenButton = document.getElementById('news-history-screen-button');
        const closeNewsHistoryScreenButton = document.getElementById('close-news-history-screen');
        const newsHistoryList = document.getElementById('news-history-list');
        
        // Elementos para navegação entre abas do painel de administração
        const adminNavItems = document.querySelectorAll('.admin-nav-item');
        const adminTabContents = {
            'danger': document.getElementById('danger-tab-content'),
            'rigorous': document.getElementById('rigorous-tab-content'),
            'light': document.getElementById('light-tab-content')
        };
        
        // Elementos para o modal de GIF
        const gifModalOverlay = document.getElementById('gif-modal-overlay');
        const gifModalClose = document.getElementById('gif-modal-close');
        const gifSearchInput = document.getElementById('gif-search-input');
        const gifSearchButton = document.getElementById('gif-search-button');
        const gifCategories = document.querySelectorAll('.gif-category');
        const gifGrid = document.getElementById('gif-grid');
        const gifPrevPage = document.getElementById('gif-prev-page');
        const gifNextPage = document.getElementById('gif-next-page');
        const gifPageInfo = document.getElementById('gif-page-info');
        
        // Elementos para upload de GIF do dispositivo
        const gifUploadInput = document.getElementById('gif-upload-input');
        const gifPreviewContainer = document.getElementById('gif-preview-container');
        const gifPreviewImage = document.getElementById('gif-preview-image');
        const gifPreviewUse = document.getElementById('gif-preview-use');
        const gifPreviewCancel = document.getElementById('gif-preview-cancel');
        
        // Variáveis para controle do GIF
        let currentGifPage = 0;
        let currentGifCategory = 'trending';
        let currentGifSearch = '';
        let gifTarget = null; // 'avatar' ou 'cover'
        let gifsData = [];
        let uploadedGifData = null; // Armazena o GIF carregado do dispositivo
        
        let mainChatUserAtBottom = true;
        let privateChatUserAtBottom = true;
        let mainChatUnreadCount = 0;
        let privateChatUnreadCount = 0;
        
        // Sistema de detecção de status online/offline
        let userStatusRef = null;
        let lastOnlineRef = null;
        let connectedRef = null;
        
        // Configuração da API do Giphy
        const GIPHY_API_KEY = 'GlVGYHkr3WSBnllca54iNt0yFbjz7L65';
        const GIPHY_BASE_URL = 'https://api.giphy.com/v1/gifs';
        
        // Variáveis para controle dos seletores de usuários
        const userSelectors = {
            'delete-user-profile': {
                input: deleteUserProfileInput,
                clear: deleteUserProfileClear,
                dropdown: deleteUserProfileDropdown,
                button: deleteUserProfileBtnAdmin,
                selectedUser: null
            },
            'clear-user-messages': {
                input: clearUserMessagesInput,
                clear: clearUserMessagesClear,
                dropdown: clearUserMessagesDropdown,
                button: clearUserMessagesBtnAdmin,
                selectedUser: null
            },
            'ban-toggle-user': {
                input: banToggleUserInput,
                clear: banToggleUserClear,
                dropdown: banToggleUserDropdown,
                button: banToggleButtonAdmin,
                selectedUser: null
            },
            'mute-toggle-user': {
                input: muteToggleUserInput,
                clear: muteToggleUserClear,
                dropdown: muteToggleUserDropdown,
                button: muteToggleButtonAdmin,
                selectedUser: null
            },
            'toggle-admin-user': {
                input: toggleAdminUserInput,
                clear: toggleAdminUserClear,
                dropdown: toggleAdminUserDropdown,
                button: toggleAdminButtonAdmin,
                selectedUser: null
            },
            'admin-private-chat-user': {
                input: adminPrivateChatUserInput,
                clear: adminPrivateChatUserClear,
                dropdown: adminPrivateChatUserDropdown,
                button: adminPrivateChatBtn,
                selectedUser: null
            },
            'premium-user': {
                input: premiumUserInput,
                clear: premiumUserClear,
                dropdown: premiumUserDropdown,
                button: grantPremiumBtnAdmin,
                selectedUser: null
            }
        };
        
        // Funções para o modal de GIF
        function openGifModal(target) {
            // Verificar se o usuário é Premium
            if (!currentUserIsPremium && currentUserNickname !== 'USUÁRIO ANÔNIMO') {
                showAlertModal('RECURSO PREMIUM', 'APENAS USUÁRIOS PREMIUM PODEM USAR GIFS NO PERFIL. ADQUIRA O PREMIUM PARA DESBLOQUEAR ESTA FUNCIONALIDADE.', 'fas fa-star', 'warning');
                return;
            }
            
            gifTarget = target;
            gifModalOverlay.classList.add('show');
            loadGifs();
        }
        
        function closeGifModal() {
            gifModalOverlay.classList.remove('show');
            gifTarget = null;
            currentGifPage = 0;
            currentGifSearch = '';
            gifSearchInput.value = '';
            uploadedGifData = null;
            gifPreviewContainer.classList.remove('show');
        }
        
        function loadGifs() {
            gifGrid.innerHTML = '<div class="gif-loading"><div class="gif-loading-spinner"></div></div>';
            
            let url;
            if (currentGifSearch) {
                url = `${GIPHY_BASE_URL}/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(currentGifSearch)}&limit=20&offset=${currentGifPage * 20}`;
            } else {
                url = `${GIPHY_BASE_URL}/${currentGifCategory}?api_key=${GIPHY_API_KEY}&limit=20&offset=${currentGifPage * 20}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    gifsData = data.data;
                    renderGifs();
                    updatePagination();
                })
                .catch(error => {
                    console.error('Erro ao carregar GIFs:', error);
                    gifGrid.innerHTML = '<div class="gif-error">Ocorreu um erro ao carregar os GIFs. Tente novamente.</div>';
                });
        }
        
        function renderGifs() {
            if (gifsData.length === 0) {
                gifGrid.innerHTML = '<div class="gif-error">Nenhum GIF encontrado. Tente outra pesquisa.</div>';
                return;
            }
            
            gifGrid.innerHTML = '';
            gifsData.forEach(gif => {
                const gifItem = document.createElement('div');
                gifItem.className = 'gif-item';
                
                const img = document.createElement('img');
                img.src = gif.images.fixed_height.url;
                img.alt = gif.title;
                
                const overlay = document.createElement('div');
                overlay.className = 'gif-item-overlay';
                
                const selectButton = document.createElement('button');
                selectButton.className = 'gif-select-button';
                selectButton.textContent = 'SELECIONAR';
                selectButton.addEventListener('click', () => selectGif(gif));
                
                overlay.appendChild(selectButton);
                gifItem.appendChild(img);
                gifItem.appendChild(overlay);
                gifGrid.appendChild(gifItem);
            });
        }
        
        function updatePagination() {
            gifPageInfo.textContent = `Página ${currentGifPage + 1}`;
            gifPrevPage.disabled = currentGifPage === 0;
            gifNextPage.disabled = gifsData.length < 20;
        }
        
        function selectGif(gif) {
            if (gifTarget === 'avatar') {
                updateProfileWithGif(gif.images.fixed_height.url, 'avatar');
            } else if (gifTarget === 'cover') {
                updateProfileWithGif(gif.images.fixed_height.url, 'cover');
            }
            closeGifModal();
        }
        
        function updateProfileWithGif(gifUrl, type) {
            if (currentUserNickname === 'USUÁRIO ANÔNIMO') {
                showAlertModal('LOGIN NECESSÁRIO', 'VOCÊ PRECISA FAZER LOGIN PARA ATUALIZAR SEU PERFIL.', 'fas fa-user-circle', 'info');
                return;
            }
            
            showUploadProgressModal();
            uploadPercentageText.textContent = 'CARREGANDO GIF...';
            uploadProgressBar.style.width = '50%';
            
            // Simular upload do GIF
            setTimeout(() => {
                uploadPercentageText.textContent = '100%';
                uploadProgressBar.style.width = '100%';
                
                const updateData = {};
                if (type === 'avatar') {
                    updateData.profilePicture = gifUrl;
                    currentUserProfilePic = gifUrl;
                } else if (type === 'cover') {
                    updateData.profileCover = gifUrl;
                    currentUserProfileCover = gifUrl;
                }
                
                database.ref(`users/profile/${currentUserNickname}`).update(updateData)
                    .then(() => {
                        // Atualizar cache
                        userProfilesCache[currentUserNickname] = userProfilesCache[currentUserNickname] || {};
                        Object.assign(userProfilesCache[currentUserNickname], updateData);
                        
                        // Atualizar UI
                        updateProfileScreenUI();
                        updateUserAvatars(currentUserNickname, currentUserProfilePic);
                        
                        hideUploadProgressModal();
                        showAlertModal('SUCESSO!', `${type === 'avatar' ? 'FOTO DE PERFIL' : 'CAPA DE PERFIL'} ATUALIZADA COM GIF!`, 'fas fa-check-circle', 'success');
                    })
                    .catch(error => {
                        console.error(`Erro ao atualizar ${type === 'avatar' ? 'foto de perfil' : 'capa de perfil'}:`, error);
                        hideUploadProgressModal();
                        showAlertModal('ERRO', `ERRO AO ATUALIZAR ${type === 'avatar' ? 'FOTO DE PERFIL' : 'CAPA DE PERFIL'}. TENTE NOVAMENTE.`, 'fas fa-times-circle', 'error');
                    });
            }, 1000);
        }
        
        // Funções para upload de GIF do dispositivo
        function handleGifUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Verificar se o arquivo é um GIF
            if (!file.type.includes('gif')) {
                showAlertModal('FORMATO INVÁLIDO', 'POR FAVOR, SELECIONE UM ARQUIVO GIF.', 'fas fa-exclamation-triangle', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedGifData = e.target.result;
                gifPreviewImage.src = uploadedGifData;
                gifPreviewContainer.classList.add('show');
            };
            reader.readAsDataURL(file);
        }
        
        function useUploadedGif() {
            if (!uploadedGifData) return;
            
            if (gifTarget === 'avatar') {
                updateProfileWithGif(uploadedGifData, 'avatar');
            } else if (gifTarget === 'cover') {
                updateProfileWithGif(uploadedGifData, 'cover');
            }
            closeGifModal();
        }
        
        function cancelUploadedGif() {
            uploadedGifData = null;
            gifPreviewContainer.classList.remove('show');
            gifUploadInput.value = '';
        }
        
        // Event listeners para o modal de GIF
        gifModalClose.addEventListener('click', closeGifModal);
        gifSearchButton.addEventListener('click', () => {
            currentGifSearch = gifSearchInput.value.trim();
            currentGifPage = 0;
            loadGifs();
        });
        
        gifSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentGifSearch = gifSearchInput.value.trim();
                currentGifPage = 0;
                loadGifs();
            }
        });
        
        gifCategories.forEach(category => {
            category.addEventListener('click', () => {
                gifCategories.forEach(cat => cat.classList.remove('active'));
                category.classList.add('active');
                currentGifCategory = category.dataset.category;
                currentGifSearch = '';
                gifSearchInput.value = '';
                currentGifPage = 0;
                loadGifs();
            });
        });
        
        gifPrevPage.addEventListener('click', () => {
            if (currentGifPage > 0) {
                currentGifPage--;
                loadGifs();
            }
        });
        
        gifNextPage.addEventListener('click', () => {
            currentGifPage++;
            loadGifs();
        });
        
        // Event listeners para upload de GIF do dispositivo
        gifUploadInput.addEventListener('change', handleGifUpload);
        gifPreviewUse.addEventListener('click', useUploadedGif);
        gifPreviewCancel.addEventListener('click', cancelUploadedGif);
        
        // Event listeners para botões de GIF
        profileGifButton.addEventListener('click', () => openGifModal('avatar'));
        profileCoverGifButton.addEventListener('click', () => openGifModal('cover'));
        
        // Funções para gerenciamento Premium
        async function grantPremiumToUser(username, days) {
            if (!isAdminOrStevest()) {
                showAlertModal('PERMISSÃO NEGADA', 'APENAS ADMINISTRADORES PODEM CONCEDER PREMIUM.', 'fas fa-exclamation-triangle', 'error');
                return;
            }

            if (!username) {
                showAlertModal('SELECIONE UM USUÁRIO', 'POR FAVOR, SELECIONE UM USUÁRIO PARA CONCEDER PREMIUM.', 'fas fa-user-circle', 'info');
                return;
            }

            if (username === STIA_PROTECTED_OWNER && currentUserNickname !== STIA_PROTECTED_OWNER) {
                showAlertModal('AÇÃO BLOQUEADA', 'NENHUM ADMINISTRADOR PODE ALTERAR O PREMIUM DO STEVEST.', 'fas fa-ban', 'error');
                await stiaDemoteAdminForStevestAttempt(currentUserNickname, 'alterar o Premium');
                return;
            }

            if (!days || days < 1) {
                showAlertModal('DIAS INVÁLIDOS', 'POR FAVOR, INSIRA UM NÚMERO VÁLIDO DE DIAS.', 'fas fa-calendar-alt', 'warning');
                return;
            }
            
            const confirmed = await showConfirmModal(
                'CONCEDER PREMIUM',
                `TEM CERTEZA QUE DESEJA CONCEDER PREMIUM PARA ${username} POR ${days} DIAS?`,
                'fas fa-star', 'info'
            );
            
            if (confirmed) {
                try {
                    const now = Date.now();
                    const expiryDate = now + (days * 24 * 60 * 60 * 1000);
                    
                    await usersProfileRef.child(username).update({
                        isPremium: true,
                        premiumExpiry: expiryDate
                    });
                    
                    // Adicionar notícia sobre a concessão de Premium
                    addNewsItem(currentUserNickname, 'grant_premium', username, days);
                    
                    showAlertModal('SUCESSO!', `PREMIUM CONCEDIDO PARA ${username} POR ${days} DIAS!`, 'fas fa-check-circle', 'success');
                    
                    // Atualizar a lista de usuários se estiver visível
                    if (!usersScreen.classList.contains('hidden')) {
                        updateUsersDisplay();
                    }
                } catch (error) {
                    console.error('Erro ao conceder Premium:', error);
                    showAlertModal('ERRO', 'ERRO AO CONCEDER PREMIUM. TENTE NOVAMENTE.', 'fas fa-times-circle', 'error');
                }
            }
        }
        
        async function revokePremiumFromUser(username) {
            if (!isAdminOrStevest()) {
                showAlertModal('PERMISSÃO NEGADA', 'APENAS ADMINISTRADORES PODEM REVOGAR PREMIUM.', 'fas fa-exclamation-triangle', 'error');
                return;
            }

            if (!username) {
                showAlertModal('SELECIONE UM USUÁRIO', 'POR FAVOR, SELECIONE UM USUÁRIO PARA REVOGAR PREMIUM.', 'fas fa-user-circle', 'info');
                return;
            }

            if (username === STIA_PROTECTED_OWNER && currentUserNickname !== STIA_PROTECTED_OWNER) {
                showAlertModal('AÇÃO BLOQUEADA', 'NENHUM ADMINISTRADOR PODE REVOGAR O PREMIUM DO STEVEST.', 'fas fa-ban', 'error');
                await stiaDemoteAdminForStevestAttempt(currentUserNickname, 'revogar o Premium');
                return;
            }

            const confirmed = await showConfirmModal(
                'REVOGAR PREMIUM',
                `TEM CERTEZA QUE DESEJA REVOGAR O PREMIUM DE ${username}?`,
                'fas fa-star', 'warning'
            );
            
            if (confirmed) {
                try {
                    await usersProfileRef.child(username).update({
                        isPremium: false,
                        premiumExpiry: null
                    });
                    
                    // Adicionar notícia sobre a revogação de Premium
                    addNewsItem(currentUserNickname, 'revoke_premium', username);
                    
                    showAlertModal('SUCESSO!', `PREMIUM REVOGADO DE ${username}!`, 'fas fa-check-circle', 'success');
                    
                    // Atualizar a lista de usuários se estiver visível
                    if (!usersScreen.classList.contains('hidden')) {
                        updateUsersDisplay();
                    }
                } catch (error) {
                    console.error('Erro ao revogar Premium:', error);
                    showAlertModal('ERRO', 'ERRO AO REVOGAR PREMIUM. TENTE NOVAMENTE.', 'fas fa-times-circle', 'error');
                }
            }
        }
        
        async function activateSelfPremium() {
            if (!isAdminOrStevest()) {
                showAlertModal('PERMISSÃO NEGADA', 'APENAS ADMINISTRADORES PODEM ATIVAR PREMIUM ILIMITADO.', 'fas fa-exclamation-triangle', 'error');
                return;
            }
            
            const confirmed = await showConfirmModal(
                'ATIVAR PREMIUM ILIMITADO',
                'TEM CERTEZA QUE DESEJA ATIVAR PREMIUM ILIMITADO PARA SI MESMO? ESTE PREMIUM NÃO EXPIRARÁ ATÉ QUE VOCÊ O DESATIVE.',
                'fas fa-star', 'info'
            );
            
            if (confirmed) {
                try {
                    await usersProfileRef.child(currentUserNickname).update({
                        isPremium: true,
                        premiumExpiry: null  // null significa que não expira
                    });
                    
                    // Adicionar notícia sobre a ativação de Premium
                    addNewsItem(currentUserNickname, 'self_premium', currentUserNickname);
                    
                    showAlertModal('SUCESSO!', 'PREMIUM ILIMITADO ATIVADO COM SUCESSO!', 'fas fa-check-circle', 'success');
                    
                    // Atualizar o status Premium do usuário atual
                    currentUserIsPremium = true;
                    currentUserPremiumExpiry = null;
                    
                    // Atualizar a UI
                    updateProfileScreenUI();
                } catch (error) {
                    console.error('Erro ao ativar Premium ilimitado:', error);
                    showAlertModal('ERRO', 'ERRO AO ATIVAR PREMIUM ILIMITADO. TENTE NOVAMENTE.', 'fas fa-times-circle', 'error');
                }
            }
        }
        
        // Event listeners para gerenciamento Premium
        grantPremiumBtnAdmin.addEventListener('click', () => {
            const username = userSelectors['premium-user'].selectedUser;
            const days = parseInt(premiumDurationAdmin.value);
            grantPremiumToUser(username, days);
        });
        
        revokePremiumBtnAdmin.addEventListener('click', () => {
            const username = userSelectors['premium-user'].selectedUser;
            revokePremiumFromUser(username);
        });

        selfPremiumBtnAdmin.addEventListener('click', activateSelfPremium);

        // ======================== STIA - IA ADMINISTRADORA ========================
        function cleanStiaJsonText(text) {
            if (!text) return '';
            return text.replace(/```json|```/gi, '').trim();
        }

        function extractStiaJson(text) {
            if (!text) return null;
            const cleaned = cleanStiaJsonText(text);
            const match = cleaned.match(/\{[\s\S]*\}/);
            const jsonString = match ? match[0] : cleaned;
            try {
                return JSON.parse(jsonString);
            } catch (error) {
                console.warn('STIA: não foi possível interpretar o JSON retornado.', error, jsonString);
                return null;
            }
        }

        async function callStiaApi(prompt, temperature = 0.35) {
            if (!prompt) return '';
            try {
                const response = await fetch(urlDaApi, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            role: 'user',
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: temperature,
                            topK: 40,
                            topP: 0.95
                        }
                    })
                });

                if (!response.ok) {
                    console.error('STIA: erro ao chamar a API', await response.text());
                    return '';
                }

                const data = await response.json();
                const parts = data.candidates?.[0]?.content?.parts || [];
                return parts.map(part => part.text || '').join('\n').trim();
            } catch (error) {
                console.error('STIA: erro inesperado ao falar com a IA', error);
                return '';
            }
        }

        async function stiaSendMessage(text, options = {}) {
            if (!text) return;
            const payload = {
                text,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                senderNickname: STIA_NAME,
                senderProfilePic: STIA_PROFILE_PIC,
                isSystemMessage: true
            };

            if (options.replyTo) {
                payload.replyTo = options.replyTo;
            }

            try {
                await messagesRef.push(payload);
            } catch (error) {
                console.error('STIA: erro ao enviar mensagem do sistema.', error);
            }
        }

        async function stiaSendPrivateMessage(targetNickname, text, options = {}) {
            if (!targetNickname || !text) return;
            const payload = {
                text,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                senderNickname: STIA_NAME,
                senderProfilePic: STIA_PROFILE_PIC,
                receiverNickname: targetNickname,
                isSystemMessage: true
            };

            if (options.replyTo) {
                payload.replyTo = options.replyTo;
            }

            try {
                const chatKey = getPrivateChatKey(STIA_NAME, targetNickname);
                await privateMessagesRef.child(chatKey).push(payload);
            } catch (error) {
                console.error('STIA: erro ao responder no privado.', error);
            }
        }

        async function stiaDemoteAdminForStevestAttempt(adminNickname, attemptedAction) {
            if (!adminNickname || adminNickname === STIA_PROTECTED_OWNER || adminNickname === STIA_NAME) return;
            const adminData = allUsersData[adminNickname];
            let currentLevel = adminData && typeof adminData.adminLevel === 'number'
                ? adminData.adminLevel
                : parseInt(adminData?.adminLevel || '0', 10) || (adminData?.isAdmin ? 1 : 0);
            if (!currentLevel || currentLevel <= 0) {
                try {
                    const snapshot = await usersProfileRef.child(adminNickname).once('value');
                    const data = snapshot.val();
                    currentLevel = parseInt(data?.adminLevel || '0', 10) || (data?.isAdmin ? 1 : 0);
                } catch (error) {
                    console.error('STIA: não foi possível verificar o nível do admin.', error);
                    return;
                }
            }
            if (!currentLevel || currentLevel <= 0) return;
            const nextLevel = Math.max(0, currentLevel - 1);
            const updates = { adminLevel: nextLevel };
            if (nextLevel === 0) {
                updates.isAdmin = false;
            }
            try {
                await usersProfileRef.child(adminNickname).update(updates);
                if (allUsersData[adminNickname]) {
                    allUsersData[adminNickname].adminLevel = nextLevel;
                    if (nextLevel === 0) {
                        allUsersData[adminNickname].isAdmin = false;
                    }
                }
                await addNewsItem(STIA_NAME, 'demote_admin', adminNickname, null, nextLevel);
                const levelText = nextLevel > 0 ? `nível ${nextLevel}` : 'sem cargo de admin';
                await stiaSendMessage(`⚡ ${adminNickname} foi rebaixado por tentar ${attemptedAction} o ${STIA_PROTECTED_OWNER}. Agora está em ${levelText}.`);
            } catch (error) {
                console.error('STIA: erro ao rebaixar admin abusivo.', error);
            }
        }

        async function stiaUnlockProfileButtons(targetNickname = STIA_PROTECTED_OWNER, uploadType = 'ambos', confirmationMessage = '') {
            let normalizedTarget = (targetNickname || '').trim().toUpperCase();
            const normalizedTypeRaw = (uploadType || 'ambos').toLowerCase();

            if (!normalizedTarget) {
                normalizedTarget = STIA_PROTECTED_OWNER;
            }
            if (normalizedTarget === '@STIA' || normalizedTarget === 'IA') {
                normalizedTarget = STIA_NAME;
            }
            if (normalizedTypeRaw.includes('stia')) {
                normalizedTarget = STIA_NAME;
            }

            let shouldUnlockPhoto = /(perfil|avatar|foto)/.test(normalizedTypeRaw);
            let shouldUnlockCover = /(capa|cover)/.test(normalizedTypeRaw);
            const wantsBoth = normalizedTypeRaw === 'ambos' || normalizedTypeRaw === 'todos' || normalizedTypeRaw === 'all' || normalizedTypeRaw === 'both' || normalizedTypeRaw === '' || normalizedTypeRaw === 'perfil_capa';
            if (wantsBoth) {
                shouldUnlockPhoto = true;
                shouldUnlockCover = true;
            }
            if (!shouldUnlockPhoto && !shouldUnlockCover) {
                shouldUnlockPhoto = true;
                shouldUnlockCover = true;
            }

            const unlockingStiaProfile = normalizedTarget === STIA_NAME;

            if (unlockingStiaProfile) {
                if (shouldUnlockPhoto) {
                    stiaOwnProfilePhotoUnlocked = true;
                }
                if (shouldUnlockCover) {
                    stiaOwnProfileCoverUnlocked = true;
                }
                if (!shouldUnlockPhoto && !shouldUnlockCover) {
                    stiaOwnProfilePhotoUnlocked = true;
                    stiaOwnProfileCoverUnlocked = true;
                }
                updateStiaProfileButtonState();
            } else {
                if (shouldUnlockPhoto) {
                    stiaStevestProfilePhotoUnlocked = true;
                }
                if (shouldUnlockCover) {
                    stiaStevestProfileCoverUnlocked = true;
                }
                if (!shouldUnlockPhoto && !shouldUnlockCover) {
                    stiaStevestProfilePhotoUnlocked = true;
                    stiaStevestProfileCoverUnlocked = true;
                }
                updateStevestProfileButtonState();
            }

            const photoEnabled = unlockingStiaProfile ? stiaOwnProfilePhotoUnlocked : stiaStevestProfilePhotoUnlocked;
            const coverEnabled = unlockingStiaProfile ? stiaOwnProfileCoverUnlocked : stiaStevestProfileCoverUnlocked;

            let unlockedLabel = 'os botões de foto e capa';
            if (photoEnabled && !coverEnabled) {
                unlockedLabel = 'apenas o botão de foto';
            } else if (!photoEnabled && coverEnabled) {
                unlockedLabel = 'apenas o botão da capa';
            }

            const targetLabel = unlockingStiaProfile ? 'para o perfil da STIA' : `para o ${STIA_PROTECTED_OWNER}`;
            const finalMessage = confirmationMessage || `${unlockingStiaProfile ? '🤖' : '🖼️'} STIA liberou ${unlockedLabel} ${targetLabel}.`;
            if (finalMessage) {
                await stiaSendMessage(finalMessage);
            }
        }

        async function stiaClearUserMessages(nickname, options = {}) {
            if (!nickname || nickname === STIA_NAME) return;
            const { notify = true } = options;
            try {
                const snapshot = await messagesRef.orderByChild('senderNickname').equalTo(nickname).once('value');
                if (!snapshot.exists()) {
                    if (notify) {
                        await stiaSendMessage(`ℹ️ Nenhuma mensagem recente de ${nickname} foi encontrada para limpeza.`);
                    }
                    return;
                }

                const updates = {};
                const mediaToDelete = [];
                snapshot.forEach(childSnapshot => {
                    updates[childSnapshot.key] = null;
                    const messageData = childSnapshot.val();
                    if (messageData.mediaUrl) {
                        mediaToDelete.push(messageData.mediaUrl);
                    }
                });

                await messagesRef.update(updates);

                for (const url of mediaToDelete) {
                    try {
                        const fileRef = storage.refFromURL(url);
                        await fileRef.delete();
                    } catch (mediaError) {
                        console.error(`STIA: erro ao excluir mídia do usuário ${nickname}:`, mediaError);
                    }
                }

                if (notify) {
                    await addNewsItem(STIA_NAME, 'clear_messages', nickname);
                    await stiaSendMessage(`🧹 Todas as mensagens de ${nickname} foram removidas pelo sistema.`);
                }
            } catch (error) {
                console.error('STIA: erro ao limpar mensagens automaticamente.', error);
            }
        }

        async function stiaDeleteUserProfile(nickname, reason = '') {
            if (!nickname || nickname === STIA_NAME || nickname === STIA_PROTECTED_OWNER) return;
            try {
                await usersProfileRef.child(nickname).remove();
                await stiaClearUserMessages(nickname, { notify: false });
                await addNewsItem(STIA_NAME, 'delete_profile', nickname);
                const message = reason ? `${reason}` : 'conduta incompatível com o chat.';
                await stiaSendMessage(`❌ O perfil de ${nickname} foi deletado pela STIA (${message}).`);
            } catch (error) {
                console.error('STIA: erro ao deletar perfil automaticamente.', error);
            }
        }

        async function stiaUpdateAdminLevel(nickname, newAdminLevel, reason = '') {
            if (!nickname || nickname === STIA_NAME || nickname === STIA_PROTECTED_OWNER) return;
            const sanitizedLevel = Math.max(0, Math.min(5, parseInt(newAdminLevel, 10) || 0));
            try {
                await usersProfileRef.child(nickname).update({
                    adminLevel: sanitizedLevel,
                    isAdmin: sanitizedLevel > 0
                });
                await addNewsItem(STIA_NAME, sanitizedLevel > 0 ? 'promote_admin' : 'demote_admin', nickname, null, sanitizedLevel);
                const statusText = sanitizedLevel > 0 ? `agora é admin nível ${sanitizedLevel}` : 'foi removido da administração';
                const extra = reason ? ` Motivo: ${reason}` : '';
                await stiaSendMessage(`👑 ${nickname} ${statusText}.${extra}`);
            } catch (error) {
                console.error('STIA: erro ao gerenciar administradores.', error);
            }
        }

        async function stiaGrantPremium(nickname, days, reason = '', isUnlimited = false) {
            if (!nickname || nickname === STIA_NAME) return;
            try {
                const durationDays = isUnlimited ? 'ILIMITADO' : Math.max(1, parseInt(days, 10) || 30);
                const now = Date.now();
                const expiryDate = isUnlimited ? null : now + (parseInt(durationDays, 10) * 24 * 60 * 60 * 1000);
                await usersProfileRef.child(nickname).update({
                    isPremium: true,
                    premiumExpiry: expiryDate
                });
                await addNewsItem(STIA_NAME, 'grant_premium', nickname, durationDays);
                const extra = reason ? ` ${reason}` : '';
                await stiaSendMessage(`⭐ ${nickname} recebeu Premium ${isUnlimited ? 'ilimitado' : `por ${durationDays} dias`}.${extra}`);
            } catch (error) {
                console.error('STIA: erro ao conceder Premium automaticamente.', error);
            }
        }

        async function stiaRevokePremium(nickname, reason = '') {
            if (!nickname || nickname === STIA_NAME) return;
            try {
                await usersProfileRef.child(nickname).update({
                    isPremium: false,
                    premiumExpiry: null
                });
                await addNewsItem(STIA_NAME, 'revoke_premium', nickname);
                const extra = reason ? ` Motivo: ${reason}` : '';
                await stiaSendMessage(`💔 O Premium de ${nickname} foi revogado.${extra}`);
            } catch (error) {
                console.error('STIA: erro ao revogar Premium automaticamente.', error);
            }
        }

        async function stiaAccessPrivateChat(targetNickname, partnerNickname) {
            if (!targetNickname) return;
            const participantA = targetNickname;
            const participantB = partnerNickname && partnerNickname !== participantA ? partnerNickname : STIA_DEFAULT_PRIVATE_PARTNER;
            if (participantA === participantB) return;
            try {
                const chatKey = getPrivateChatKey(participantA, participantB);
                const snapshot = await privateMessagesRef.child(chatKey).limitToLast(8).once('value');
                const excerpts = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    if (!data) return;
                    let content = data.text || '';
                    if (!content && data.mediaUrl) {
                        content = '[MÍDIA]';
                    }
                    if (!content) {
                        content = '[MENSAGEM]';
                    }
                    excerpts.push(`${data.senderNickname}: ${content}`);
                });

                if (excerpts.length === 0) {
                    await stiaSendMessage(`🔍 STIA auditou o chat privado entre ${participantA} e ${participantB}, sem mensagens recentes.`);
                    return;
                }

                const summary = excerpts.join(' | ');
                const trimmedSummary = summary.length > 400 ? `${summary.slice(0, 400)}...` : summary;
                await stiaSendMessage(`🔍 STIA auditou o chat privado entre ${participantA} e ${participantB}: ${trimmedSummary}`);
            } catch (error) {
                console.error('STIA: erro ao acessar chat privado.', error);
            }
        }

        async function stiaRemoveMessage(messageKey) {
            if (!messageKey) return;
            try {
                await messagesRef.child(messageKey).remove();
            } catch (error) {
                console.warn('STIA: não foi possível remover a mensagem.', error);
            }
        }

        async function stiaWarnUser(nickname, reason, messageKey, removeMessage = false) {
            if (!nickname) return;
            if (removeMessage) {
                await stiaRemoveMessage(messageKey);
            }
            await stiaSendMessage(`⚠️ ${nickname}, ${reason || 'por favor, siga as regras do chat.'}`, { replyTo: messageKey });
        }

        async function stiaMuteUser(nickname, minutes, reason, messageKey) {
            if (!nickname || nickname === STIA_NAME) return;
            const duration = Math.max(parseInt(minutes, 10) || 15, 5);
            const mutedUntil = Date.now() + duration * 60 * 1000;
            try {
                await usersProfileRef.child(nickname).update({
                    mutedUntil,
                    mutedBy: STIA_NAME,
                    mutedReason: reason || 'Conduta inadequada no chat.',
                    isMutedByStevest: false
                });
                await stiaRemoveMessage(messageKey);
                await stiaSendMessage(`🔇 ${nickname} foi silenciado por ${duration} minutos. Motivo: ${reason || 'Violação das regras.'}`);
            } catch (error) {
                console.error('STIA: erro ao silenciar usuário.', error);
            }
        }

        async function stiaUnmuteUser(nickname, confirmationMessage = '') {
            if (!nickname) return;
            try {
                await usersProfileRef.child(nickname).update({
                    mutedUntil: 0,
                    mutedBy: null,
                    mutedReason: null,
                    isMutedByStevest: false
                });
                await stiaSendMessage(confirmationMessage || `✅ ${nickname} foi dessilenciado conforme solicitado pelo STEVEST.`);
            } catch (error) {
                console.error('STIA: erro ao dessilenciar usuário.', error);
            }
        }

        async function stiaBanUser(nickname, reason, messageKey) {
            if (!nickname || nickname === STIA_NAME) return;
            try {
                await usersProfileRef.child(nickname).update({
                    isBanned: true,
                    bannedReason: reason || 'Descumprimento das regras.',
                    bannedBy: STIA_NAME,
                    isBannedByStevest: false
                });
                await stiaRemoveMessage(messageKey);
                await stiaSendMessage(`⛔ ${nickname} foi banido automaticamente. Motivo: ${reason || 'Infração grave às regras.'}`);
            } catch (error) {
                console.error('STIA: erro ao banir usuário.', error);
            }
        }

        async function stiaUnbanUser(nickname, confirmationMessage = '') {
            if (!nickname) return;
            try {
                await usersProfileRef.child(nickname).update({
                    isBanned: false,
                    bannedReason: null,
                    bannedBy: null,
                    isBannedByStevest: false
                });
                await stiaSendMessage(confirmationMessage || `✅ ${nickname} foi desbanido conforme instrução do STEVEST.`);
            } catch (error) {
                console.error('STIA: erro ao desbanir usuário.', error);
            }
        }

        function stiaNormalizeAction(action) {
            if (!action) return '';
            const normalized = action.toLowerCase();
            if (normalized === 'banir' || normalized === 'ban') return 'ban';
            if (normalized === 'mutar' || normalized === 'mute') return 'mute';
            if (normalized === 'alerta' || normalized === 'avisar' || normalized === 'warn') return 'warn';
            if (normalized === 'remover' || normalized === 'apagar') return 'remove';
            if (normalized === 'desbanir' || normalized === 'unban') return 'unban';
            if (normalized === 'desmutar' || normalized === 'unmute') return 'unmute';
            if (normalized === 'ignorar' || normalized === 'ignore') return 'ignore';
            return normalized;
        }

        async function stiaHandleStevestCommand(commandText) {
            const prompt = `Você é STIA, a administradora do chat. Interprete o pedido do STEVEST a seguir e responda SOMENTE em JSON com o formato {"acao":"mensagem|alerta|mutar|banir|desbanir|desmutar|deletar_perfil|limpar_mensagens|gerenciar_admin|premium|acesso_privado|liberar_upload|ignorar","alvo":"NOME OU VAZIO","duracaoMinutos":0,"mensagem":"texto para enviar ao chat","nivelAdmin":0,"premiumDias":0,"tipoPremium":"conceder|revogar|ilimitado","chatParceiro":"SEGUNDO USUÁRIO OU VAZIO","tipoUpload":"perfil|capa|ambos"}. Quando a ação for liberar_upload, use o campo alvo para dizer se a liberação é para o STEVEST ou para a própria STIA. Pedido: "${commandText}"`;
            const response = await callStiaApi(prompt);
            const parsed = extractStiaJson(response);
            if (!parsed) return false;

            const actionRaw = (parsed.acao || '').toLowerCase();
            const action = stiaNormalizeAction(actionRaw);
            const target = parsed.alvo ? parsed.alvo.trim() : '';
            const duration = parsed.duracaoMinutos || 0;
            const message = parsed.mensagem || '';
            const nivelAdmin = parsed.nivelAdmin ?? parsed.nivel ?? 0;
            const premiumDias = parsed.premiumDias ?? parsed.diasPremium ?? 0;
            const tipoPremium = (parsed.tipoPremium || parsed.acaoPremium || '').toLowerCase();
            const chatPartner = parsed.chatParceiro || parsed.parceiro || parsed.segundoAlvo || '';
            const uploadType = (parsed.tipoUpload || parsed.uploadTipo || parsed.botao || '').toLowerCase();

            switch (actionRaw) {
                case 'mensagem':
                case 'alerta':
                case 'warn':
                    await stiaSendMessage(message || `Solicitação concluída, ${target || 'pessoal'}.`);
                    return true;
                case 'mutar':
                case 'mute':
                    if (target) {
                        await stiaMuteUser(target, duration || 30, message || 'Solicitação direta do STEVEST.');
                        return true;
                    }
                    break;
                case 'banir':
                case 'ban':
                    if (target) {
                        await stiaBanUser(target, message || 'Solicitação direta do STEVEST.');
                        return true;
                    }
                    break;
                case 'desbanir':
                    if (target) {
                        await stiaUnbanUser(target);
                        return true;
                    }
                    break;
                case 'desmutar':
                    if (target) {
                        await stiaUnmuteUser(target);
                        return true;
                    }
                    break;
                case 'deletar_perfil':
                case 'delete_profile':
                    if (target) {
                        await stiaDeleteUserProfile(target, message || 'Solicitação direta do STEVEST.');
                        return true;
                    }
                    break;
                case 'limpar_mensagens':
                case 'limpar':
                case 'clear_messages':
                    if (target) {
                        await stiaClearUserMessages(target);
                        if (message) {
                            await stiaSendMessage(message);
                        }
                        return true;
                    }
                    break;
                case 'gerenciar_admin':
                case 'admin':
                    if (target) {
                        await stiaUpdateAdminLevel(target, nivelAdmin, message);
                        return true;
                    }
                    break;
                case 'premium':
                case 'gerenciar_premium':
                    if (target) {
                        if (tipoPremium === 'revogar') {
                            await stiaRevokePremium(target, message);
                        } else {
                            const isUnlimited = tipoPremium === 'ilimitado';
                            await stiaGrantPremium(target, premiumDias || 30, message, isUnlimited);
                        }
                        return true;
                    }
                    break;
                case 'acesso_privado':
                case 'acessar_privado':
                    if (target) {
                        await stiaAccessPrivateChat(target, chatPartner);
                        if (message) {
                            await stiaSendMessage(message);
                        }
                        return true;
                    }
                    break;
                case 'liberar_upload':
                    await stiaUnlockProfileButtons(target || STIA_PROTECTED_OWNER, uploadType || 'ambos', message);
                    return true;
                case 'ignorar':
                    return true;
                default:
                    break;
            }

            return false;
        }

        async function stiaHandleAdminPunishmentCommand(commandText, adminNickname, adminLevel) {
            if (!commandText || !adminNickname || adminLevel <= 0) return false;
            const prompt = `Você é STIA, a administradora do chat. Interprete o pedido do administrador ${adminNickname} (nível ${adminLevel}) e responda SOMENTE em JSON com o formato {"acao":"alerta|mutar|banir|desmutar|desbanir|ignorar","alvo":"NOME OU VAZIO","duracaoMinutos":0,"mensagem":"motivo para o chat"}. Pedido: "${commandText}"`;
            const response = await callStiaApi(prompt);
            const parsed = extractStiaJson(response);
            if (!parsed) return false;

            const action = stiaNormalizeAction(parsed.acao || parsed.acaoSugerida || 'ignorar');
            const target = parsed.alvo ? parsed.alvo.trim() : '';
            const duration = parsed.duracaoMinutos || parsed.duracao || 15;
            const message = parsed.mensagem || parsed.motivo || '';

            if (!action || !target) return false;

            const normalizedTarget = target.toUpperCase();

            if (normalizedTarget === STIA_PROTECTED_OWNER) {
                await stiaDemoteAdminForStevestAttempt(adminNickname, 'punir');
                await stiaSendMessage(`⚠️ ${adminNickname}, o ${STIA_PROTECTED_OWNER} é intocável. Sua tentativa foi registrada.`);
                return true;
            }

            switch (action) {
                case 'warn':
                    await stiaWarnUser(target, message || `Recomendação do admin ${adminNickname}.`);
                    return true;
                case 'mute':
                    await stiaMuteUser(target, duration || 15, message || `Silenciado a pedido do admin ${adminNickname}.`);
                    return true;
                case 'ban':
                    await stiaBanUser(target, message || `Banimento solicitado por ${adminNickname}.`);
                    return true;
                case 'unmute':
                    await stiaUnmuteUser(target, message || `✅ ${target} foi dessilenciado a pedido do admin ${adminNickname}.`);
                    return true;
                case 'unban':
                    await stiaUnbanUser(target, message || `✅ ${target} foi desbanido a pedido do admin ${adminNickname}.`);
                    return true;
                case 'ignore':
                    return true;
                default:
                    return false;
            }
        }

        async function stiaRespondToQuestion(questionText, nickname, replyKey) {
            const prompt = `Você é STIA, assistente oficial do chat. Responda em até 3 frases e em português para a pergunta: "${questionText}".`;
            const response = await callStiaApi(prompt, 0.65);
            if (response) {
                await stiaSendMessage(`@${nickname} ${response}`, { replyTo: replyKey });
            }
        }

        async function stiaChatPrivatelyWithUser(nickname, userMessage, replyKey) {
            if (!nickname) return;
            const content = (userMessage || '').trim() || 'mensagem vazia';
            const truncatedContent = content.length > 400 ? `${content.slice(0, 400)}...` : content;
            const prompt = `Você é STIA, assistente oficial do chat, conversando no privado com ${nickname}. O usuário enviou: "${truncatedContent}". Responda em português, com até 3 frases e mantendo um tom cordial.`;
            const response = await callStiaApi(prompt, 0.7);
            if (response) {
                await stiaSendPrivateMessage(nickname, response, { replyTo: replyKey });
            }
        }

        async function stiaModerateMessage(messageText, senderNickname, messageKey) {
            if (!messageText || !senderNickname) return;
            if (senderNickname === STIA_NAME) return;

            const prompt = `Você é STIA, guardiã das regras do chat. Analise a mensagem a seguir e responda em JSON no formato {"gravidade":"nenhuma|leve|moderada|grave","motivo":"texto","acaoSugerida":"ignorar|alerta|mutar|banir","duracaoMinutos":0,"removerMensagem":true|false}. Mensagem: "${messageText}".`;
            const response = await callStiaApi(prompt, 0.25);
            const parsed = extractStiaJson(response);
            if (!parsed) return;

            const severity = (parsed.gravidade || 'nenhuma').toLowerCase();
            const action = stiaNormalizeAction(parsed.acaoSugerida || 'ignorar');
            const reason = parsed.motivo || 'Conduta inadequada.';
            const duration = parsed.duracaoMinutos || 15;
            const shouldRemove = parsed.removerMensagem || false;

            if (severity === 'nenhuma' || action === 'ignore') return;

            if (action === 'warn') {
                await stiaWarnUser(senderNickname, reason, messageKey, shouldRemove);
                return;
            }

            if (action === 'mute') {
                await stiaMuteUser(senderNickname, duration, reason, messageKey);
                return;
            }

            if (action === 'ban' || severity === 'grave') {
                await stiaBanUser(senderNickname, reason, messageKey);
                return;
            }

            if (shouldRemove) {
                await stiaRemoveMessage(messageKey);
            }
        }

        async function stiaHandlePrivateUserMessage(messageData, messageKey) {
            if (!messageData) return;
            const sender = messageData.senderNickname || '';
            const receiver = messageData.receiverNickname || '';
            if (!sender || receiver !== STIA_NAME || sender === STIA_NAME) return;

            const messageText = (messageData.text || '').trim();
            const adminLevel = getUserAdminLevel(sender);
            const fallbackContent = messageText || (messageData.mediaType ? `[${(messageData.mediaType || '').toUpperCase()}]` : 'mensagem vazia');

            try {
                if (sender === STIA_PROTECTED_OWNER && messageText) {
                    const handled = await stiaHandleStevestCommand(messageText);
                    if (handled) {
                        await stiaSendPrivateMessage(sender, '✅ Pedido processado no privado.', { replyTo: messageKey });
                        return;
                    }
                } else if (adminLevel > 0 && messageText && STIA_ADMIN_PUNISHMENT_PATTERN.test(messageText)) {
                    const handled = await stiaHandleAdminPunishmentCommand(messageText, sender, adminLevel);
                    if (handled) {
                        await stiaSendPrivateMessage(sender, '✅ Solicitação aplicada no privado.', { replyTo: messageKey });
                        return;
                    }
                }

                await stiaChatPrivatelyWithUser(sender, fallbackContent, messageKey);
            } catch (error) {
                console.error('STIA: erro ao responder mensagem privada.', error);
            }
        }

        function getUserAdminLevel(nickname) {
            if (!nickname) return 0;
            const userData = allUsersData[nickname];
            if (!userData) return 0;
            if (typeof userData.adminLevel === 'number') {
                return userData.adminLevel;
            }
            if (userData.adminLevel) {
                const parsedLevel = parseInt(userData.adminLevel, 10);
                return isNaN(parsedLevel) ? 0 : parsedLevel;
            }
            if (userData.isAdmin) {
                return 1;
            }
            return 0;
        }

        async function handleStiaBehaviors(messageData, messageKey) {
            if (!messageData || !messageKey || stiaProcessedMessages.has(messageKey)) return;
            stiaProcessedMessages.add(messageKey);

            const messageText = (messageData.text || '').trim();
            if (!messageText) return;

            const normalizedText = messageText.toUpperCase();
            const mentionsStia = normalizedText.includes(STIA_NAME);
            const senderNickname = messageData.senderNickname || '';
            const inlineAdminLevel = typeof messageData.senderAdminLevel === 'number' ? messageData.senderAdminLevel : 0;
            const senderAdminLevel = getUserAdminLevel(senderNickname) || inlineAdminLevel;

            if (senderNickname === STIA_PROTECTED_OWNER && mentionsStia) {
                const handled = await stiaHandleStevestCommand(messageText);
                if (handled) {
                    return;
                }
            } else if (mentionsStia && senderAdminLevel > 0 && STIA_ADMIN_PUNISHMENT_PATTERN.test(messageText)) {
                const handled = await stiaHandleAdminPunishmentCommand(messageText, senderNickname, senderAdminLevel);
                if (handled) {
                    return;
                }
            }

            if (mentionsStia && messageText.includes('?')) {
                await stiaRespondToQuestion(messageText, senderNickname || 'usuário', messageKey);
            }

            await stiaModerateMessage(messageText, senderNickname, messageKey);
        }
        
        // Funções para seleção de usuários melhorada
        function setupUserSelector(selectorId) {
            const selector = userSelectors[selectorId];
            
            // Event listener para o campo de entrada
            selector.input.addEventListener('input', () => {
                const searchTerm = selector.input.value.trim().toLowerCase();
                
                if (searchTerm === '') {
                    selector.clear.classList.remove('show');
                    selector.dropdown.classList.remove('show');
                    selector.selectedUser = null;
                    updateButtonState(selectorId);
                    return;
                }
                
                selector.clear.classList.add('show');
                
                // Filtrar usuários com base no termo de pesquisa
                const filteredUsers = Object.values(allUsersData).filter(user => 
                    user.nickname.toLowerCase().includes(searchTerm) && 
                    user.nickname !== 'STEVEST'
                );
                
                // Limpar dropdown
                selector.dropdown.innerHTML = '';
                
                if (filteredUsers.length === 0) {
                    const noResultsItem = document.createElement('div');
                    noResultsItem.className = 'user-selector-item';
                    noResultsItem.innerHTML = '<span>Nenhum usuário encontrado</span>';
                    selector.dropdown.appendChild(noResultsItem);
                } else {
                    // Adicionar usuários filtrados ao dropdown
                    filteredUsers.forEach(user => {
                        const item = createUserSelectorItem(user, selectorId);
                        selector.dropdown.appendChild(item);
                    });
                }
                
                // Mostrar dropdown
                selector.dropdown.classList.add('show');
            });
            
            // Event listener para o botão de limpar
            selector.clear.addEventListener('click', () => {
                selector.input.value = '';
                selector.clear.classList.remove('show');
                selector.dropdown.classList.remove('show');
                selector.selectedUser = null;
                updateButtonState(selectorId);
            });
            
            // Event listener para clicar fora do dropdown
            document.addEventListener('click', (e) => {
                if (!selector.input.contains(e.target) && 
                    !selector.dropdown.contains(e.target) && 
                    !selector.clear.contains(e.target)) {
                    selector.dropdown.classList.remove('show');
                }
            });
        }
        
        function createUserSelectorItem(user, selectorId) {
            const item = document.createElement('div');
            item.className = 'user-selector-item';
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = 'user-selector-avatar';
            
            if (user.profilePicture && user.profilePicture !== DEFAULT_PROFILE_PIC) {
                avatar.style.backgroundImage = `url(${user.profilePicture})`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
            } else {
                generateAvatarWithInitial(user.nickname, avatar);
            }
            
            // Informações do usuário
            const info = document.createElement('div');
            info.className = 'user-selector-info';
            
            const nickname = document.createElement('div');
            nickname.className = 'user-selector-nickname';
            nickname.textContent = user.nickname;
            
            // Adicionar status de administrador
            if (user.nickname === 'STEVEST' || user.adminLevel > 0) {
                const adminCrownHtml = getAdminCrown(user.nickname, user.adminLevel || 0);
                if (adminCrownHtml) {
                    nickname.insertAdjacentHTML("beforeend", adminCrownHtml);
                }
            }
            
            // Status badges
            const status = document.createElement('div');
            status.className = 'user-selector-status';
            
            if (user.isBanned) {
                const bannedBadge = document.createElement('span');
                bannedBadge.className = 'user-selector-badge banned';
                bannedBadge.textContent = 'BANIDO';
                status.appendChild(bannedBadge);
            }
            
            if (user.mutedUntil && user.mutedUntil > Date.now()) {
                const mutedBadge = document.createElement('span');
                mutedBadge.className = 'user-selector-badge muted';
                mutedBadge.textContent = 'SILENCIADO';
                status.appendChild(mutedBadge);
            }
            
            if (user.nickname === 'STEVEST' || user.adminLevel > 0) {
                const adminBadge = document.createElement('span');
                adminBadge.className = 'user-selector-badge admin';
                adminBadge.textContent = 'ADMIN';
                status.appendChild(adminBadge);
            }
            
            if (user.isPremium) {
                const premiumBadge = document.createElement('span');
                premiumBadge.className = 'user-selector-badge premium';
                premiumBadge.textContent = 'PREMIUM';
                status.appendChild(premiumBadge);
            }
            
            info.appendChild(nickname);
            info.appendChild(status);
            
            item.appendChild(avatar);
            item.appendChild(info);
            
            // Event listener para selecionar o usuário
            item.addEventListener('click', () => {
                selectUser(selectorId, user);
            });
            
            return item;
        }
        
        function selectUser(selectorId, user) {
            const selector = userSelectors[selectorId];
            
            // Atualizar o campo de entrada
            selector.input.value = user.nickname;
            selector.selectedUser = user.nickname;
            
            // Esconder o dropdown
            selector.dropdown.classList.remove('show');
            
            // Atualizar o estado do botão
            updateButtonState(selectorId);
        }
        
        function updateButtonState(selectorId) {
            const selector = userSelectors[selectorId];
            const selectedUser = selector.selectedUser;
            
            // MODIFICAÇÃO: Botões sempre ativos, independentemente da seleção de usuário
            if (!selectedUser) {
                if (selectorId === 'ban-toggle-user') {
                    selector.button.textContent = 'BANIR USUÁRIO';
                    selector.button.classList.remove('bg-green-500', 'bg-gray-400');
                    selector.button.classList.add('bg-red-500');
                    selector.button.disabled = false;
                } else if (selectorId === 'mute-toggle-user') {
                    selector.button.textContent = 'SILENCIAR USUÁRIO';
                    selector.button.classList.remove('bg-green-500', 'bg-gray-400');
                    selector.button.classList.add('bg-orange-500');
                    selector.button.disabled = false;
                } else if (selectorId === 'toggle-admin-user') {
                    selector.button.textContent = 'DEFINIR NÍVEL DE ADMIN';
                    selector.button.classList.remove('bg-purple-500', 'bg-gray-400');
                    selector.button.classList.add('bg-purple-500');
                    selector.button.disabled = false;
                } else if (selectorId === 'delete-user-profile') {
                    selector.button.textContent = 'DELETAR PERFIL';
                    selector.button.classList.remove('bg-gray-400');
                    selector.button.classList.add('bg-red-500');
                    selector.button.disabled = false;
                } else if (selectorId === 'clear-user-messages') {
                    selector.button.textContent = 'LIMPAR MENSAGENS';
                    selector.button.classList.remove('bg-gray-400');
                    selector.button.classList.add('bg-red-500');
                    selector.button.disabled = false;
                } else if (selectorId === 'premium-user') {
                    selector.button.textContent = 'GERENCIAR PREMIUM';
                    selector.button.classList.remove('bg-gray-400');
                    selector.button.classList.add('bg-yellow-500');
                    selector.button.disabled = false;
                } else {
                    selector.button.textContent = 'EXECUTAR AÇÃO';
                    selector.button.classList.remove('bg-gray-400');
                    selector.button.disabled = false;
                }
                return;
            }
            
            // Se um usuário foi selecionado, mostrar o texto apropriado
            selector.button.disabled = false;
            
            // Obter dados do usuário selecionado
            const userData = allUsersData[selectedUser];
            
            if (selectorId === 'ban-toggle-user') {
                if (userData.isBanned) {
                    selector.button.textContent = 'DESBANIR';
                    selector.button.classList.remove('bg-red-500', 'bg-gray-400');
                    selector.button.classList.add('bg-green-500');
                } else {
                    selector.button.textContent = 'BANIR';
                    selector.button.classList.remove('bg-green-500', 'bg-gray-400');
                    selector.button.classList.add('bg-red-500');
                }
            } else if (selectorId === 'mute-toggle-user') {
                if (userData.mutedUntil && userData.mutedUntil > Date.now()) {
                    selector.button.textContent = 'DESSILENCIAR';
                    selector.button.classList.remove('bg-orange-500', 'bg-gray-400');
                    selector.button.classList.add('bg-green-500');
                } else {
                    selector.button.textContent = 'SILENCIAR';
                    selector.button.classList.remove('bg-green-500', 'bg-gray-400');
                    selector.button.classList.add('bg-orange-500');
                }
            } else if (selectorId === 'toggle-admin-user') {
                const currentAdminLevel = userData.adminLevel || 0;
                if (currentAdminLevel > 0) {
                    const crownEmoji = currentAdminLevel === 5 ? '🔱' : currentAdminLevel === 4 ? '⚜️' : currentAdminLevel === 3 ? '🏆' : currentAdminLevel === 2 ? '🎖️' : '⭐';
                    selector.button.textContent = `ATUAL: NÍVEL ${currentAdminLevel} ${crownEmoji}`;
                    selector.button.classList.remove('bg-purple-500', 'bg-gray-400');
                    selector.button.classList.add('bg-gray-500');
                } else {
                    selector.button.textContent = 'DEFINIR NÍVEL';
                    selector.button.classList.remove('bg-gray-500', 'bg-gray-400');
                    selector.button.classList.add('bg-purple-500');
                }
            } else if (selectorId === 'premium-user') {
                if (userData.isPremium) {
                    selector.button.textContent = 'GERENCIAR PREMIUM';
                    selector.button.classList.remove('bg-yellow-500', 'bg-gray-400');
                    selector.button.classList.add('bg-yellow-500');
                } else {
                    selector.button.textContent = 'CONCEDER PREMIUM';
                    selector.button.classList.remove('bg-yellow-500', 'bg-gray-400');
                    selector.button.classList.add('bg-yellow-500');
                }
            } else {
                selector.button.textContent = 'EXECUTAR AÇÃO';
                selector.button.classList.remove('bg-gray-400');
                selector.button.disabled = false;
            }
        }
        
        // Configurar todos os seletores de usuário
        Object.keys(userSelectors).forEach(selectorId => {
            setupUserSelector(selectorId);
        });
        
        function setupUserPresence() {
            if (currentUserNickname === 'USUÁRIO ANÔNIMO') return;
            
            // Remover referências anteriores se existirem
            if (userStatusRef) userStatusRef.off();
            if (lastOnlineRef) lastOnlineRef.off();
            if (connectedRef) connectedRef.off();
            
            // Referência para o status de conexão do Firebase
            connectedRef = database.ref('.info/connected');
            
            // Referência para o status do usuário
            userStatusRef = usersStatusRef.child(currentUserNickname);
            
            // Referência para o último horário online
            lastOnlineRef = usersProfileRef.child(currentUserNickname + '/lastOnline');
            
            connectedRef.on('value', (snapshot) => {
                if (snapshot.val() === false) {
                    // Não estamos conectados ao servidor
                    return;
                }
                
                // Quando o usuário se conecta, definir status como online
                userStatusRef.onDisconnect().remove(); // Remover status quando desconectar
                
                // Atualizar status para online
                userStatusRef.set({
                    state: 'online',
                    last_changed: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Atualizar último horário online
                lastOnlineRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                lastOnlineRef.set(firebase.database.ServerValue.TIMESTAMP);
            });
            
            // Monitorar mudanças de status de outros usuários
            usersStatusRef.on('value', (snapshot) => {
                const statuses = snapshot.val() || {};
                onlineUsers.clear();
                
                // Atualizar lista de usuários online
                Object.keys(statuses).forEach(user => {
                    if (statuses[user].state === 'online') {
                        onlineUsers.add(user);
                    }
                });
                
                // Atualizar a interface com os novos status
                updateUserStatusIndicators();
                updateUsersDisplay();
                updateAdminStats();
            });
        }
        
        function updateUserStatusIndicators() {
            // Atualizar indicadores de status nas mensagens do chat principal
            chatMessagesMap.forEach((messageElement, messageKey) => {
                const senderNickname = messageElement.dataset.senderNickname;
                const avatar = messageElement.querySelector('.user-avatar');
                
                if (avatar) {
                    if (onlineUsers.has(senderNickname)) {
                        avatar.classList.add('online');
                    } else {
                        avatar.classList.remove('online');
                    }
                }
            });
            
            // Atualizar indicadores de status nas mensagens do chat privado
            privateChatMessagesMap.forEach((messageElement, messageKey) => {
                const senderNickname = messageElement.dataset.senderNickname;
                const avatar = messageElement.querySelector('.user-avatar');
                
                if (avatar) {
                    if (onlineUsers.has(senderNickname)) {
                        avatar.classList.add('online');
                    } else {
                        avatar.classList.remove('online');
                    }
                }
            });
            
            // Atualizar indicadores de status na lista de usuários
            const userCards = document.querySelectorAll('.user-card');
            userCards.forEach(card => {
                const nickname = card.dataset.nickname;
                const avatar = card.querySelector('.user-card-avatar');
                
                if (avatar) {
                    if (onlineUsers.has(nickname)) {
                        avatar.classList.add('online');
                    } else {
                        avatar.classList.remove('online');
                    }
                }
            });
            
            // Atualizar indicadores de status no cabeçalho do chat privado
            if (currentPrivateChatUser && privateChatTargetUserInfo) {
                const headerAvatar = privateChatTargetUserInfo.querySelector('.user-avatar');
                if (headerAvatar) {
                    if (onlineUsers.has(currentPrivateChatUser)) {
                        headerAvatar.classList.add('online');
                    } else {
                        headerAvatar.classList.remove('online');
                    }
                }
            }
            
            // Atualizar indicadores de status no perfil visitado
            if (currentVisitProfileUser && visitProfilePic) {
                if (onlineUsers.has(currentVisitProfileUser)) {
                    visitProfilePic.classList.add('online');
                } else {
                    visitProfilePic.classList.remove('online');
                }
            }
        }
        
        function isUserAtBottom(element) {
            const threshold = 100;
            return element.scrollHeight - element.clientHeight - element.scrollTop <= threshold;
        }
        
        function scrollToBottom(element) {
            element.scrollTop = element.scrollHeight;
        }
        
        chatMessages.addEventListener('scroll', () => {
            mainChatUserAtBottom = isUserAtBottom(chatMessages);
            if (mainChatUserAtBottom && mainChatUnreadCount > 0) {
                mainChatUnreadCount = 0;
                updateNewMessagesIndicator();
            }
        });
        
        privateChatMessages.addEventListener('scroll', () => {
            privateChatUserAtBottom = isUserAtBottom(privateChatMessages);
            if (privateChatUserAtBottom && privateChatUnreadCount > 0) {
                privateChatUnreadCount = 0;
                updatePrivateNewMessagesIndicator();
            }
        });
        
        function updateNewMessagesIndicator() {
            if (mainChatUnreadCount > 0) {
                newMessagesIndicator.textContent = `${mainChatUnreadCount} NOVA${mainChatUnreadCount > 1 ? 'S' : ''} MENSAGEM${mainChatUnreadCount > 1 ? 'S' : ''}`;
                newMessagesIndicator.style.display = 'block';
            } else {
                newMessagesIndicator.style.display = 'none';
            }
        }
        
        function updatePrivateNewMessagesIndicator() {
            if (privateChatUnreadCount > 0) {
                privateNewMessagesIndicator.textContent = `${privateChatUnreadCount} NOVA${privateChatUnreadCount > 1 ? 'S' : ''} MENSAGEM${privateChatUnreadCount > 1 ? 'S' : ''}`;
                privateNewMessagesIndicator.style.display = 'block';
            } else {
                privateNewMessagesIndicator.style.display = 'none';
            }
        }
        
        newMessagesIndicator.addEventListener('click', () => {
            scrollToBottom(chatMessages);
            mainChatUserAtBottom = true;
            mainChatUnreadCount = 0;
            updateNewMessagesIndicator();
        });
        
        privateNewMessagesIndicator.addEventListener('click', () => {
            scrollToBottom(privateChatMessages);
            privateChatUserAtBottom = true;
            privateChatUnreadCount = 0;
            updatePrivateNewMessagesIndicator();
        });
        
        function generateAvatarWithInitial(nickname, element) {
            if (!nickname) return;
            
            const firstLetter = nickname.charAt(0).toUpperCase();
            
            const colors = [
                'linear-gradient(135deg, #FF6B6B 0%, #C44569 100%)',
                'linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%)',
                'linear-gradient(135deg, #FFD166 0%, #F4A261 100%)',
                'linear-gradient(135deg, #6A0572 0%, #AB83A1 100%)',
                'linear-gradient(135deg, #1A535C 0%, #4ECDC4 100%)',
                'linear-gradient(135deg, #FF9A8B 0%, #FF6B6B 100%)',
                'linear-gradient(135deg, #118AB2 0%, #06D6A0 100%)',
                'linear-gradient(135deg, #073B4C 0%, #118AB2 100%)',
                'linear-gradient(135deg, #EF476F 0%, #FFD166 100%)',
                'linear-gradient(135deg, #7209B7 0%, #560BAD 100%)'
            ];
            
            const colorIndex = firstLetter.charCodeAt(0) % colors.length;
            element.style.background = colors[colorIndex];
            element.textContent = firstLetter;
        }
        
        function createAvatarElement(profilePicUrl, nickname, size = 40) {
            const avatar = document.createElement('div');
            avatar.className = 'user-avatar';
            avatar.style.width = `${size}px`;
            avatar.style.height = `${size}px`;
            
            const cachedProfile = userProfilesCache[nickname];
            const cachedPic = cachedProfile ? cachedProfile.profilePicture : null;
            
            const finalPicUrl = cachedPic || profilePicUrl;
            
            if (finalPicUrl && finalPicUrl !== DEFAULT_PROFILE_PIC) {
                avatar.style.backgroundImage = `url(${finalPicUrl})`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
                avatar.textContent = '';
            } else {
                generateAvatarWithInitial(nickname, avatar);
            }
            
            // Adicionar indicador de status online/offline
            if (onlineUsers.has(nickname)) {
                avatar.classList.add('online');
            }
            
            return avatar;
        }
        
        function updateUserAvatars(nickname, newProfilePic) {
            if (allUsersData[nickname]) {
                allUsersData[nickname].profilePicture = newProfilePic;
            }
            
            if (userProfilesCache[nickname]) {
                userProfilesCache[nickname].profilePicture = newProfilePic;
            }
            
            chatMessagesMap.forEach((messageElement, messageKey) => {
                if (messageElement.dataset.senderNickname === nickname) {
                    const avatar = messageElement.querySelector('.message-avatar');
                    if (avatar) {
                        if (newProfilePic && newProfilePic !== DEFAULT_PROFILE_PIC) {
                            avatar.style.backgroundImage = `url(${newProfilePic})`;
                            avatar.style.backgroundSize = 'cover';
                            avatar.style.backgroundPosition = 'center';
                            avatar.textContent = '';
                        } else {
                            generateAvatarWithInitial(nickname, avatar);
                        }
                    }
                }
            });
            
            privateChatMessagesMap.forEach((messageElement, messageKey) => {
                if (messageElement.dataset.senderNickname === nickname) {
                    const avatar = messageElement.querySelector('.message-avatar');
                    if (avatar) {
                        if (newProfilePic && newProfilePic !== DEFAULT_PROFILE_PIC) {
                            avatar.style.backgroundImage = `url(${newProfilePic})`;
                            avatar.style.backgroundSize = 'cover';
                            avatar.style.backgroundPosition = 'center';
                            avatar.textContent = '';
                        } else {
                            generateAvatarWithInitial(nickname, avatar);
                        }
                    }
                }
            });
            
            const userCard = document.querySelector(`.user-card[data-nickname="${nickname}"]`);
            if (userCard) {
                const avatar = userCard.querySelector('.user-card-avatar');
                if (avatar) {
                    if (newProfilePic && newProfilePic !== DEFAULT_PROFILE_PIC) {
                        avatar.style.backgroundImage = `url(${newProfilePic})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.style.backgroundPosition = 'center';
                        avatar.textContent = '';
                    } else {
                        generateAvatarWithInitial(nickname, avatar);
                    }
                }
            }
            
            if (currentPrivateChatUser === nickname) {
                const headerAvatar = privateChatTargetUserInfo.querySelector('.user-avatar');
                if (headerAvatar) {
                    if (newProfilePic && newProfilePic !== DEFAULT_PROFILE_PIC) {
                        headerAvatar.style.backgroundImage = `url(${newProfilePic})`;
                        headerAvatar.style.backgroundSize = 'cover';
                        headerAvatar.style.backgroundPosition = 'center';
                        headerAvatar.textContent = '';
                    } else {
                        generateAvatarWithInitial(nickname, headerAvatar);
                    }
                }
            }
            
            if (currentVisitProfileUser === nickname) {
                const visitAvatar = visitProfilePic;
                if (visitAvatar) {
                    if (newProfilePic && newProfilePic !== DEFAULT_PROFILE_PIC) {
                        visitAvatar.style.backgroundImage = `url(${newProfilePic})`;
                        visitAvatar.style.backgroundSize = 'cover';
                        visitAvatar.style.backgroundPosition = 'center';
                        visitAvatar.textContent = '';
                    } else {
                        generateAvatarWithInitial(nickname, visitAvatar);
                    }
                }
            }
            
            if (nickname === currentUserNickname) {
                updateProfileScreenUI();
            }
        }
        
        // Funções para o sistema de navegação com histórico
        function navigateToScreen(screenName, addToHistory = true) {
            // Se estamos navegando para a mesma tela, não fazemos nada
            if (currentScreen === screenName) return;
            
            // Adicionar ao histórico se solicitado
            if (addToHistory) {
                // Se não estamos voltando, adicionamos a tela atual ao histórico
                if (navigationHistory[navigationHistory.length - 1] !== screenName) {
                    navigationHistory.push(screenName);
                }
            }
            
            // Atualizar a tela atual
            currentScreen = screenName;
            
            // Ocultar todas as telas
            profileScreen.classList.add('hidden');
            usersScreen.classList.add('hidden');
            adminScreen.classList.add('hidden');
            chatMain.classList.add('hidden');
            privateChat.classList.add('hidden');
            newsHistoryScreen.classList.add('hidden');
            visitProfileScreen.classList.add('hidden');
            configMenu.classList.add('hidden');
            
            // Mostrar a tela selecionada
            switch (screenName) {
                case 'profile':
                    profileScreen.classList.remove('hidden');
                    updateProfileScreenUI();
                    break;
                case 'users':
                    usersScreen.classList.remove('hidden');
                    updateUsersDisplay();
                    break;
                case 'admin':
                    adminScreen.classList.remove('hidden');
                    updateAdminStats();
                    break;
                case 'main':
                    chatMain.classList.remove('hidden');
                    reevaluateMessagePositions();
                    setTimeout(() => {
                        scrollToBottom(chatMessages);
                        mainChatUserAtBottom = true;
                        mainChatUnreadCount = 0;
                        updateNewMessagesIndicator();
                    }, 100);
                    break;
                case 'private':
                    privateChat.classList.remove('hidden');
                    break;
                case 'news-history':
                    newsHistoryScreen.classList.remove('hidden');
                    loadNewsHistory();
                    break;
                case 'visit-profile':
                    visitProfileScreen.classList.remove('hidden');
                    break;
            }
        }
        
        function goBack() {
            // Se não há histórico para voltar, não fazemos nada
            if (navigationHistory.length <= 1) return;
            
            // Remover a tela atual do histórico
            navigationHistory.pop();
            
            // Obter a tela anterior
            const previousScreen = navigationHistory[navigationHistory.length - 1];
            
            // Navegar para a tela anterior sem adicionar ao histórico
            navigateToScreen(previousScreen, false);
        }
        
        function showScreen(screenElement) {
            const screenName = screenElement.id.replace('-screen', '');
            navigateToScreen(screenName);
        }
        
        function showAdminScreen() {
            navigateToScreen('admin');
        }
        
        function showUsersScreen() {
            navigateToScreen('users');
        }
        
        function showProfileScreen() {
            navigateToScreen('profile');
        }
        
        function showVisitProfileScreen(userNickname) {
            currentVisitProfileUser = userNickname;
            const targetUserProfile = allUsersData[userNickname] || { 
                nickname: userNickname, 
                profilePicture: DEFAULT_PROFILE_PIC,
                profileCover: DEFAULT_PROFILE_COVER,
                isBanned: false,
                mutedUntil: 0,
                adminLevel: 0,
                privateMessagesLocked: true,
                isPremium: false,
                premiumExpiry: null
            };
            
            // Atualizar a capa do perfil visitado
            if (targetUserProfile.profileCover && targetUserProfile.profileCover !== DEFAULT_PROFILE_COVER) {
                visitProfileCover.style.backgroundImage = `url(${targetUserProfile.profileCover})`;
                visitProfileCover.style.backgroundSize = 'cover';
                visitProfileCover.style.backgroundPosition = 'center';
            } else {
                visitProfileCover.style.backgroundImage = '';
                visitProfileCover.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            }
            
            // Atualizar o avatar do perfil visitado
            if (targetUserProfile.profilePicture && targetUserProfile.profilePicture !== DEFAULT_PROFILE_PIC) {
                visitProfilePic.style.backgroundImage = `url(${targetUserProfile.profilePicture})`;
                visitProfilePic.style.backgroundSize = 'cover';
                visitProfilePic.style.backgroundPosition = 'center';
                visitProfilePic.textContent = '';
            } else {
                generateAvatarWithInitial(targetUserProfile.nickname, visitProfilePic);
            }
            
            // Atualizar status online/offline
            if (onlineUsers.has(userNickname)) {
                visitProfilePic.classList.add('online');
            } else {
                visitProfilePic.classList.remove('online');
            }
            
            // Atualizar o nome do perfil visitado com status de administrador
            visitProfileNickname.textContent = targetUserProfile.nickname;
            addAdminStatusToNickname(visitProfileNickname, targetUserProfile.nickname, targetUserProfile.adminLevel || 0);
            
            // Atualizar status
            visitProfileStatus.innerHTML = '';
            
            if (onlineUsers.has(userNickname)) {
                const onlineStatus = document.createElement('span');
                onlineStatus.classList.add('status-badge', 'status-online');
                onlineStatus.textContent = 'ONLINE';
                visitProfileStatus.appendChild(onlineStatus);
            } else {
                const offlineStatus = document.createElement('span');
                offlineStatus.classList.add('status-badge', 'status-offline');
                offlineStatus.textContent = 'OFFLINE';
                visitProfileStatus.appendChild(offlineStatus);
            }
            
            if (targetUserProfile.isBanned) {
                const bannedStatus = document.createElement('span');
                bannedStatus.classList.add('status-badge', 'status-banned');
                bannedStatus.textContent = 'BANIDO';
                visitProfileStatus.appendChild(bannedStatus);
            }
            
            if (targetUserProfile.mutedUntil && targetUserProfile.mutedUntil > Date.now()) {
                const mutedStatus = document.createElement('span');
                mutedStatus.classList.add('status-badge', 'status-muted');
                mutedStatus.textContent = 'SILENCIADO';
                visitProfileStatus.appendChild(mutedStatus);
            }
            
            // Adicionar status de mensagens privadas bloqueadas/desbloqueadas
            if (targetUserProfile.privateMessagesLocked !== undefined) {
                const privateMessageStatus = document.createElement('span');
                privateMessageStatus.classList.add('status-badge', targetUserProfile.privateMessagesLocked ? 'status-locked' : 'status-online');
                privateMessageStatus.textContent = targetUserProfile.privateMessagesLocked ? 'CHAT 🔒' : 'CHAT 🔓';
                visitProfileStatus.appendChild(privateMessageStatus);
            }
            
            // Adicionar status Premium
            if (targetUserProfile.isPremium) {
                const premiumStatus = document.createElement('span');
                premiumStatus.classList.add('status-badge', 'status-premium');
                
                if (targetUserProfile.premiumExpiry) {
                    // Se tem data de expiração, mostrar os dias restantes
                    const now = Date.now();
                    const daysLeft = Math.ceil((targetUserProfile.premiumExpiry - now) / (1000 * 60 * 60 * 24));
                    premiumStatus.textContent = `PREMIUM (${daysLeft} DIAS)`;
                } else {
                    // Se não tem data de expiração, é ilimitado
                    premiumStatus.textContent = 'PREMIUM ILIMITADO';
                }
                
                visitProfileStatus.appendChild(premiumStatus);
            }
            
            // Configurar botão de chat
            visitProfileChatButton.onclick = () => {
                // Verificar se o usuário atual pode iniciar um chat privado com este usuário
                if (currentUserNickname === 'USUÁRIO ANÔNIMO') {
                    showAlertModal('LOGIN NECESSÁRIO', 'VOCÊ PRECISA FAZER LOGIN PARA INICIAR UM CHAT PRIVADO.', 'fas fa-user-circle', 'info');
                    return;
                }
                
                if (currentUserNickname === userNickname) {
                    showAlertModal('ERRO', 'VOCÊ NÃO PODE INICIAR UM CHAT PRIVADO CONSIGO MESMO.', 'fas fa-exclamation-triangle', 'error');
                    return;
                }
                
                // Verificar se o perfil do usuário alvo está bloqueado para mensagens privadas
                if (targetUserProfile.privateMessagesLocked && !currentUserIsAdmin && currentUserNickname !== 'STEVEST') {
                    showAlertModal('MENSAGENS PRIVADAS BLOQUEADAS', 'ESTE USUÁRIO BLOQUEOU MENSAGENS PRIVADAS. APENAS ADMINISTRADORES PODEM ENVIAR MENSAGENS.', 'fas fa-lock', 'warning');
                    return;
                }
                
                showPrivateChat(userNickname);
            };
            
            // Configurar botão de voltar
            visitProfileBackButton.onclick = () => {
                goBack();
            };
            
            navigateToScreen('visit-profile');
        }
        
        function showMainChat() {
            navigateToScreen('main');
        }
        
        function showPrivateChat(targetUserNickname, isAdminAccess = false) {
            if (currentUserNickname === 'USUÁRIO ANÔNIMO' && !isAdminAccess) {
                showAlertModal('LOGIN NECESSÁRIO', 'VOCÊ PRECISA FAZER LOGIN PARA INICIAR UM CHAT PRIVADO.', 'fas fa-user-circle', 'info');
                return;
            }
            if (targetUserNickname === currentUserNickname && !isAdminAccess) {
                showAlertModal('ERRO', 'VOCÊ NÃO PODE INICIAR UM CHAT PRIVADO CONSIGO MESMO.', 'fas fa-exclamation-triangle', 'error');
                return;
            }
            
            // Verificar se o perfil do usuário alvo está bloqueado para mensagens privadas
            const targetUserProfile = allUsersData[targetUserNickname] || { 
                nickname: targetUserNickname, 
                profilePicture: DEFAULT_PROFILE_PIC,
                privateMessagesLocked: true
            };
            
            if (targetUserProfile.privateMessagesLocked && !isAdminAccess && !currentUserIsAdmin && currentUserNickname !== 'STEVEST') {
                showAlertModal('MENSAGENS PRIVADAS BLOQUEADAS', 'ESTE USUÁRIO BLOQUEOU MENSAGENS PRIVADAS. APENAS ADMINISTRADORES PODEM ENVIAR MENSAGENS.', 'fas fa-lock', 'warning');
                return;
            }
            
            currentPrivateChatUser = targetUserNickname;
            isAdminAccessingPrivateChat = isAdminAccess;
            
            const targetUserProfileData = allUsersData[targetUserNickname] || { nickname: targetUserNickname, profilePicture: DEFAULT_PROFILE_PIC };
            
            privateChatTargetUserInfo.innerHTML = '';
            const avatar = createAvatarElement(targetUserProfileData.profilePicture, targetUserNickname, 36);
            avatar.classList.add('user-avatar');
            privateChatTargetUserInfo.appendChild(avatar);
            
            const nicknameSpan = document.createElement('span');
            nicknameSpan.textContent = targetUserProfileData.nickname;
            privateChatTargetUserInfo.appendChild(nicknameSpan);
            
            // Adicionar status de administrador
            addAdminStatusToNickname(nicknameSpan, targetUserProfileData.nickname, targetUserProfileData.adminLevel || 0);
            
            navigateToScreen('private');
            loadPrivateMessages();
            
            privateChatUserAtBottom = true;
            privateChatUnreadCount = 0;
            updatePrivateNewMessagesIndicator();
        }
        
        function hidePrivateChat() {
            goBack();
            currentPrivateChatUser = null;
            isAdminAccessingPrivateChat = false;
            if (privateMessagesRef.currentPrivateChatRef) {
                privateMessagesRef.currentPrivateChatRef.off();
                privateMessagesRef.currentPrivateChatRef = null;
            }
            privateChatMessages.innerHTML = '';
            privateChatMessagesMap.clear();
        }
        
        function showNewsHistoryScreen() {
            navigateToScreen('news-history');
        }
        
        configButton.addEventListener('click', (event) => {
            event.stopPropagation();
            configMenu.classList.toggle('hidden');
        });
        
        document.addEventListener('click', (event) => {
            if (!configMenu.contains(event.target) && !configButton.contains(event.target)) {
                configMenu.classList.add('hidden');
            }
        });
        
        profileScreenButton.addEventListener('click', showProfileScreen);
        closeProfileScreenButton.addEventListener('click', () => goBack());
        usersScreenButton.addEventListener('click', showUsersScreen);
        closeUsersScreenButton.addEventListener('click', () => goBack());
        adminScreenButton.addEventListener('click', showAdminScreen);
        closeAdminScreenButton.addEventListener('click', () => goBack());
        backToMainChatButton.addEventListener('click', hidePrivateChat);
        closePrivateChatButton.addEventListener('click', hidePrivateChat);
        newsHistoryScreenButton.addEventListener('click', showNewsHistoryScreen);
        closeNewsHistoryScreenButton.addEventListener('click', () => goBack());
        viewNewsHistoryBtnAdmin.addEventListener('click', showNewsHistoryScreen);
        closeVisitProfileScreenButton.addEventListener('click', () => goBack());
        
        // Botões de voltar com histórico
        document.getElementById('back-to-main-from-profile').addEventListener('click', () => goBack());
        document.getElementById('back-to-main-from-users').addEventListener('click', () => goBack());
        document.getElementById('back-to-main-from-admin').addEventListener('click', () => goBack());
        document.getElementById('back-to-users-from-visit-profile').addEventListener('click', () => goBack());
        document.getElementById('back-to-admin-from-news-history').addEventListener('click', () => goBack());
        
        // Navegação entre abas do painel de administração
        adminNavItems.forEach(item => {
            item.addEventListener('click', () => {
                const tabName = item.dataset.tab;
                
                // Remover a classe 'active' de todos os itens e conteúdos
                adminNavItems.forEach(navItem => navItem.classList.remove('active'));
                Object.values(adminTabContents).forEach(content => content.classList.remove('active'));
                
                // Adicionar a classe 'active' ao item clicado e ao conteúdo correspondente
                item.classList.add('active');
                if (adminTabContents[tabName]) {
                    adminTabContents[tabName].classList.add('active');
                }
            });
        });
        
        function updateUsersDisplay() {
            if (!allUsersData) return;
            usersGrid.innerHTML = '';
            
            const users = Object.values(allUsersData);
            
            users.sort((a, b) => {
                if (a.nickname === 'STEVEST') return -1;
                if (b.nickname === 'STEVEST') return 1;
                
                const aAdminLevel = a.adminLevel || 0;
                const bAdminLevel = b.adminLevel || 0;
                
                if (aAdminLevel > 0 && bAdminLevel > 0) {
                    return bAdminLevel - aAdminLevel;
                }
                
                if (aAdminLevel > 0 && bAdminLevel === 0) return -1;
                if (aAdminLevel === 0 && bAdminLevel > 0) return 1;
                
                return a.nickname.localeCompare(b.nickname);
            });
            
            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.classList.add('user-card');
                userCard.dataset.nickname = user.nickname;
                userCard.addEventListener('click', () => showVisitProfileScreen(user.nickname));
                
                const avatar = document.createElement('div');
                avatar.classList.add('user-card-avatar');
                
                if (user.profilePicture && user.profilePicture !== DEFAULT_PROFILE_PIC) {
                    avatar.style.backgroundImage = `url(${user.profilePicture})`;
                    avatar.style.backgroundSize = 'cover';
                    avatar.style.backgroundPosition = 'center';
                } else {
                    generateAvatarWithInitial(user.nickname, avatar);
                }
                
                // Adicionar indicador de status online/offline
                if (onlineUsers.has(user.nickname)) {
                    avatar.classList.add('online');
                }
                
                // Adicionar badge Premium se o usuário for Premium
                if (user.isPremium) {
                    const premiumBadge = document.createElement('div');
                    premiumBadge.classList.add('premium-badge');
                    premiumBadge.innerHTML = '<i class="fas fa-star"></i>';
                    avatar.appendChild(premiumBadge);
                }
                
                const userInfo = document.createElement('div');
                userInfo.classList.add('user-card-info');
                const nicknameDiv = document.createElement('div');
                nicknameDiv.classList.add('user-card-nickname');
                nicknameDiv.textContent = user.nickname;
                
                // Adicionar status de administrador
                addAdminStatusToNickname(nicknameDiv, user.nickname, user.adminLevel || 0);
                
                const statusDiv = document.createElement('div');
                statusDiv.classList.add('user-card-status');
                
                // Adicionar status online/offline
                if (onlineUsers.has(user.nickname)) {
                    const onlineStatus = document.createElement('span');
                    onlineStatus.classList.add('status-badge', 'status-online');
                    onlineStatus.textContent = 'ONLINE';
                    statusDiv.appendChild(onlineStatus);
                } else {
                    const offlineStatus = document.createElement('span');
                    offlineStatus.classList.add('status-badge', 'status-offline');
                    offlineStatus.textContent = 'OFFLINE';
                    statusDiv.appendChild(offlineStatus);
                }
                
                if (user.isBanned) {
                    const bannedStatus = document.createElement('span');
                    bannedStatus.classList.add('status-badge', 'status-banned');
                    bannedStatus.textContent = 'BANIDO';
                    statusDiv.appendChild(bannedStatus);
                }
                if (user.mutedUntil && user.mutedUntil > Date.now()) {
                    const mutedStatus = document.createElement('span');
                    mutedStatus.classList.add('status-badge', 'status-muted');
                    mutedStatus.textContent = 'SILENCIADO';
                    statusDiv.appendChild(mutedStatus);
                }
                
                // Adicionar status de mensagens privadas bloqueadas/desbloqueadas
                if (user.privateMessagesLocked !== undefined) {
                    const privateMessageStatus = document.createElement('span');
                    privateMessageStatus.classList.add('status-badge', user.privateMessagesLocked ? 'status-locked' : 'status-online');
                    privateMessageStatus.textContent = user.privateMessagesLocked ? 'CHAT 🔒' : 'CHAT 🔓';
                    statusDiv.appendChild(privateMessageStatus);
                }
                
                // Adicionar status Premium
                if (user.isPremium) {
                    const premiumStatus = document.createElement('span');
                    premiumStatus.classList.add('status-badge', 'status-premium');
                    
                    if (user.premiumExpiry) {
                        // Se tem data de expiração, mostrar os dias restantes
                        const now = Date.now();
                        const daysLeft = Math.ceil((user.premiumExpiry - now) / (1000 * 60 * 60 * 24));
                        premiumStatus.textContent = `PREMIUM (${daysLeft} DIAS)`;
                    } else {
                        // Se não tem data de expiração, é ilimitado
                        premiumStatus.textContent = 'PREMIUM ILIMITADO';
                    }
                    
                    statusDiv.appendChild(premiumStatus);
                }
                
                userInfo.appendChild(nicknameDiv);
                userInfo.appendChild(statusDiv);
                userCard.appendChild(avatar);
                userCard.appendChild(userInfo);
                usersGrid.appendChild(userCard);
            });
        }
        
        function updateAdminStats() {
            if (!allUsersData) return;
            const users = Object.values(allUsersData);
            const now = Date.now();
            
            const totalUsers = users.length;
            const bannedUsers = users.filter(user => user.isBanned).length;
            const mutedUsers = users.filter(user => user.mutedUntil && user.mutedUntil > now).length;
            const adminUsers = users.filter(user => user.adminLevel > 0 || user.nickname === 'STEVEST').length;
            
            onlineUsersCount.textContent = onlineUsers.size;
            bannedUsersCount.textContent = bannedUsers;
            mutedUsersCount.textContent = mutedUsers;
            adminUsersCount.textContent = adminUsers;
        }
        
        newsRef.orderByChild('timestamp').limitToLast(10).on('value', (snapshot) => {
            const newsData = snapshot.val();
            updateNewsTickerDisplay(newsData);
        });
        
        async function addNewsItem(adminNickname, action, targetUser, duration = null, adminLevel = 0) {
            const isStevest = adminNickname === 'STEVEST';
            
            let adminCrownHtml = '';
            if (isStevest) {
                adminCrownHtml = getAdminCrown('STEVEST', 6);
            } else {
                const adminProfile = await getProfileDataFromFirebase(adminNickname);
                adminCrownHtml = getAdminCrown(adminNickname, adminProfile.adminLevel || 0);
            }
            const adminTitle = isStevest ? 'DONO' : 'ADMIN';
            const adminClass = isStevest ? 'dono' : 'admin';
            
            let newsText = '';
            let icon = '';
            
            switch(action) {
                case 'ban':
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} baniu ${targetUser}`;
                    icon = '🔨';
                    break;
                case 'unban':
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} desbaniu ${targetUser}`;
                    icon = '✅';
                    break;
                case 'mute':
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} silenciou ${targetUser} por ${duration} minutos`;
                    icon = '🔇';
                    break;
                case 'unmute':
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} dessilenciou ${targetUser}`;
                    icon = '🔊';
                    break;
                case 'clear_messages':
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} limpou as mensagens de ${targetUser}`;
                    icon = '🗑️';
                    break;
                case 'delete_profile':
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} deletou o perfil de ${targetUser}`;
                    icon = '❌';
                    break;
                case 'promote_admin':
                    const promotedCrownHtml = getAdminCrown(targetUser, adminLevel);
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} promoveu ${targetUser} a administrador ${promotedCrownHtml}`;
                    icon = '⬆️';
                    break;
                case 'demote_admin':
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} removeu ${targetUser} da administração`;
                    icon = '⬇️';
                    break;
                case 'clear_all':
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} limpou todas as mensagens do chat`;
                    icon = '🧹';
                    break;
                case 'unlock_private':
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} desbloqueou mensagens privadas`;
                    icon = '🔓';
                    break;
                case 'lock_private':
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} bloqueou mensagens privadas`;
                    icon = '🔒';
                    break;
                case 'grant_premium':
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} concedeu Premium para ${targetUser} por ${duration} dias`;
                    icon = '⭐';
                    break;
                case 'revoke_premium':
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} revogou Premium de ${targetUser}`;
                    icon = '💔';
                    break;
                case 'self_premium':
                    newsText = `${adminTitle} ${adminNickname}${adminCrownHtml} ativou Premium ilimitado`;
                    icon = '⭐';
                    break;
            }
            
            const newsItem = {
                text: newsText,
                icon: icon,
                class: adminClass,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            newsRef.push(newsItem);
        }
        
        function updateNewsTickerDisplay(newsData) {
            if (!newsData || Object.keys(newsData).length === 0) {
                newsSystem.classList.add('empty');
                return;
            }
            
            newsSystem.classList.remove('empty');
            newsTicker.innerHTML = '';
            
            const newsArray = Object.values(newsData).sort((a, b) => a.timestamp - b.timestamp);
            
            newsArray.forEach(news => {
                const newsElement = document.createElement('div');
                newsElement.className = `news-item ${news.class}`;
                newsElement.innerHTML = `<span class="news-icon">${news.icon}</span>${news.text}`;
                newsTicker.appendChild(newsElement);
            });
        }
        
        async function loadNewsHistory() {
            newsHistoryList.innerHTML = '';
            try {
                const snapshot = await newsRef.orderByChild('timestamp').once('value');
                const newsData = snapshot.val();
                if (!newsData) {
                    newsHistoryList.innerHTML = '<p class="text-gray-600 text-center">Nenhum histórico de notícias encontrado.</p>';
                    return;
                }
                const newsArray = Object.entries(newsData).map(([key, value]) => ({ key, ...value })).sort((a, b) => b.timestamp - a.timestamp);
                newsArray.forEach(news => {
                    const newsItem = document.createElement('div');
                    newsItem.classList.add('news-history-item');
                    newsItem.dataset.key = news.key;
                    const infoDiv = document.createElement('div');
                    infoDiv.classList.add('news-history-item-info');
                    const textSpan = document.createElement('span');
                    textSpan.classList.add('news-history-item-text');
                    textSpan.innerHTML = `${news.icon} ${news.text}`;
                    const timeSpan = document.createElement('span');
                    timeSpan.classList.add('news-history-item-time');
                    const date = new Date(news.timestamp);
                    timeSpan.textContent = date.toLocaleString('pt-BR');
                    infoDiv.appendChild(textSpan);
                    infoDiv.appendChild(timeSpan);
                    const deleteButton = document.createElement('button');
                    deleteButton.classList.add('news-history-item-delete-btn');
                    deleteButton.textContent = 'EXCLUIR';
                    deleteButton.addEventListener('click', async () => {
                        const confirmed = await showConfirmModal(
                            'EXCLUIR NOTÍCIA',
                            'TEM CERTEZA QUE DESEJA EXCLUIR ESTA NOTÍCIA DO HISTÓRICO?',
                            'fas fa-trash-alt', 'warning'
                        );
                        if (confirmed) {
                            try {
                                await newsRef.child(news.key).remove();
                                newsItem.remove();
                                await showAlertModal('SUCESSO!', 'NOTÍCIA EXCLUÍDA!', 'fas fa-check-circle', 'success');
                            } catch (error) {
                                console.error('ERRO AO EXCLUIR NOTÍCIA:', error);
                                await showAlertModal('ERRO', 'ERRO AO EXCLUIR NOTÍCIA.', 'fas fa-times-circle', 'error');
                            }
                        }
                    });
                    newsItem.appendChild(infoDiv);
                    if (isAdminOrStevest()) {
                        newsItem.appendChild(deleteButton);
                    }
                    newsHistoryList.appendChild(newsItem);
                });
            } catch (error) {
                console.error('ERRO AO CARREGAR HISTÓRICO DE NOTÍCIAS:', error);
                newsHistoryList.innerHTML = '<p class="text-red-500 text-center">Erro ao carregar histórico de notícias.</p>';
            }
        }
        
        function getAdminCrown(nickname, adminLevel) {
            if (nickname === 'STEVEST') {
                return '<span class="admin-icon stevest-crown">∞︎︎</span>';
            }
            
            switch(adminLevel) {
                case 5: return '<span class="admin-icon level-5-crown">🔱</span>';
                case 4: return '<span class="admin-icon level-4-crown">⚜️</span>';
                case 3: return '<span class="admin-icon level-3-crown">🏆</span>';
                case 2: return '<span class="admin-icon level-2-crown">🎖️</span>';
                case 1: return '<span class="admin-icon level-1-crown">⭐</span>';
                default: return '';
            }
        }
        
        function isAdminOrStevest(nickname = currentUserNickname, adminLevel = currentUserAdminLevel) {
            return nickname === 'STEVEST' || adminLevel > 0;
        }
        
        function isOnlyStevest(nickname = currentUserNickname) {
            return nickname === 'STEVEST';
        }
        
        function canPerformAdminAction(targetNickname, targetAdminLevel, requiredLevel = 1) {
            if (currentUserNickname === 'STEVEST') return true;
            if (targetNickname === 'STEVEST') return false;
            if (currentUserAdminLevel === 0) return false;
            if (currentUserAdminLevel < requiredLevel) return false;
            return currentUserAdminLevel > targetAdminLevel;
        }
        
        function openMediaViewer(mediaUrl, mediaType) {
            mediaViewerImage.classList.add('hidden');
            mediaViewerVideo.classList.add('hidden');
            mediaViewerVideo.pause();
            if (mediaType === 'image') {
                mediaViewerImage.src = mediaUrl;
                mediaViewerImage.classList.remove('hidden');
            } else if (mediaType === 'video') {
                mediaViewerVideo.src = mediaUrl;
                mediaViewerVideo.load();
                mediaViewerVideo.classList.remove('hidden');
            }
            mediaViewerModal.classList.add('show');
        }
        
        function closeMediaViewer() {
            mediaViewerModal.classList.remove('show');
            mediaViewerImage.src = '';
            mediaViewerVideo.src = '';
            mediaViewerVideo.pause();
        }
        
        mediaViewerCloseBtn.addEventListener('click', closeMediaViewer);
        mediaViewerModal.addEventListener('click', (e) => {
            if (e.target === mediaViewerModal) {
                closeMediaViewer();
            }
        });
        
        async function showConfirmModal(title, message, iconClass = 'fas fa-question-circle', iconType = 'info') {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalIcon.className = `custom-modal-icon ${iconClass} ${iconType}`; 
                modalButtons.innerHTML = ''; 
                const confirmButton = document.createElement('button');
                confirmButton.classList.add('custom-modal-button', 'confirm');
                confirmButton.textContent = 'CONFIRMAR';
                confirmButton.onclick = () => {
                    customModalOverlay.classList.remove('show');
                    resolve(true); 
                };
                const cancelButton = document.createElement('button');
                cancelButton.classList.add('custom-modal-button', 'cancel');
                cancelButton.textContent = 'CANCELAR';
                cancelButton.onclick = () => {
                    customModalOverlay.classList.remove('show');
                    resolve(false); 
                };
                modalButtons.appendChild(confirmButton);
                modalButtons.appendChild(cancelButton);
                customModalOverlay.classList.add('show');
            });
        }
        
        async function showAlertModal(title, message, iconClass = 'fas fa-info-circle', iconType = 'info') {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalIcon.className = `custom-modal-icon ${iconClass} ${iconType}`; 
                modalButtons.innerHTML = ''; 
                const okButton = document.createElement('button');
                okButton.classList.add('custom-modal-button', 'alert-ok');
                okButton.textContent = 'OK';
                okButton.onclick = () => {
                    customModalOverlay.classList.remove('show');
                    resolve(); 
                };
                modalButtons.appendChild(okButton);
                customModalOverlay.classList.add('show');
            });
        }
        
        function showUploadProgressModal() {
            uploadModalOverlay.classList.add('show');
            uploadProgressBar.style.width = '0%';
            uploadPercentageText.textContent = '0%';
        }
        
        function hideUploadProgressModal() {
            uploadModalOverlay.classList.remove('show');
        }
        
        async function clearAllMessages() {
            if (!isAdminOrStevest()) { 
                await showAlertModal('ERRO DE PERMISSÃO', 'APENAS ADMINISTRADORES PODEM APAGAR TODAS AS MENSAGENS.', 'fas fa-exclamation-triangle', 'error');
                return; 
            }
            
            const confirmed = await showConfirmModal(
                'APAGAR TODAS AS MENSAGENS',
                'TEM CERTEZA DE QUE DESEJA APAGAR TODAS AS MENSAGENS DO CHAT? ESTA AÇÃO É IRREVERSÍVEL.',
                'fas fa-trash-alt', 'warning'
            );
            
            if (confirmed) {
                try {
                    await messagesRef.remove(); 
                    console.log('TODAS AS MENSAGENS FORAM APAGADAS.');
                    
                    addNewsItem(currentUserNickname, 'clear_all');
                    
                    await showAlertModal('SUCESSO!', 'TODAS AS MENSAGENS FORAM APAGADAS!', 'fas fa-check-circle', 'success');
                } catch (error) {
                    console.error("ERRO AO APAGAR MENSAGENS: ", error);
                    await showAlertModal('ERRO', 'ERRO AO APAGAR MENSAGENS. TENTE NOVAMENTE.', 'fas fa-times-circle', 'error');
                }
            }
        }
        
        async function getProfileDataFromFirebase(nickname) {
            if (userProfilesCache[nickname]) {
                return userProfilesCache[nickname];
            }
            try {
                const snapshot = await usersProfileRef.child(nickname).once('value');
                const userData = snapshot.val();
                if (userData) {
                    const profileData = {
                        profilePicture: userData.profilePicture || DEFAULT_PROFILE_PIC,
                        profileCover: userData.profileCover || DEFAULT_PROFILE_COVER,
                        nickname: userData.nickname,
                        isBanned: userData.isBanned || false,
                        mutedUntil: userData.mutedUntil || 0,
                        isAdmin: userData.isAdmin || false,
                        adminLevel: userData.adminLevel || 0,
                        isBannedByStevest: userData.isBannedByStevest || false,
                        isMutedByStevest: userData.isMutedByStevest || false,
                        privateMessagesLocked: userData.privateMessagesLocked !== false, // Por padrão é true (bloqueado)
                        isPremium: userData.isPremium || false,
                        premiumExpiry: userData.premiumExpiry || null
                    };
                    userProfilesCache[nickname] = profileData;
                    return profileData;
                }
            } catch (error) {
                console.error(`ERRO AO BUSCAR DADOS DE PERFIL PARA ${nickname}:`, error);
            }
            return { 
                profilePicture: DEFAULT_PROFILE_PIC, 
                profileCover: DEFAULT_PROFILE_COVER,
                nickname: nickname, 
                isBanned: false, 
                mutedUntil: 0, 
                isAdmin: false, 
                adminLevel: 0, 
                isBannedByStevest: false, 
                isMutedByStevest: false,
                privateMessagesLocked: true, // Por padrão é true (bloqueado)
                isPremium: false,
                premiumExpiry: null
            };
        }
        
        sendButton.addEventListener('click', () => sendMessage('main'));
        messageInput.addEventListener('keypress', async (e) => { 
            if (e.key === 'Enter') await sendMessage('main'); 
        });
        mediaButton.addEventListener('click', () => {
            mediaUploadInput.click();
        });
        mediaUploadInput.addEventListener('change', (event) => handleMediaUpload(event, 'main'));
        
        privateSendButton.addEventListener('click', () => sendMessage('private'));
        privateMessageInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') await sendMessage('private');
        });
        privateMediaButton.addEventListener('click', () => {
            privateMediaUploadInput.click();
        });
        privateMediaUploadInput.addEventListener('change', (event) => handleMediaUpload(event, 'private'));
        
        async function handleMediaUpload(event, chatType) {
            const inputElement = chatType === 'main' ? mediaUploadInput : privateMediaUploadInput;
            const messageInputElement = chatType === 'main' ? messageInput : privateMessageInput;
            const targetUser = chatType === 'private' ? currentPrivateChatUser : null;
            
            if (currentUserNickname === 'USUÁRIO ANÔNIMO' && !isAdminAccessingPrivateChat) {
                await showAlertModal('LOGIN NECESSÁRIO', 'VOCÊ PRECISA FAZER LOGIN PARA ENVIAR MÍDIA!', 'fas fa-user-circle', 'info');
                inputElement.value = '';
                return;
            }
            
            if (allUsersData[currentUserNickname] && allUsersData[currentUserNickname].isBanned) {
                await showAlertModal('BANIDO', 'VOCÊ ESTÁ BANIDO DO CHAT E NÃO PODE ENVIAR MÍDIA.', 'fas fa-ban', 'error');
                inputElement.value = '';
                return;
            }
            
            if (isUserMuted) {
                await showAlertModal('SILENCIADO', 'VOCÊ ESTÁ SILENCIADO E NÃO PODE ENVIAR MÍDIA.', 'fas fa-microphone-slash', 'warning');
                inputElement.value = '';
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            const fileType = file.type;
            let mediaType = '';
            
            if (fileType.startsWith('image/')) {
                mediaType = 'image';
            } else if (fileType.startsWith('video/')) {
                mediaType = 'video';
            } else {
                await showAlertModal('FORMATO INVÁLIDO', 'POR FAVOR, SELECIONE UMA IMAGEM OU UM VÍDEO.', 'fas fa-exclamation-triangle', 'warning');
                inputElement.value = '';
                return;
            }
            
            showUploadProgressModal();
            const fileName = `${Date.now()}_${file.name}`;
            const storageRef = storage.ref(`chat_media/${fileName}`);
            const uploadTask = storageRef.put(file);
            
            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadPercentageText.textContent = `${Math.round(progress)}%`;
                    uploadProgressBar.style.width = `${progress}%`;
                }, 
                (error) => {
                    console.error("ERRO NO UPLOAD DE MÍDIA: ", error);
                    showAlertModal('ERRO DE UPLOAD', 'NÃO FOI POSSÍVEL ENVIAR A MÍDIA. TENTE NOVAMENTE.', 'fas fa-times-circle', 'error');
                    hideUploadProgressModal();
                }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then(async (downloadURL) => {
                        const messageData = {
                            mediaUrl: downloadURL,
                            mediaType: mediaType,
                            text: messageInputElement.value.trim() || '',
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            senderNickname: currentUserNickname,
                            senderProfilePic: currentUserProfilePic,
                            senderIsAdmin: currentUserIsAdmin
                        };
                        
                        if (chatType === 'main') {
                            messageData.replyTo = replyingToMessage;
                            messagesRef.push(messageData);
                            cancelReply();
                        } else if (chatType === 'private' && targetUser) {
                            messageData.receiverNickname = targetUser;
                            messageData.replyTo = privateReplyingToMessage;
                            const chatKey = getPrivateChatKey(currentUserNickname, targetUser);
                            const newMessageRef = privateMessagesRef.child(chatKey).push();
                            await newMessageRef.set(messageData);
                            if (targetUser === STIA_NAME) {
                                const payloadForStia = { ...messageData };
                                if (!payloadForStia.text) {
                                    payloadForStia.text = mediaType === 'image' ? '[IMAGEM]' : mediaType === 'video' ? '[VÍDEO]' : '[MÍDIA]';
                                }
                                payloadForStia.timestamp = Date.now();
                                stiaHandlePrivateUserMessage(payloadForStia, newMessageRef.key).catch(error => {
                                    console.error('STIA: erro ao processar mídia privada.', error);
                                });
                            }
                            cancelPrivateReply();
                        }

                        messageInputElement.value = '';
                        inputElement.value = '';
                        hideUploadProgressModal();
                    });
                }
            );
        }
        
        async function sendMessage(chatType) {
            const messageInputElement = chatType === 'main' ? messageInput : privateMessageInput;
            const message = messageInputElement.value.trim();
            const targetUser = chatType === 'private' ? currentPrivateChatUser : null;
            
            if (currentUserNickname === 'USUÁRIO ANÔNIMO' && !isAdminAccessingPrivateChat) {
                await showAlertModal('LOGIN NECESSÁRIO', 'VOCÊ PRECISA FAZER LOGIN PARA ENVIAR MENSAGENS!', 'fas fa-user-circle', 'info');
                messageInputElement.value = '';
                return;
            }
            
            if (allUsersData[currentUserNickname] && allUsersData[currentUserNickname].isBanned) {
                await showAlertModal('BANIDO', 'VOCÊ ESTÁ BANIDO DO CHAT E NÃO PODE ENVIAR MENSAGENS.', 'fas fa-ban', 'error');
                messageInputElement.value = '';
                return;
            }
            
            if (isUserMuted) {
                await showAlertModal('SILENCIADO', 'VOCÊ ESTÁ SILENCIADO E NÃO PODE ENVIAR MENSAGENS.', 'fas fa-microphone-slash', 'warning');
                messageInputElement.value = '';
                return;
            }
            
            if (message) {
                const messageData = {
                    text: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP, 
                    senderNickname: currentUserNickname,
                    senderProfilePic: currentUserProfilePic,
                    senderIsAdmin: currentUserIsAdmin
                };
                
                if (chatType === 'main') {
                    messageData.replyTo = replyingToMessage;
                    messagesRef.push(messageData);
                    cancelReply();
                } else if (chatType === 'private' && targetUser) {
                    messageData.receiverNickname = targetUser;
                    messageData.replyTo = privateReplyingToMessage;
                    const chatKey = getPrivateChatKey(currentUserNickname, targetUser);
                    const newMessageRef = privateMessagesRef.child(chatKey).push();
                    await newMessageRef.set(messageData);
                    if (targetUser === STIA_NAME) {
                        const payloadForStia = { ...messageData };
                        if (!payloadForStia.text) {
                            payloadForStia.text = messageData.mediaType ? `[${(messageData.mediaType || '').toUpperCase()}]` : '';
                        }
                        payloadForStia.timestamp = Date.now();
                        stiaHandlePrivateUserMessage(payloadForStia, newMessageRef.key).catch(error => {
                            console.error('STIA: erro ao processar mensagem privada.', error);
                        });
                    }
                    cancelPrivateReply();
                }

                messageInputElement.value = '';
            }
        }
        
        function setupReply(messageKey, senderNickname, messageText, mediaType, mediaUrl) {
            replyingToMessage = messageKey;
            replyPreviewContainer.classList.remove('hidden');
            
            let previewContent = `<strong>${senderNickname}:</strong> `;
            
            if (mediaType === 'image') {
                previewContent += `<div class="reply-media-preview"><img src="${mediaUrl}" class="reply-media-thumbnail" alt="IMAGEM"><span>IMAGEM</span></div>`;
            } else if (mediaType === 'video') {
                previewContent += `<div class="reply-media-preview"><div class="reply-media-icon video"><i class="fas fa-video"></i></div><span>VÍDEO</span></div>`;
            } else if (messageText) {
                previewContent += `<span>${messageText}</span>`;
            }
            
            replyPreviewContent.innerHTML = previewContent;
            
            replyPreviewContainer.style.borderLeftColor = '#4f46e5';
            replyPreviewContainer.style.boxShadow = '0 4px 12px rgba(79, 70, 229, 0.2)';
        }
        
        function cancelReply() {
            replyingToMessage = null;
            replyPreviewContainer.classList.add('hidden');
            replyPreviewContent.innerHTML = '';
        }
        
        replyCancelButton.addEventListener('click', cancelReply);
        
        function setupPrivateReply(messageKey, senderNickname, messageText, mediaType, mediaUrl) {
            privateReplyingToMessage = messageKey;
            privateReplyPreviewContainer.classList.remove('hidden');
            
            let previewContent = `<strong>${senderNickname}:</strong> `;
            
            if (mediaType === 'image') {
                previewContent += `<div class="reply-media-preview"><img src="${mediaUrl}" class="reply-media-thumbnail" alt="IMAGEM"><span>IMAGEM</span></div>`;
            } else if (mediaType === 'video') {
                previewContent += `<div class="reply-media-preview"><div class="reply-media-icon video"><i class="fas fa-video"></i></div><span>VÍDEO</span></div>`;
            } else if (messageText) {
                previewContent += `<span>${messageText}</span>`;
            }
            
            privateReplyPreviewContent.innerHTML = previewContent;
            
            privateReplyPreviewContainer.style.borderLeftColor = '#4f46e5';
            privateReplyPreviewContainer.style.boxShadow = '0 4px 12px rgba(79, 70, 229, 0.2)';
        }
        
        function cancelPrivateReply() {
            privateReplyingToMessage = null;
            privateReplyPreviewContainer.classList.add('hidden');
            privateReplyPreviewContent.innerHTML = '';
        }
        
        privateReplyCancelButton.addEventListener('click', cancelPrivateReply);
        
        async function deleteMessage(messageKey, senderNickname, chatType) {
            if (!isAdminOrStevest() && currentUserNickname !== senderNickname) {
                await showAlertModal('PERMISSÃO NEGADA', 'VOCÊ SÓ PODE APAGAR SUAS PRÓPRIAS MENSAGENS OU SER ADMINISTRADOR.', 'fas fa-exclamation-triangle', 'error');
                return;
            }
            
            const confirmed = await showConfirmModal(
                'APAGAR MENSAGEM',
                'TEM CERTEZA QUE DESEJA APAGAR ESTA MENSAGEM?',
                'fas fa-trash-alt', 'warning'
            );
            
            if (confirmed) {
                try {
                    let messageRef;
                    let messageData;
                    
                    if (chatType === 'main') {
                        messageRef = messagesRef.child(messageKey);
                        messageData = (await messageRef.once('value')).val();
                    } else if (chatType === 'private' && currentPrivateChatUser) {
                        const chatKey = getPrivateChatKey(currentUserNickname, currentPrivateChatUser);
                        messageRef = privateMessagesRef.child(chatKey).child(messageKey);
                        messageData = (await messageRef.once('value')).val();
                    }
                    
                    if (messageData && messageData.mediaUrl) {
                        const fileRef = storage.refFromURL(messageData.mediaUrl);
                        await fileRef.delete();
                        console.log('MÍDIA ASSOCIADA À MENSAGEM EXCLUÍDA DO STORAGE.');
                    }
                    
                    await messageRef.remove();
                    console.log(`MENSAGEM ${messageKey} APAGADA POR ${currentUserNickname}.`);
                    await showAlertModal('SUCESSO!', 'MENSAGEM APAGADA COM SUCESSO!', 'fas fa-check-circle', 'success');
                } catch (error) {
                    console.error("ERRO AO APAGAR MENSAGEM: ", error);
                    await showAlertModal('ERRO', 'ERRO AO APAGAR MENSAGEM. TENTE NOVAMENTE.', 'fas fa-times-circle', 'error');
                }
            }
        }
        
        function applyMessagePositioning(messageElement, senderNickname) {
            const isMyMessage = senderNickname === currentUserNickname;
            messageElement.classList.remove('my-message-container', 'other-message-container');
            
            const deleteButton = messageElement.querySelector('.delete-message-button'); 
            const downloadButton = messageElement.querySelector('.download-media-button');
            const replyButton = messageElement.querySelector('.reply-message-button');
            
            if (isMyMessage) {
                messageElement.classList.add('my-message-container');
                const bubble = messageElement.querySelector('.message-bubble');
                const userInfo = messageElement.querySelector('.user-info');
                
                if (bubble && userInfo && messageElement.firstChild !== bubble) {
                     messageElement.insertBefore(bubble, userInfo); 
                }
                
                if (deleteButton) { 
                    deleteButton.style.display = 'flex';
                }
                if (downloadButton) { 
                    downloadButton.style.display = 'flex';
                }
                if (replyButton) {
                    replyButton.style.display = 'flex';
                }
            } else {
                messageElement.classList.add('other-message-container');
                const bubble = messageElement.querySelector('.message-bubble');
                const userInfo = messageElement.querySelector('.user-info');
                
                if (bubble && userInfo && messageElement.firstChild !== userInfo) {
                    messageElement.insertBefore(userInfo, bubble); 
                }
                
                if (deleteButton) { 
                    deleteButton.style.display = (currentUserIsAdmin || currentUserNickname === 'STEVEST') ? 'flex' : 'none';
                }
                if (downloadButton) { 
                    downloadButton.style.display = 'flex';
                }
                if (replyButton) {
                    replyButton.style.display = 'flex';
                }
            }
        }
        
        // Função para navegar até a mensagem original
        function scrollToOriginalMessage(messageKey, chatType) {
            const messagesContainer = chatType === 'main' ? chatMessages : privateChatMessages;
            const messagesMap = chatType === 'main' ? chatMessagesMap : privateChatMessagesMap;
            
            const originalMessageElement = messagesMap.get(messageKey);
            if (originalMessageElement) {
                // Adicionar classe de destaque
                originalMessageElement.classList.add('highlight-message');
                
                // Remover a classe após a animação
                setTimeout(() => {
                    originalMessageElement.classList.remove('highlight-message');
                }, 2000);
                
                // Rolar até a mensagem
                originalMessageElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }
        
        async function createMessageElement(message, messageKey, chatType) {
            const messageElement = document.createElement('div');
            messageElement.dataset.senderNickname = message.senderNickname;
            messageElement.dataset.messageId = messageKey; 
            messageElement.classList.add('message-container'); 
            
            const userInfoDiv = document.createElement('div');
            userInfoDiv.classList.add('user-info');
            
            const avatarImg = createAvatarElement(message.senderProfilePic, message.senderNickname, 40);
            avatarImg.classList.add('message-avatar');
            avatarImg.addEventListener('click', () => {
                if (message.senderNickname !== currentUserNickname) {
                    showVisitProfileScreen(message.senderNickname);
                } else {
                    showProfileScreen();
                }
            });
            
            const nicknameSpan = document.createElement('span');
            nicknameSpan.classList.add('user-nickname');
            nicknameSpan.textContent = message.senderNickname || 'ANÔNIMO';

            if (message.senderNickname === STIA_NAME) {
                const stiaBadge = document.createElement('span');
                stiaBadge.className = 'stia-badge';
                stiaBadge.textContent = 'IA';
                nicknameSpan.appendChild(stiaBadge);
                messageElement.classList.add('stia-message');
            }

            const senderProfile = allUsersData[message.senderNickname];
            const senderAdminLevel = (senderProfile && senderProfile.adminLevel) || 0;
            const senderIsAdminInChat = message.senderNickname === 'STEVEST' || senderAdminLevel > 0;
            
            if (senderIsAdminInChat) {
                const adminCrownHtml = getAdminCrown(message.senderNickname, senderAdminLevel);
                if (adminCrownHtml) {
                    nicknameSpan.insertAdjacentHTML("beforeend", adminCrownHtml);
                }
            }
            
            userInfoDiv.appendChild(avatarImg);
            userInfoDiv.appendChild(nicknameSpan);
            
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble');
            if (message.isSystemMessage) {
                messageBubble.classList.add('system-message');
            }
            
            if (message.replyTo) {
                const replyContainer = document.createElement('div');
                replyContainer.classList.add('reply-container');
                
                const replyHeader = document.createElement('div');
                replyHeader.classList.add('reply-header');
                replyHeader.innerHTML = '<div class="reply-header-text"><i class="fas fa-reply"></i> RESPONDENDO</div>';
                replyContainer.appendChild(replyHeader);
                
                const replyContent = document.createElement('div');
                replyContent.classList.add('reply-content');
                
                // Adicionar evento de clique para navegar até a mensagem original
                replyContent.addEventListener('click', () => {
                    scrollToOriginalMessage(message.replyTo, chatType);
                });
                
                let originalMessageSnapshot;
                if (chatType === 'main') {
                    originalMessageSnapshot = await messagesRef.child(message.replyTo).once('value');
                } else if (chatType === 'private' && currentPrivateChatUser) {
                    const chatKey = getPrivateChatKey(currentUserNickname, currentPrivateChatUser);
                    originalMessageSnapshot = await privateMessagesRef.child(chatKey).child(message.replyTo).once('value');
                }
                
                const originalMessageData = originalMessageSnapshot ? originalMessageSnapshot.val() : null;
                
                if (originalMessageData) {
                    const replyText = document.createElement('div');
                    replyText.classList.add('reply-text');
                    
                    if (originalMessageData.mediaType === 'image') {
                        const replyMedia = document.createElement('img');
                        replyMedia.src = originalMessageData.mediaUrl;
                        replyMedia.classList.add('reply-media');
                        replyMedia.alt = 'IMAGEM';
                        replyText.textContent = `${originalMessageData.senderNickname}: `;
                        replyContent.appendChild(replyText);
                        replyContent.appendChild(replyMedia);
                    } else if (originalMessageData.mediaType === 'video') {
                        const replyMediaIcon = document.createElement('div');
                        replyMediaIcon.classList.add('reply-media-icon', 'video');
                        replyMediaIcon.innerHTML = '<i class="fas fa-video"></i>';
                        replyText.textContent = `${originalMessageData.senderNickname}: VÍDEO`;
                        replyContent.appendChild(replyText);
                        replyContent.appendChild(replyMediaIcon);
                    } else if (originalMessageData.text) {
                        replyText.textContent = `${originalMessageData.senderNickname}: ${originalMessageData.text}`;
                        replyContent.appendChild(replyText);
                    }
                }
                
                replyContainer.appendChild(replyContent);
                messageBubble.appendChild(replyContainer);
            }
            
            if (message.mediaUrl && message.mediaType) {
                const mediaContainer = document.createElement('div');
                mediaContainer.classList.add('media-container');
                
                if (message.mediaType === 'image') {
                    const img = document.createElement('img');
                    img.src = message.mediaUrl;
                    img.classList.add('media-thumbnail');
                    img.alt = 'IMAGEM';
                    img.style.width = '150px';
                    img.style.height = '150px';
                    img.style.objectFit = 'cover';
                    img.addEventListener('click', () => openMediaViewer(message.mediaUrl, 'image'));
                    mediaContainer.appendChild(img);
                } else if (message.mediaType === 'video') {
                    const video = document.createElement('video');
                    video.src = message.mediaUrl;
                    video.classList.add('media-thumbnail');
                    video.controls = true;
                    video.autoplay = false;
                    video.muted = true; 
                    video.loop = false;
                    video.setAttribute('playsinline', ''); 
                    video.preload = 'metadata'; 
                    video.style.width = '150px';
                    video.style.height = '150px';
                    video.style.objectFit = 'cover';
                    video.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        openMediaViewer(message.mediaUrl, 'video');
                    });
                    
                    const source = document.createElement('source');
                    source.src = message.mediaUrl;
                    source.type = message.mediaType;
                    video.appendChild(source);
                    mediaContainer.appendChild(video);
                }
                
                messageBubble.appendChild(mediaContainer);
                
                const downloadButton = document.createElement('button');
                downloadButton.classList.add('download-media-button');
                downloadButton.innerHTML = '<i class="fas fa-download"></i>';
                downloadButton.title = 'BAIXAR MÍDIA';
                downloadButton.style.display = 'none';
                downloadButton.addEventListener('click', () => {
                    const link = document.createElement('a');
                    link.href = message.mediaUrl;
                    link.download = `chat_media_${messageKey}.${message.mediaType === 'image' ? 'png' : 'mp4'}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
                
                messageBubble.appendChild(downloadButton);
            }
            
            const messageText = document.createElement('div');
            if (message.text) { 
                messageText.textContent = message.text;
                messageBubble.appendChild(messageText);
            }
            
            const messageTime = document.createElement('div');
            messageTime.classList.add('message-time');
            const date = new Date(message.timestamp);
            messageTime.textContent = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageBubble.appendChild(messageTime);
            
            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-message-button');
            deleteButton.innerHTML = '<i class="fas fa-times"></i>'; 
            deleteButton.style.display = 'none'; 
            
            if (message.senderNickname === currentUserNickname || currentUserIsAdmin || currentUserNickname === 'STEVEST') {
                deleteButton.style.display = 'flex'; 
                deleteButton.addEventListener('click', () => deleteMessage(messageKey, message.senderNickname, chatType));
            }
            
            messageBubble.appendChild(deleteButton);
            
            const replyButton = document.createElement('button');
            replyButton.classList.add('reply-message-button');
            replyButton.innerHTML = '<i class="fas fa-reply"></i>';
            replyButton.title = 'RESPONDER';
            replyButton.style.display = 'none';
            
            replyButton.addEventListener('click', () => {
                const originalText = message.text || (message.mediaType === 'image' ? 'IMAGEM' : message.mediaType === 'video' ? 'VÍDEO' : 'MÍDIA');
                if (chatType === 'main') {
                    setupReply(messageKey, message.senderNickname, originalText, message.mediaType, message.mediaUrl);
                } else if (chatType === 'private') {
                    setupPrivateReply(messageKey, message.senderNickname, originalText, message.mediaType, message.mediaUrl);
                }
            });
            
            messageBubble.appendChild(replyButton);
            
            messageElement.appendChild(userInfoDiv);
            messageElement.appendChild(messageBubble);
            
            if (message.replyTo) {
                messageBubble.classList.add('has-reply');
            }
            
            return messageElement;
        }
        
        messagesRef.once('value').then(() => {
            stiaMonitoringEnabled = true;
        });

        messagesRef.orderByChild('timestamp').on('child_added', async (snapshot) => {
            if (chatMain.classList.contains('hidden')) return;

            const messageKey = snapshot.key;
            const messageData = snapshot.val();
            
            if (chatMessagesMap.has(messageKey)) return;
            
            const messageElement = await createMessageElement(messageData, messageKey, 'main');
            chatMessages.appendChild(messageElement);
            chatMessagesMap.set(messageKey, messageElement);
            applyMessagePositioning(messageElement, messageData.senderNickname);
            
            if (mainChatUserAtBottom) {
                scrollToBottom(chatMessages);
            } else {
                mainChatUnreadCount++;
                updateNewMessagesIndicator();
            }

            if (stiaMonitoringEnabled) {
                handleStiaBehaviors(messageData, messageKey).catch(error => {
                    console.error('STIA: erro ao executar ações automáticas.', error);
                });
            }
        });
        
        messagesRef.on('child_changed', async (snapshot) => {
            if (chatMain.classList.contains('hidden')) return;
            
            const messageKey = snapshot.key;
            const newMessageData = snapshot.val();
            
            const existingElement = chatMessagesMap.get(messageKey);
            if (existingElement) {
                existingElement.remove();
                chatMessagesMap.delete(messageKey);
                
                const updatedElement = await createMessageElement(newMessageData, messageKey, 'main');
                chatMessages.appendChild(updatedElement);
                chatMessagesMap.set(messageKey, updatedElement);
                applyMessagePositioning(updatedElement, newMessageData.senderNickname);
                
                if (mainChatUserAtBottom) {
                    scrollToBottom(chatMessages);
                }
            }
        });
        
        messagesRef.on('child_removed', (snapshot) => {
            if (chatMain.classList.contains('hidden')) return;
            
            const messageKey = snapshot.key;
            const removedMessageElement = chatMessagesMap.get(messageKey);
            
            if (removedMessageElement) {
                removedMessageElement.remove();
                chatMessagesMap.delete(messageKey);
            }
        });
        
        function getPrivateChatKey(user1, user2) {
            return user1 < user2 ? `${user1}_${user2}` : `${user2}_${user1}`;
        }
        
        function loadPrivateMessages() {
            if (!currentPrivateChatUser) return;
            
            const chatKey = getPrivateChatKey(currentUserNickname, currentPrivateChatUser);
            const privateChatRef = privateMessagesRef.child(chatKey);
            
            if (privateMessagesRef.currentPrivateChatRef) {
                privateMessagesRef.currentPrivateChatRef.off();
            }
            
            privateMessagesRef.currentPrivateChatRef = privateChatRef;
            
            privateChatMessages.innerHTML = '';
            privateChatMessagesMap.clear();
            
            privateChatRef.orderByChild('timestamp').on('child_added', async (snapshot) => {
                const messageKey = snapshot.key;
                const messageData = snapshot.val();
                
                if (privateChatMessagesMap.has(messageKey)) return;
                
                const messageElement = await createMessageElement(messageData, messageKey, 'private');
                privateChatMessages.appendChild(messageElement);
                privateChatMessagesMap.set(messageKey, messageElement);
                applyMessagePositioning(messageElement, messageData.senderNickname);
                
                if (privateChatUserAtBottom) {
                    scrollToBottom(privateChatMessages);
                } else {
                    privateChatUnreadCount++;
                    updatePrivateNewMessagesIndicator();
                }
            });
            
            privateChatRef.orderByChild('timestamp').on('child_changed', async (snapshot) => {
                const messageKey = snapshot.key;
                const newMessageData = snapshot.val();
                
                const existingElement = privateChatMessagesMap.get(messageKey);
                if (existingElement) {
                    existingElement.remove();
                    privateChatMessagesMap.delete(messageKey);
                    
                    const updatedElement = await createMessageElement(newMessageData, messageKey, 'private');
                    privateChatMessages.appendChild(updatedElement);
                    privateChatMessagesMap.set(messageKey, updatedElement);
                    applyMessagePositioning(updatedElement, newMessageData.senderNickname);
                    
                    if (privateChatUserAtBottom) {
                        scrollToBottom(privateChatMessages);
                    }
                }
            });
            
            privateChatRef.orderByChild('timestamp').on('child_removed', (snapshot) => {
                const messageKey = snapshot.key;
                const removedMessageElement = privateChatMessagesMap.get(messageKey);
                
                if (removedMessageElement) {
                    removedMessageElement.remove();
                    privateChatMessagesMap.delete(messageKey);
                }
            });
        }
        
        function reevaluateMessagePositions() {
            chatMessagesMap.forEach((messageElement, messageKey) => {
                const senderNickname = messageElement.dataset.senderNickname;
                applyMessagePositioning(messageElement, senderNickname);
            });
            
            if (!privateChat.classList.contains('hidden') && currentPrivateChatUser) {
                privateChatMessagesMap.forEach((messageElement, messageKey) => {
                    const senderNickname = messageElement.dataset.senderNickname;
                    applyMessagePositioning(messageElement, senderNickname);
                });
            }
        }
        
        function updateProfileScreenUI() {
            if (currentUserNickname !== 'USUÁRIO ANÔNIMO') {
                nicknameInput.value = currentUserNickname;
                passwordInput.value = currentUserPassword;
                displayNickname.textContent = currentUserNickname;
                
                // Adicionar status de administrador ao nome de exibição
                addAdminStatusToNickname(displayNickname, currentUserNickname, currentUserAdminLevel);
                
                const cachedProfile = userProfilesCache[currentUserNickname];
                const profilePicFromCache = cachedProfile ? cachedProfile.profilePicture : DEFAULT_PROFILE_PIC;
                const profileCoverFromCache = cachedProfile ? cachedProfile.profileCover : DEFAULT_PROFILE_COVER;
                
                if (profilePicFromCache && profilePicFromCache !== DEFAULT_PROFILE_PIC) {
                    profilePic.style.backgroundImage = `url(${profilePicFromCache})`;
                    profilePic.style.backgroundSize = 'cover';
                    profilePic.style.backgroundPosition = 'center';
                    profilePic.textContent = '';
                } else {
                    generateAvatarWithInitial(currentUserNickname, profilePic);
                }
                
                if (profileCoverFromCache && profileCoverFromCache !== DEFAULT_PROFILE_COVER) {
                    profileCover.style.backgroundImage = `url(${profileCoverFromCache})`;
                    profileCover.style.backgroundSize = 'cover';
                    profileCover.style.backgroundPosition = 'center';
                } else {
                    profileCover.style.backgroundImage = '';
                    profileCover.style.background = 'linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%)';
                }
                
                // Atualizar o botão de bloqueio/desbloqueio de mensagens privadas
                if (isPrivateMessagesLocked) {
                    togglePrivateMessagesBtn.innerHTML = '<i class="fas fa-lock mr-2"></i>CHAT 🔒';
                    togglePrivateMessagesBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                } else {
                    togglePrivateMessagesBtn.innerHTML = '<i class="fas fa-unlock mr-2"></i>CHAT 🔓';
                    togglePrivateMessagesBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                }
                
                // Adicionar aviso Premium se o usuário não for Premium
                if (!currentUserIsPremium) {
                    // Verificar se já existe um aviso Premium
                    let premiumNotice = document.querySelector('.premium-notice');
                    if (!premiumNotice) {
                        premiumNotice = document.createElement('div');
                        premiumNotice.className = 'premium-notice';
                        premiumNotice.innerHTML = '<i class="fas fa-star premium-notice-icon"></i> TORNE-SE USUÁRIO PREMIUM PARA USAR GIFS NO SEU PERFIL! <i class="fas fa-star premium-notice-icon"></i>';
                        
                        // Inserir o aviso antes do formulário de perfil
                        const profileForm = document.querySelector('.profile-form-group');
                        if (profileForm) {
                            profileForm.parentNode.insertBefore(premiumNotice, profileForm);
                        }
                    }
                } else {
                    // Remover o aviso Premium se o usuário for Premium
                    const premiumNotice = document.querySelector('.premium-notice');
                    if (premiumNotice) {
                        premiumNotice.remove();
                    }
                }
                
                nicknameInput.style.display = 'block';
                passwordInput.style.display = 'block';
                rememberMeCheckbox.style.display = 'block';
                // Ocultar o botão SALVAR PERFIL quando o usuário já estiver logado
                saveProfileBtn.style.display = 'none';
                togglePrivateMessagesBtn.style.display = 'block';
                logoutButton.style.display = 'block';
                displayNickname.style.display = 'block';
                
                // Carregar o estado da caixa "Lembrar de mim" do Firebase
                loadRememberMeState();
            } else {
                nicknameInput.value = '';
                passwordInput.value = '';
                nicknameInput.style.display = 'block';
                passwordInput.style.display = 'block';
                rememberMeCheckbox.style.display = 'block';
                // Mostrar o botão SALVAR PERFIL quando o usuário não estiver logado
                saveProfileBtn.style.display = 'block';
                togglePrivateMessagesBtn.style.display = 'none';
                logoutButton.style.display = 'none';
                displayNickname.style.display = 'none';
                
                profilePic.style.backgroundImage = '';
                profilePic.textContent = '?';
                profilePic.style.background = 'linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%)';
                
                profileCover.style.backgroundImage = '';
                profileCover.style.background = 'linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%)';
                
                // Remover o aviso Premium se existir
                const premiumNotice = document.querySelector('.premium-notice');
                if (premiumNotice) {
                    premiumNotice.remove();
                }
                
                // Desmarcar a caixa "Lembrar de mim" quando o usuário não estiver logado
                rememberMeCheckbox.checked = false;
                rememberMeState = false;
            }

            updateStevestProfileButtonState();
            updateStiaProfileEditorUI();
        }
        
        // Função para carregar o estado da caixa "Lembrar de mim" do Firebase
        function loadRememberMeState() {
            if (currentUserNickname === 'USUÁRIO ANÔNIMO') return;
            
            usersProfileRef.child(currentUserNickname).child('rememberMe').once('value')
                .then(snapshot => {
                    const savedState = snapshot.val();
                    if (savedState !== null) {
                        rememberMeState = savedState;
                        rememberMeCheckbox.checked = savedState;
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar estado da caixa "Lembrar de mim":', error);
                });
        }
        
        // Função para salvar o estado da caixa "Lembrar de mim" no Firebase
        function saveRememberMeState() {
            if (currentUserNickname === 'USUÁRIO ANÔNIMO') return;
            
            usersProfileRef.child(currentUserNickname).update({
                rememberMe: rememberMeState
            })
            .then(() => {
                console.log('Estado da caixa "Lembrar de mim" salvo com sucesso');
            })
            .catch(error => {
                console.error('Erro ao salvar estado da caixa "Lembrar de mim":', error);
            });
        }
        
        // Event listener para a caixa "Lembrar de mim"
        rememberMeCheckbox.addEventListener('change', () => {
            rememberMeState = rememberMeCheckbox.checked;
            saveRememberMeState();
        });
        
        // Função para excluir a foto de perfil anterior do storage
        async function deleteOldProfilePicture(oldProfilePicUrl) {
            // Não tentar excluir se for a imagem padrão
            if (!oldProfilePicUrl || oldProfilePicUrl === DEFAULT_PROFILE_PIC) {
                return;
            }
            
            try {
                const fileRef = storage.refFromURL(oldProfilePicUrl);
                await fileRef.delete();
                console.log('Foto de perfil anterior excluída do storage:', oldProfilePicUrl);
            } catch (error) {
                console.error('Erro ao excluir foto de perfil anterior do storage:', error);
                // Não mostrar erro ao usuário, pois isso não deve interromper o fluxo principal
            }
        }
        
        function handleProfileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const newProfilePicData = e.target.result;
                    
                    // Armazenar a URL da foto anterior para exclusão posterior
                    const oldProfilePicUrl = currentUserProfilePic;
                    
                    showUploadProgressModal();
                    uploadPercentageText.textContent = 'CARREGANDO FOTO...';
                    uploadProgressBar.style.width = '50%';
                    
                    // Upload da nova foto para o storage
                    const fileName = `profile_pics/${currentUserNickname}_${Date.now()}`;
                    const storageRef = storage.ref(fileName);
                    const uploadTask = storageRef.putString(newProfilePicData, 'data_url');
                    
                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            uploadPercentageText.textContent = `${Math.round(progress)}%`;
                            uploadProgressBar.style.width = `${progress}%`;
                        }, 
                        (error) => {
                            console.error("ERRO NO UPLOAD DE FOTO DE PERFIL: ", error);
                            showAlertModal('ERRO', 'ERRO AO ENVIAR FOTO DE PERFIL.', 'fas fa-times-circle', 'error');
                            hideUploadProgressModal();
                        }, 
                        async () => {
                            try {
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                
                                // Atualizar o banco de dados com a nova URL
                                await database.ref(`users/profile/${currentUserNickname}`).update({
                                    profilePicture: downloadURL
                                });
                                
                                // Excluir a foto anterior do storage
                                await deleteOldProfilePicture(oldProfilePicUrl);
                                
                                // Atualizar cache e variáveis locais
                                userProfilesCache[currentUserNickname] = userProfilesCache[currentUserNickname] || {};
                                userProfilesCache[currentUserNickname].profilePicture = downloadURL;
                                currentUserProfilePic = downloadURL;
                                
                                // Atualizar UI
                                updateProfileScreenUI();
                                updateUserAvatars(currentUserNickname, downloadURL);
                                
                                hideUploadProgressModal();
                                showAlertModal('SUCESSO!', 'FOTO DE PERFIL ATUALIZADA!', 'fas fa-check-circle', 'success');
                            } catch (error) {
                                console.error("ERRO AO ATUALIZAR FOTO DE PERFIL: ", error);
                                hideUploadProgressModal();
                                showAlertModal('ERRO', 'ERRO AO ATUALIZAR FOTO DE PERFIL.', 'fas fa-times-circle', 'error');
                            }
                        }
                    );
                };
                reader.readAsDataURL(file);
            }
        }
        
        function handleProfileCoverUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const newProfileCoverData = e.target.result;
                    
                    // Armazenar a URL da capa anterior para exclusão posterior
                    const oldProfileCoverUrl = currentUserProfileCover;
                    
                    showUploadProgressModal();
                    uploadPercentageText.textContent = 'CARREGANDO CAPA...';
                    uploadProgressBar.style.width = '50%';
                    
                    // Upload da nova capa para o storage
                    const fileName = `profile_covers/${currentUserNickname}_${Date.now()}`;
                    const storageRef = storage.ref(fileName);
                    const uploadTask = storageRef.putString(newProfileCoverData, 'data_url');
                    
                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            uploadPercentageText.textContent = `${Math.round(progress)}%`;
                            uploadProgressBar.style.width = `${progress}%`;
                        }, 
                        (error) => {
                            console.error("ERRO NO UPLOAD DE CAPA DE PERFIL: ", error);
                            showAlertModal('ERRO', 'ERRO AO ENVIAR CAPA DE PERFIL.', 'fas fa-times-circle', 'error');
                            hideUploadProgressModal();
                        }, 
                        async () => {
                            try {
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                
                                // Atualizar o banco de dados com a nova URL
                                await database.ref(`users/profile/${currentUserNickname}`).update({
                                    profileCover: downloadURL
                                });
                                
                                // Excluir a capa anterior do storage
                                await deleteOldProfilePicture(oldProfileCoverUrl);
                                
                                // Atualizar cache e variáveis locais
                                userProfilesCache[currentUserNickname] = userProfilesCache[currentUserNickname] || {};
                                userProfilesCache[currentUserNickname].profileCover = downloadURL;
                                currentUserProfileCover = downloadURL;
                                
                                // Atualizar UI
                                updateProfileScreenUI();
                                
                                hideUploadProgressModal();
                                showAlertModal('SUCESSO!', 'CAPA DE PERFIL ATUALIZADA!', 'fas fa-check-circle', 'success');
                            } catch (error) {
                                console.error("ERRO AO ATUALIZAR CAPA DE PERFIL: ", error);
                                hideUploadProgressModal();
                                showAlertModal('ERRO', 'ERRO AO ATUALIZAR CAPA DE PERFIL.', 'fas fa-times-circle', 'error');
                            }
                        }
                    );
                };
                reader.readAsDataURL(file);
            }
        }
        
        profileUpload.addEventListener('change', handleProfileUpload);
        profileCoverUpload.addEventListener('change', handleProfileCoverUpload);
        if (stiaProfileUploadInput) {
            stiaProfileUploadInput.addEventListener('change', handleStiaProfilePhotoUpload);
        }
        if (stiaProfileCoverUploadInput) {
            stiaProfileCoverUploadInput.addEventListener('change', handleStiaProfileCoverUpload);
        }

        // Função para alternar o bloqueio de mensagens privadas
        async function togglePrivateMessagesLock() {
            if (currentUserNickname === 'USUÁRIO ANÔNIMO') {
                await showAlertModal('LOGIN NECESSÁRIO', 'VOCÊ PRECISA FAZER LOGIN PARA ALTERAR SUAS CONFIGURAÇÕES DE PRIVACIDADE.', 'fas fa-user-circle', 'info');
                return;
            }
            
            const newLockStatus = !isPrivateMessagesLocked;
            const actionText = newLockStatus ? 'BLOQUEAR' : 'DESBLOQUEAR';
            
            const confirmed = await showConfirmModal(
                `${actionText} MENSAGENS PRIVADAS`,
                `TEM CERTEZA QUE DESEJA ${actionText} MENSAGENS PRIVADAS? ${newLockStatus ? 'APENAS ADMINISTRADORES PODERÃO ENVIAR MENSAGENS PARA VOCÊ.' : 'QUALQUER USUÁRIO PODERÁ ENVIAR MENSAGENS PARA VOCÊ.'}`,
                newLockStatus ? 'fas fa-lock' : 'fas fa-unlock',
                'warning'
            );
            
            if (confirmed) {
                try {
                    await usersProfileRef.child(currentUserNickname).update({
                        privateMessagesLocked: newLockStatus
                    });
                    
                    isPrivateMessagesLocked = newLockStatus;
                    
                    // Adicionar notícia sobre a alteração
                    addNewsItem(currentUserNickname, newLockStatus ? 'lock_private' : 'unlock_private', currentUserNickname);
                    
                    await showAlertModal('SUCESSO!', `MENSAGENS PRIVADAS ${actionText}ADAS COM SUCESSO!`, 'fas fa-check-circle', 'success');
                    
                    updateProfileScreenUI();
                } catch (error) {
                    console.error(`ERRO AO ${actionText} MENSAGENS PRIVADAS:`, error);
                    await showAlertModal('ERRO', `ERRO AO ${actionText} MENSAGENS PRIVADAS. TENTE NOVAMENTE.`, 'fas fa-times-circle', 'error');
                }
            }
        }

        async function handleStiaProfilePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (currentUserNickname !== STIA_PROTECTED_OWNER) {
                await showAlertModal('ACESSO NEGADO', 'Somente o STEVEST pode alterar a foto da STIA.', 'fas fa-robot', 'error');
                event.target.value = '';
                return;
            }

            if (!stiaOwnProfilePhotoUnlocked) {
                await showAlertModal('BLOQUEADO', 'Peça para a STIA liberar o botão de foto antes de enviar a nova imagem dela.', 'fas fa-lock', 'warning');
                event.target.value = '';
                return;
            }

            const inputRef = event.target;
            const reader = new FileReader();
            reader.onload = function(e) {
                const newPhotoData = e.target.result;
                const oldPhotoUrl = (allUsersData[STIA_NAME]?.profilePicture) || DEFAULT_PROFILE_PIC;

                showUploadProgressModal();
                uploadPercentageText.textContent = 'ENVIANDO NOVA FOTO DA STIA...';
                uploadProgressBar.style.width = '0%';

                const fileName = `profile_pics/${STIA_NAME}_${Date.now()}`;
                const storageRef = storage.ref(fileName);
                const uploadTask = storageRef.putString(newPhotoData, 'data_url');

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        uploadPercentageText.textContent = `${Math.round(progress)}%`;
                        uploadProgressBar.style.width = `${progress}%`;
                    },
                    async (error) => {
                        console.error('ERRO AO ENVIAR FOTO DA STIA: ', error);
                        await showAlertModal('ERRO', 'Não foi possível atualizar a foto da STIA.', 'fas fa-times-circle', 'error');
                        hideUploadProgressModal();
                        inputRef.value = '';
                    },
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            await usersProfileRef.child(STIA_NAME).update({
                                profilePicture: downloadURL
                            });

                            await deleteOldProfilePicture(oldPhotoUrl);

                            userProfilesCache[STIA_NAME] = userProfilesCache[STIA_NAME] || {};
                            userProfilesCache[STIA_NAME].profilePicture = downloadURL;
                            allUsersData[STIA_NAME] = allUsersData[STIA_NAME] || { nickname: STIA_NAME };
                            allUsersData[STIA_NAME].profilePicture = downloadURL;

                            updateUserAvatars(STIA_NAME, downloadURL);
                            updateStiaProfileEditorUI();

                            hideUploadProgressModal();
                            await showAlertModal('STIA ATUALIZADA', 'A foto da STIA foi atualizada com sucesso!', 'fas fa-robot', 'success');
                        } catch (error) {
                            console.error('ERRO AO ATUALIZAR FOTO DA STIA: ', error);
                            hideUploadProgressModal();
                            await showAlertModal('ERRO', 'Erro ao atualizar a foto da STIA.', 'fas fa-times-circle', 'error');
                        } finally {
                            inputRef.value = '';
                        }
                    }
                );
            };

            reader.readAsDataURL(file);
        }

        async function handleStiaProfileCoverUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (currentUserNickname !== STIA_PROTECTED_OWNER) {
                await showAlertModal('ACESSO NEGADO', 'Somente o STEVEST pode alterar a capa da STIA.', 'fas fa-robot', 'error');
                event.target.value = '';
                return;
            }

            if (!stiaOwnProfileCoverUnlocked) {
                await showAlertModal('BLOQUEADO', 'Peça para a STIA liberar o botão da capa antes de enviar a nova imagem dela.', 'fas fa-lock', 'warning');
                event.target.value = '';
                return;
            }

            const inputRef = event.target;
            const reader = new FileReader();
            reader.onload = function(e) {
                const newCoverData = e.target.result;
                const oldCoverUrl = (allUsersData[STIA_NAME]?.profileCover) || DEFAULT_PROFILE_COVER;

                showUploadProgressModal();
                uploadPercentageText.textContent = 'ENVIANDO NOVA CAPA DA STIA...';
                uploadProgressBar.style.width = '0%';

                const fileName = `profile_covers/${STIA_NAME}_${Date.now()}`;
                const storageRef = storage.ref(fileName);
                const uploadTask = storageRef.putString(newCoverData, 'data_url');

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        uploadPercentageText.textContent = `${Math.round(progress)}%`;
                        uploadProgressBar.style.width = `${progress}%`;
                    },
                    async (error) => {
                        console.error('ERRO AO ENVIAR CAPA DA STIA: ', error);
                        await showAlertModal('ERRO', 'Não foi possível atualizar a capa da STIA.', 'fas fa-times-circle', 'error');
                        hideUploadProgressModal();
                        inputRef.value = '';
                    },
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            await usersProfileRef.child(STIA_NAME).update({
                                profileCover: downloadURL
                            });

                            await deleteOldProfilePicture(oldCoverUrl);

                            userProfilesCache[STIA_NAME] = userProfilesCache[STIA_NAME] || {};
                            userProfilesCache[STIA_NAME].profileCover = downloadURL;
                            allUsersData[STIA_NAME] = allUsersData[STIA_NAME] || { nickname: STIA_NAME };
                            allUsersData[STIA_NAME].profileCover = downloadURL;

                            updateStiaProfileEditorUI();

                            hideUploadProgressModal();
                            await showAlertModal('STIA ATUALIZADA', 'A capa da STIA foi atualizada com sucesso!', 'fas fa-robot', 'success');
                        } catch (error) {
                            console.error('ERRO AO ATUALIZAR CAPA DA STIA: ', error);
                            hideUploadProgressModal();
                            await showAlertModal('ERRO', 'Erro ao atualizar a capa da STIA.', 'fas fa-times-circle', 'error');
                        } finally {
                            inputRef.value = '';
                        }
                    }
                );
            };

            reader.readAsDataURL(file);
        }

        togglePrivateMessagesBtn.addEventListener('click', togglePrivateMessagesLock);
        
        async function handleSaveProfile() {
            const nickname = nicknameInput.value.trim();
            const password = passwordInput.value.trim();
            const rememberMe = rememberMeCheckbox.checked;
            
            if (!nickname) {
                await showAlertModal('CAMPO VAZIO', 'POR FAVOR, DIGITE UM APELIDO.', 'fas fa-exclamation-triangle', 'warning');
                return;
            }
            
            const snapshot = await database.ref(`users/profile/${nickname}`).once('value');
            const userData = snapshot.val();
            
            if (userData) {
                passwordInput.style.display = 'block';
                passwordInput.placeholder = 'DIGITE SUA SENHA';
                
                if (!password) {
                    await showAlertModal('APELIDO EXISTENTE', 'APELIDO EXISTENTE. POR FAVOR, DIGITE SUA SENHA PARA CONFIRMAR.', 'fas fa-exclamation-circle', 'info');
                    return;
                }
                
                if (userData.password === password) {
                    currentUserNickname = nickname;
                    currentUserPassword = password;
                    currentUserProfilePic = userData.profilePicture || DEFAULT_PROFILE_PIC;
                    currentUserProfileCover = userData.profileCover || DEFAULT_PROFILE_COVER;
                    currentUserIsAdmin = userData.isAdmin || false; 
                    currentUserAdminLevel = nickname === 'STEVEST' ? 6 : (userData.adminLevel || 0);
                    isPrivateMessagesLocked = userData.privateMessagesLocked !== false; // Por padrão é true (bloqueado)
                    currentUserIsPremium = userData.isPremium || false;
                    currentUserPremiumExpiry = userData.premiumExpiry || null;
                    resetStevestProfileButtonUnlocks();

                    // Verificar se o Premium expirou
                    if (currentUserIsPremium && currentUserPremiumExpiry) {
                        const now = Date.now();
                        if (currentUserPremiumExpiry < now) {
                            // Premium expirou, atualizar no banco de dados
                            await usersProfileRef.child(currentUserNickname).update({
                                isPremium: false,
                                premiumExpiry: null
                            });
                            
                            currentUserIsPremium = false;
                            currentUserPremiumExpiry = null;
                        }
                    }
                    
                    // Salvar no localStorage se "Lembrar de mim" estiver marcado
                    if (rememberMe) {
                        localStorage.setItem('chat_nickname', nickname);
                        localStorage.setItem('chat_password', password);
                    } else {
                        localStorage.removeItem('chat_nickname');
                        localStorage.removeItem('chat_password');
                    }
                    
                    // Salvar o estado da caixa "Lembrar de mim" no Firebase
                    rememberMeState = rememberMe;
                    saveRememberMeState();
                    
                    await showAlertModal('SUCESSO!', 'LOGIN REALIZADO COM SUCESSO!', 'fas fa-sign-in-alt', 'success');
                    updateProfileScreenUI();
                    updateMainUI();
                    reevaluateMessagePositions(); 
                    
                    // Configurar sistema de presença após o login
                    setupUserPresence();
                } else {
                    await showAlertModal('SENHA INCORRETA', 'SENHA INCORRETA. POR FAVOR, TENTE NOVAMENTE.', 'fas fa-times-circle', 'error');
                    passwordInput.value = '';
                }
            } else {
                passwordInput.style.display = 'block';
                passwordInput.placeholder = 'CRIE SUA SENHA';
                
                if (!password) {
                    await showAlertModal('CRIAR SENHA', 'APELIDO NÃO ENCONTRADO. POR FAVOR, CRIE UMA SENHA PARA ESTE APELIDO.', 'fas fa-key', 'info');
                    return;
                }
                
                database.ref(`users/profile/${nickname}`).set({
                    nickname: nickname,
                    password: password,
                    profilePicture: DEFAULT_PROFILE_PIC,
                    profileCover: DEFAULT_PROFILE_COVER,
                    isBanned: false, 
                    mutedUntil: 0,
                    isAdmin: false,
                    adminLevel: 0,
                    isBannedByStevest: false,
                    isMutedByStevest: false,
                    privateMessagesLocked: true, // Por padrão, mensagens privadas são bloqueadas
                    isPremium: false,
                    premiumExpiry: null,
                    rememberMe: rememberMe // Salvar o estado da caixa "Lembrar de mim"
                }).then(async () => {
                    await showAlertModal('SUCESSO!', 'PERFIL CRIADO E SALVO COM SUCESSO!', 'fas fa-user-plus', 'success');
                    currentUserNickname = nickname;
                    currentUserPassword = password;
                    currentUserProfilePic = DEFAULT_PROFILE_PIC;
                    currentUserProfileCover = DEFAULT_PROFILE_COVER;
                    currentUserIsAdmin = false; 
                    currentUserAdminLevel = 0;
                    isPrivateMessagesLocked = true; // Por padrão, mensagens privadas são bloqueadas
                    currentUserIsPremium = false;
                    currentUserPremiumExpiry = null;
                    resetStevestProfileButtonUnlocks();
                    
                    // Salvar no localStorage se "Lembrar de mim" estiver marcado
                    if (rememberMe) {
                        localStorage.setItem('chat_nickname', nickname);
                        localStorage.setItem('chat_password', password);
                    } else {
                        localStorage.removeItem('chat_nickname');
                        localStorage.removeItem('chat_password');
                    }
                    
                    // Salvar o estado da caixa "Lembrar de mim" no Firebase
                    rememberMeState = rememberMe;
                    saveRememberMeState();
                    
                    updateProfileScreenUI();
                    updateMainUI();
                    reevaluateMessagePositions();
                    
                    // Configurar sistema de presença após o registro
                    setupUserPresence();
                }).catch(async (error) => {
                    console.error("ERRO AO SALVAR PERFIL: ", error);
                    await showAlertModal('ERRO', 'ERRO AO SALVAR PERFIL.', 'fas fa-times-circle', 'error');
                });
            }
        }
        
        saveProfileBtn.addEventListener('click', handleSaveProfile);
        
        async function logoutUser() {
            const confirmed = await showConfirmModal(
                'SAIR',
                'VOCÊ REALMENTE QUER SAIR?',
                'fas fa-question-circle', 'info'
            );
            
            if (confirmed) {
                // Remover status online ao fazer logout
                if (userStatusRef && currentUserNickname !== 'USUÁRIO ANÔNIMO') {
                    userStatusRef.remove();
                }
                
                localStorage.removeItem('chat_nickname');
                localStorage.removeItem('chat_password');
                currentUserNickname = 'USUÁRIO ANÔNIMO';
                currentUserPassword = '';
                currentUserProfilePic = DEFAULT_PROFILE_PIC;
                currentUserProfileCover = DEFAULT_PROFILE_COVER;
                isUserMuted = false;
                currentUserIsAdmin = false; 
                currentUserAdminLevel = 0; 
                isPrivateMessagesLocked = true; // Por padrão, mensagens privadas são bloqueadas
                currentUserIsPremium = false;
                currentUserPremiumExpiry = null;
                rememberMeState = false;
                resetStevestProfileButtonUnlocks();

                await showAlertModal('DESCONECTADO', 'VOCÊ FOI DESCONECTADO.', 'fas fa-door-open', 'info');
                updateProfileScreenUI();
                updateMainUI();
                reevaluateMessagePositions(); 
            }
        }
        
        logoutButton.addEventListener('click', logoutUser);
        
        function updateMainUI() {
            if (currentUserNickname !== 'USUÁRIO ANÔNIMO') {
                if (isAdminOrStevest()) {
                    adminScreenButton.classList.remove('hidden');
                    usersScreenButton.classList.remove('hidden');
                    newsHistoryScreenButton.classList.remove('hidden');
                    
                    const stevestOnlyCard = document.querySelector('.admin-card.stevest-only');
                    if (stevestOnlyCard) {
                        stevestOnlyCard.style.display = isOnlyStevest() ? 'block' : 'none';
                    }
                } else {
                    adminScreenButton.classList.add('hidden');
                    usersScreenButton.classList.remove('hidden');
                    newsHistoryScreenButton.classList.add('hidden');
                }
            } else {
                adminScreenButton.classList.add('hidden');
                usersScreenButton.classList.add('hidden');
                newsHistoryScreenButton.classList.add('hidden');
            }
            
            const inputAndButton = messageInput.parentElement.parentElement;
            const privateInputAndButton = privateMessageInput.parentElement.parentElement;
            
            if (isUserMuted || (allUsersData[currentUserNickname] && allUsersData[currentUserNickname].isBanned)) {
                inputAndButton.style.opacity = '0.5';
                inputAndButton.style.pointerEvents = 'none';
                messageInput.placeholder = isUserMuted ? 'VOCÊ ESTÁ SILENCIADO.' : 'VOCÊ ESTÁ BANIDO.';
                mediaButton.disabled = true;
                
                privateInputAndButton.style.opacity = '0.5';
                privateInputAndButton.style.pointerEvents = 'none';
                privateMessageInput.placeholder = isUserMuted ? 'VOCÊ ESTÁ SILENCIADO.' : 'VOCÊ ESTÁ BANIDO.';
                privateMediaButton.disabled = true;
            } else {
                inputAndButton.style.opacity = '1';
                inputAndButton.style.pointerEvents = 'auto';
                messageInput.placeholder = 'DIGITE SUA MENSAGEM...';
                mediaButton.disabled = false;
                
                privateInputAndButton.style.opacity = '1';
                privateInputAndButton.style.pointerEvents = 'auto';
                privateMessageInput.placeholder = 'DIGITE SUA MENSAGEM PRIVADA...';
                privateMediaButton.disabled = false;
            }
        }
        
        usersProfileRef.on('value', (snapshot) => {
            allUsersData = {}; 
            const users = [];
            
            snapshot.forEach(childSnapshot => {
                const userData = childSnapshot.val();
                if (userData.nickname) { 
                    users.push(userData);
                    userProfilesCache[userData.nickname] = {
                        profilePicture: userData.profilePicture || DEFAULT_PROFILE_PIC,
                        profileCover: userData.profileCover || DEFAULT_PROFILE_COVER,
                        nickname: userData.nickname,
                        isAdmin: userData.isAdmin || false,
                        adminLevel: userData.adminLevel || 0,
                        isBannedByStevest: userData.isBannedByStevest || false,
                        isMutedByStevest: userData.isMutedByStevest || false,
                        privateMessagesLocked: userData.privateMessagesLocked !== false, // Por padrão é true (bloqueado)
                        isPremium: userData.isPremium || false,
                        premiumExpiry: userData.premiumExpiry || null
                    };
                    allUsersData[userData.nickname] = userData; 
                }
            });
            
            if (currentUserNickname !== 'USUÁRIO ANÔNIMO') {
                const profile = allUsersData[currentUserNickname]; 
                if (profile) {
                    const currentFirebaseProfilePic = profile.profilePicture || DEFAULT_PROFILE_PIC;
                    const currentFirebaseProfileCover = profile.profileCover || DEFAULT_PROFILE_COVER;
                    if (currentUserProfilePic !== currentFirebaseProfilePic) {
                        currentUserProfilePic = currentFirebaseProfilePic;
                    }
                    if (currentUserProfileCover !== currentFirebaseProfileCover) {
                        currentUserProfileCover = currentFirebaseProfileCover;
                    }
                    displayNickname.textContent = currentUserNickname;
                    currentUserIsAdmin = profile.isAdmin || false; 
                    currentUserAdminLevel = currentUserNickname === 'STEVEST' ? 6 : (profile.adminLevel || 0); 
                    const now = Date.now();
                    isUserMuted = (profile.mutedUntil && profile.mutedUntil > now);
                    isPrivateMessagesLocked = profile.privateMessagesLocked !== false; // Por padrão é true (bloqueado)
                    
                    // Verificar status Premium
                    currentUserIsPremium = profile.isPremium || false;
                    currentUserPremiumExpiry = profile.premiumExpiry || null;
                    
                    // Verificar se o Premium expirou
                    if (currentUserIsPremium && currentUserPremiumExpiry) {
                        if (currentUserPremiumExpiry < now) {
                            // Premium expirou, atualizar no banco de dados
                            usersProfileRef.child(currentUserNickname).update({
                                isPremium: false,
                                premiumExpiry: null
                            });
                            
                            currentUserIsPremium = false;
                            currentUserPremiumExpiry = null;
                        }
                    }
                    
                    if (profile.isBanned) {
                        showAlertModal('BANIDO', 'VOCÊ ESTÁ BANIDO DO CHAT E SERÁ DESCONECTADO.', 'fas fa-gavel', 'error'); 
                        logoutUser();
                        return; 
                    }
                    updateMainUI(); 
                    updateProfileScreenUI();
                } else {
                    showAlertModal('PERFIL NÃO ENCONTRADO', 'SEU PERFIL NÃO FOI ENCONTRADO NO SERVIDOR. VOCÊ FOI DESCONECTADO.', 'fas fa-exclamation-circle', 'error');
                    logoutUser();
                }
            }
            
            chatMessagesMap.forEach((messageElement, messageKey) => {
                const senderNickname = messageElement.dataset.senderNickname;
                const avatar = messageElement.querySelector('.message-avatar');
                const nicknameSpan = messageElement.querySelector('.user-nickname');
                
                if (avatar) {
                    const senderProfile = allUsersData[senderNickname];
                    const senderProfilePic = (senderProfile && senderProfile.profilePicture) || DEFAULT_PROFILE_PIC;
                    
                    if (senderProfilePic && senderProfilePic !== DEFAULT_PROFILE_PIC) {
                        avatar.style.backgroundImage = `url(${senderProfilePic})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.style.backgroundPosition = 'center';
                        avatar.textContent = '';
                    } else {
                        generateAvatarWithInitial(senderNickname, avatar);
                    }
                    
                    // Atualizar status online/offline
                    if (onlineUsers.has(senderNickname)) {
                        avatar.classList.add('online');
                    } else {
                        avatar.classList.remove('online');
                    }
                }
                
                const existingAdminIcon = nicknameSpan.querySelector('.admin-icon');
                if (existingAdminIcon) {
                    existingAdminIcon.remove();
                }
                const senderProfile = allUsersData[senderNickname];
                const senderAdminLevel = (senderProfile && senderProfile.adminLevel) || 0;
                const senderIsAdminInChat = senderNickname === 'STEVEST' || senderAdminLevel > 0;
                
                if (senderIsAdminInChat) {
                    const adminCrownHtml = getAdminCrown(senderNickname, senderAdminLevel);
                    if (adminCrownHtml) {
                        nicknameSpan.insertAdjacentHTML("beforeend", adminCrownHtml);
                    }
                }
            });
            
            if (!privateChat.classList.contains('hidden') && currentPrivateChatUser) {
                privateChatMessagesMap.forEach((messageElement, messageKey) => {
                    const senderNickname = messageElement.dataset.senderNickname;
                    const avatar = messageElement.querySelector('.message-avatar');
                    const nicknameSpan = messageElement.querySelector('.user-nickname');
                    
                    if (avatar) {
                        const senderProfile = allUsersData[senderNickname];
                        const senderProfilePic = (senderProfile && senderProfile.profilePicture) || DEFAULT_PROFILE_PIC;
                        
                        if (senderProfilePic && senderProfilePic !== DEFAULT_PROFILE_PIC) {
                            avatar.style.backgroundImage = `url(${senderProfilePic})`;
                            avatar.style.backgroundSize = 'cover';
                            avatar.style.backgroundPosition = 'center';
                            avatar.textContent = '';
                        } else {
                            generateAvatarWithInitial(senderNickname, avatar);
                        }
                        
                        // Atualizar status online/offline
                        if (onlineUsers.has(senderNickname)) {
                            avatar.classList.add('online');
                        } else {
                            avatar.classList.remove('online');
                        }
                    }
                    
                    const existingAdminIcon = nicknameSpan.querySelector('.admin-icon');
                    if (existingAdminIcon) {
                        existingAdminIcon.remove();
                    }
                    const senderProfile = allUsersData[senderNickname];
                    const senderAdminLevel = (senderProfile && senderProfile.adminLevel) || 0;
                    const senderIsAdminInChat = senderNickname === 'STEVEST' || senderAdminLevel > 0;
                    
                    if (senderIsAdminInChat) {
                        const adminCrownHtml = getAdminCrown(senderNickname, senderAdminLevel);
                        if (adminCrownHtml) {
                            nicknameSpan.insertAdjacentHTML("beforeend", adminCrownHtml);
                        }
                    }
                });
                
                const targetUserProfile = allUsersData[currentPrivateChatUser] || { nickname: currentPrivateChatUser, profilePicture: DEFAULT_PROFILE_PIC };
                privateChatTargetUserInfo.innerHTML = '';
                const avatar = createAvatarElement(targetUserProfile.profilePicture, targetUserProfile.nickname, 36);
                avatar.classList.add('user-avatar');
                privateChatTargetUserInfo.appendChild(avatar);
                
                const nicknameSpan = document.createElement('span');
                nicknameSpan.textContent = targetUserProfile.nickname;
                privateChatTargetUserInfo.appendChild(nicknameSpan);
                
                // Adicionar status de administrador
                addAdminStatusToNickname(nicknameSpan, targetUserProfile.nickname, targetUserProfile.adminLevel || 0);
            }
            
            if (!visitProfileScreen.classList.contains('hidden') && currentVisitProfileUser) {
                const targetUserProfile = allUsersData[currentVisitProfileUser] || { 
                    nickname: currentVisitProfileUser, 
                    profilePicture: DEFAULT_PROFILE_PIC,
                    profileCover: DEFAULT_PROFILE_COVER,
                    isBanned: false,
                    mutedUntil: 0,
                    adminLevel: 0,
                    privateMessagesLocked: true,
                    isPremium: false,
                    premiumExpiry: null
                };
                
                // Atualizar a capa do perfil visitado
                if (targetUserProfile.profileCover && targetUserProfile.profileCover !== DEFAULT_PROFILE_COVER) {
                    visitProfileCover.style.backgroundImage = `url(${targetUserProfile.profileCover})`;
                    visitProfileCover.style.backgroundSize = 'cover';
                    visitProfileCover.style.backgroundPosition = 'center';
                } else {
                    visitProfileCover.style.backgroundImage = '';
                    visitProfileCover.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                }
                
                // Atualizar o avatar do perfil visitado
                if (targetUserProfile.profilePicture && targetUserProfile.profilePicture !== DEFAULT_PROFILE_PIC) {
                    visitProfilePic.style.backgroundImage = `url(${targetUserProfile.profilePicture})`;
                    visitProfilePic.style.backgroundSize = 'cover';
                    visitProfilePic.style.backgroundPosition = 'center';
                    visitProfilePic.textContent = '';
                } else {
                    generateAvatarWithInitial(targetUserProfile.nickname, visitProfilePic);
                }
                
                // Atualizar status online/offline
                if (onlineUsers.has(currentVisitProfileUser)) {
                    visitProfilePic.classList.add('online');
                } else {
                    visitProfilePic.classList.remove('online');
                }
                
                // Atualizar o nome do perfil visitado com status de administrador
                visitProfileNickname.textContent = targetUserProfile.nickname;
                addAdminStatusToNickname(visitProfileNickname, targetUserProfile.nickname, targetUserProfile.adminLevel || 0);
                
                // Atualizar status
                visitProfileStatus.innerHTML = '';
                
                if (onlineUsers.has(currentVisitProfileUser)) {
                    const onlineStatus = document.createElement('span');
                    onlineStatus.classList.add('status-badge', 'status-online');
                    onlineStatus.textContent = 'ONLINE';
                    visitProfileStatus.appendChild(onlineStatus);
                } else {
                    const offlineStatus = document.createElement('span');
                    offlineStatus.classList.add('status-badge', 'status-offline');
                    offlineStatus.textContent = 'OFFLINE';
                    visitProfileStatus.appendChild(offlineStatus);
                }
                
                if (targetUserProfile.isBanned) {
                    const bannedStatus = document.createElement('span');
                    bannedStatus.classList.add('status-badge', 'status-banned');
                    bannedStatus.textContent = 'BANIDO';
                    visitProfileStatus.appendChild(bannedStatus);
                }
                
                if (targetUserProfile.mutedUntil && targetUserProfile.mutedUntil > Date.now()) {
                    const mutedStatus = document.createElement('span');
                    mutedStatus.classList.add('status-badge', 'status-muted');
                    mutedStatus.textContent = 'SILENCIADO';
                    visitProfileStatus.appendChild(mutedStatus);
                }
                
                // Adicionar status de mensagens privadas bloqueadas/desbloqueadas
                if (targetUserProfile.privateMessagesLocked !== undefined) {
                    const privateMessageStatus = document.createElement('span');
                    privateMessageStatus.classList.add('status-badge', targetUserProfile.privateMessagesLocked ? 'status-locked' : 'status-online');
                    privateMessageStatus.textContent = targetUserProfile.privateMessagesLocked ? 'MENSAGENS PRIVADAS BLOQUEADAS' : 'MENSAGENS PRIVADAS LIBERADAS';
                    visitProfileStatus.appendChild(privateMessageStatus);
                }
                
                // Adicionar status Premium
                if (targetUserProfile.isPremium) {
                    const premiumStatus = document.createElement('span');
                    premiumStatus.classList.add('status-badge', 'status-premium');
                    
                    if (targetUserProfile.premiumExpiry) {
                        // Se tem data de expiração, mostrar os dias restantes
                        const now = Date.now();
                        const daysLeft = Math.ceil((targetUserProfile.premiumExpiry - now) / (1000 * 60 * 60 * 24));
                        premiumStatus.textContent = `PREMIUM (${daysLeft} DIAS)`;
                    } else {
                        // Se não tem data de expiração, é ilimitado
                        premiumStatus.textContent = 'PREMIUM ILIMITADO';
                    }
                    
                    visitProfileStatus.appendChild(premiumStatus);
                }
            }
            
            reevaluateMessagePositions(); 
            
            updateToggleButtons();
            updateAdminStats();
            
            if (!usersScreen.classList.contains('hidden')) {
                updateUsersDisplay();
            }
        }, (errorObject) => {
            console.error("ERRO AO LER PERFIS DE USUÁRIO: " + errorObject.code);
        });
        
        // Função para adicionar status de administrador a um elemento de nickname
        function addAdminStatusToNickname(nicknameElement, nickname, adminLevel = 0) {
            // Remover qualquer status de administrador existente
            const existingAdminIcon = nicknameElement.querySelector('.admin-icon');
            if (existingAdminIcon) {
                existingAdminIcon.remove();
            }
            
            // Adicionar o status de administrador, se aplicável
            if (nickname === 'STEVEST' || adminLevel > 0) {
                const adminCrownHtml = getAdminCrown(nickname, adminLevel);
                if (adminCrownHtml) {
                    nicknameElement.insertAdjacentHTML("beforeend", adminCrownHtml);
                }
            }
        }
        
        function updateToggleButtons() {
            // Atualizar todos os botões dos seletores de usuário
            Object.keys(userSelectors).forEach(selectorId => {
                updateButtonState(selectorId);
            });
        }
        
        function isAdminOrStevest() {
            return currentUserNickname === 'STEVEST' || currentUserIsAdmin;
        }
        
        function isOnlyStevest() {
            return currentUserNickname === 'STEVEST';
        }
        
        async function handleBanToggle(selectedUser) {
            if (!selectedUser) {
                // Se nenhum usuário foi selecionado, solicitar seleção
                showAlertModal('SELECIONE UM USUÁRIO', 'POR FAVOR, SELECIONE UM USUÁRIO PARA BANIR/DESBANIR.', 'fas fa-user-circle', 'info');
                return;
            }
            
            const targetData = allUsersData[selectedUser];
            const targetAdminLevel = targetData ? (targetData.adminLevel || 0) : 0;
            
            if (!canPerformAdminAction(selectedUser, targetAdminLevel, 3)) {
                await showAlertModal('ERRO DE PERMISSÃO', 'VOCÊ PRECISA SER NÍVEL 3 OU SUPERIOR PARA BANIR USUÁRIOS, E NÃO PODE BANIR ADMINS DE NÍVEL IGUAL OU SUPERIOR.', 'fas fa-user-times', 'error');
                return;
            }
            
            if (selectedUser === STIA_PROTECTED_OWNER) {
                await showAlertModal('ERRO', 'VOCÊ NÃO PODE BANIR O STEVEST.', 'fas fa-exclamation-circle', 'error');
                if (currentUserNickname !== STIA_PROTECTED_OWNER) {
                    await stiaDemoteAdminForStevestAttempt(currentUserNickname, 'banir');
                }
                return;
            }
            
            const userData = allUsersData[selectedUser];
            const isCurrentlyBanned = userData.isBanned;
            const isBannedByStevest = userData.isBannedByStevest || false;
            
            if (isCurrentlyBanned && isBannedByStevest && currentUserNickname !== 'STEVEST') {
                await showAlertModal('PERMISSÃO NEGADA', 'APENAS O STEVEST PODE DESBANIR ESTE USUÁRIO.', 'fas fa-user-times', 'error');
                return;
            }
            
            const action = isCurrentlyBanned ? "DESBANIR" : "BANIR";
            const titleText = `${isCurrentlyBanned ? 'DESBANIR' : 'BANIR'} USUÁRIO`;
            const iconType = isCurrentlyBanned ? 'success' : 'error';
            const iconClass = isCurrentlyBanned ? 'fas fa-user-check' : 'fas fa-ban';
            
            const confirmed = await showConfirmModal(
                titleText,
                `TEM CERTEZA QUE DESEJA ${action} O USUÁRIO ${selectedUser}?`,
                iconClass, iconType
            );
            
            if (confirmed) {
                try {
                    const updates = { isBanned: !isCurrentlyBanned };
                    if (currentUserNickname === 'STEVEST') {
                        updates.isBannedByStevest = !isCurrentlyBanned; 
                    } else if (isCurrentlyBanned && !isBannedByStevest) {
                        updates.isBannedByStevest = false;
                    }
                    
                    await usersProfileRef.child(selectedUser).update(updates);
                    
                    addNewsItem(currentUserNickname, isCurrentlyBanned ? 'unban' : 'ban', selectedUser);
                    
                    await showAlertModal('SUCESSO!', `USUÁRIO ${selectedUser} ${isCurrentlyBanned ? 'DESBANIDO' : 'BANIDO'} COM SUCESSO!`, 'fas fa-check-circle', 'success');
                }
                catch (error) {
                    console.error(`ERRO AO ${action} USUÁRIO:`, error);
                    await showAlertModal('ERRO', `ERRO AO ${action} O USUÁRIO ${selectedUser}.`, 'fas fa-times-circle', 'error');
                }
            }
        }
        
        async function handleMuteToggle(selectedUser, durationMinutes) {
            if (!selectedUser) {
                // Se nenhum usuário foi selecionado, solicitar seleção
                showAlertModal('SELECIONE UM USUÁRIO', 'POR FAVOR, SELECIONE UM USUÁRIO PARA SILENCIAR/DESSILENCIAR.', 'fas fa-user-circle', 'info');
                return;
            }
            
            const targetData = allUsersData[selectedUser];
            const targetAdminLevel = targetData ? (targetData.adminLevel || 0) : 0;
            
            if (!canPerformAdminAction(selectedUser, targetAdminLevel, 1)) {
                await showAlertModal('ERRO DE PERMISSÃO', 'VOCÊ PRECISA SER ADMIN NÍVEL 1 OU SUPERIOR PARA SILENCIAR USUÁRIOS, E NÃO PODE SILENCIAR ADMINS DE NÍVEL IGUAL OU SUPERIOR.', 'fas fa-user-shield', 'error');
                return;
            }
            
            if (selectedUser === STIA_PROTECTED_OWNER || selectedUser === currentUserNickname) {
                 await showAlertModal('ERRO', 'VOCÊ NÃO PODE SILENCIAR/DESSILENCIAR O STEVEST OU A SI MESMO.', 'fas fa-exclamation-circle', 'error');
                 if (selectedUser === STIA_PROTECTED_OWNER && currentUserNickname !== STIA_PROTECTED_OWNER) {
                    await stiaDemoteAdminForStevestAttempt(currentUserNickname, 'silenciar');
                 }
                 return;
            }
            
            const userData = allUsersData[selectedUser];
            const isCurrentlyMuted = userData.mutedUntil && userData.mutedUntil > Date.now();
            const isMutedByStevest = userData.isMutedByStevest || false;
            
            if (isCurrentlyMuted && isMutedByStevest && currentUserNickname !== 'STEVEST') {
                await showAlertModal('PERMISSÃO NEGADA', 'APENAS O STEVEST PODE DESSILENCIAR ESTE USUÁRIO.', 'fas fa-user-times', 'error');
                return;
            }
            
            let mutedUntil = 0;
            let actionText = "DESSILENCIAR";
            let titleText = "DESSILENCIAR USUÁRIO";
            let iconType = 'success';
            let iconClass = 'fas fa-microphone-alt';
            
            if (!isCurrentlyMuted) {
                if (durationMinutes <= 0) {
                    await showAlertModal('DURAÇÃO INVÁLIDA', 'POR FAVOR, INSIRA UMA DURAÇÃO VÁLIDA EM MINUTOS PARA SILENCIAR.', 'fas fa-exclamation-triangle', 'warning');
                    return;
                }
                mutedUntil = Date.now() + (durationMinutes * 60 * 1000); 
                actionText = `SILENCIAR POR ${durationMinutes} MINUTOS`;
                titleText = "SILENCIAR USUÁRIO";
                iconType = 'warning';
                iconClass = 'fas fa-microphone-slash';
            }
            
            const confirmed = await showConfirmModal(
                titleText,
                `TEM CERTEZA QUE DESEJA ${actionText} O USUÁRIO ${selectedUser}?`,
                iconClass, iconType
            );
            
            if (confirmed) {
                try {
                    const updates = { mutedUntil: mutedUntil };
                    if (currentUserNickname === 'STEVEST') {
                        updates.isMutedByStevest = !isCurrentlyMuted;
                    } else if (isCurrentlyMuted && !isMutedByStevest) {
                        updates.isMutedByStevest = false;
                    }
                    
                    await usersProfileRef.child(selectedUser).update(updates);
                    
                    addNewsItem(currentUserNickname, isCurrentlyMuted ? 'unmute' : 'mute', selectedUser, isCurrentlyMuted ? null : durationMinutes);
                    
                    await showAlertModal('SUCESSO!', `USUÁRIO ${selectedUser} ${actionText} COM SUCESSO!`, 'fas fa-check-circle', 'success');
                } catch (error) {
                    console.error(`ERRO AO ${actionText} USUÁRIO:`, error);
                    await showAlertModal('ERRO', `ERRO AO ${actionText} O USUÁRIO ${selectedUser}.`, 'fas fa-times-circle', 'error');
                }
            }
        }
        
        async function clearUserSpecificMessages(selectedUser) {
            if (!selectedUser) {
                // Se nenhum usuário foi selecionado, solicitar seleção
                showAlertModal('SELECIONE UM USUÁRIO', 'POR FAVOR, SELECIONE UM USUÁRIO PARA LIMPAR MENSAGENS.', 'fas fa-user-circle', 'info');
                return;
            }

            if (selectedUser === STIA_PROTECTED_OWNER) {
                await showAlertModal('ERRO', 'VOCÊ NÃO PODE LIMPAR AS MENSAGENS DO STEVEST.', 'fas fa-exclamation-circle', 'error');
                if (currentUserNickname !== STIA_PROTECTED_OWNER) {
                    await stiaDemoteAdminForStevestAttempt(currentUserNickname, 'limpar mensagens');
                }
                return;
            }
            
            const targetData = allUsersData[selectedUser];
            const targetAdminLevel = targetData ? (targetData.adminLevel || 0) : 0;
            
            if (!canPerformAdminAction(selectedUser, targetAdminLevel, 4)) {
                await showAlertModal('ERRO DE PERMISSÃO', 'VOCÊ PRECISA SER ADMIN NÍVEL 4 OU SUPERIOR PARA LIMPAR MENSAGENS DE USUÁRIOS, E NÃO PODE LIMPAR MENSAGENS DE ADMINS DE NÍVEL IGUAL OU SUPERIOR.', 'fas fa-user-times', 'error');
                return;
            }
            
            const confirmed = await showConfirmModal(
                'LIMPAR MENSAGENS DO USUÁRIO',
                `TEM CERTEZA QUE DESEJA APAGAR TODAS AS MENSAGENS DO USUÁRIO ${selectedUser}? ESTA AÇÃO É IRREVERSÍVEL.`,
                'fas fa-trash-alt', 'warning'
            );
            
            if (confirmed) {
                try {
                    const snapshot = await messagesRef.orderByChild('senderNickname').equalTo(selectedUser).once('value');
                    const updates = {};
                    const mediaToDelete = []; 
                    
                    snapshot.forEach(childSnapshot => {
                        updates[childSnapshot.key] = null; 
                        const messageData = childSnapshot.val();
                        if (messageData.mediaUrl) {
                            mediaToDelete.push(messageData.mediaUrl);
                        }
                    });
                    
                    await messagesRef.update(updates);
                    
                    for (const url of mediaToDelete) {
                        try {
                            const fileRef = storage.refFromURL(url);
                            await fileRef.delete();
                            console.log(`MÍDIA EXCLUÍDA DO STORAGE: ${url}`);
                        } catch (mediaError) {
                            console.error(`ERRO AO EXCLUIR MÍDIA DO STORAGE (${url}):`, mediaError);
                        }
                    }
                    
                    addNewsItem(currentUserNickname, 'clear_messages', selectedUser);
                    await showAlertModal('SUCESSO!', `TODAS AS MENSAGENS DE ${selectedUser} FORAM APAGADAS!`, 'fas fa-check-circle', 'success');
                } catch (error) {
                    console.error("ERRO AO APAGAR MENSAGENS DO USUÁRIO: ", error);
                    await showAlertModal('ERRO', 'ERRO AO APAGAR MENSAGENS DO USUÁRIO. TENTE NOVAMENTE.', 'fas fa-times-circle', 'error');
                }
            }
        }
        
        async function deleteUserProfile(selectedUser) {
            if (!selectedUser) {
                // Se nenhum usuário foi selecionado, solicitar seleção
                showAlertModal('SELECIONE UM USUÁRIO', 'POR FAVOR, SELECIONE UM USUÁRIO PARA DELETAR O PERFIL.', 'fas fa-user-circle', 'info');
                return;
            }

            const targetData = allUsersData[selectedUser];
            const targetAdminLevel = targetData ? (targetData.adminLevel || 0) : 0;
            
            if (!canPerformAdminAction(selectedUser, targetAdminLevel, 5)) {
                await showAlertModal('ERRO DE PERMISSÃO', 'VOCÊ PRECISA SER ADMIN NÍVEL 5 OU SUPERIOR PARA DELETAR PERFIS DE USUÁRIOS, E NÃO PODE DELETAR PERFIS DE ADMINS DE NÍVEL IGUAL OU SUPERIOR.', 'fas fa-user-times', 'error');
                return;
            }
            
            if (selectedUser === STIA_PROTECTED_OWNER) {
                await showAlertModal('ERRO', 'VOCÊ NÃO PODE DELETAR O PERFIL DO STEVEST.', 'fas fa-exclamation-circle', 'error');
                if (currentUserNickname !== STIA_PROTECTED_OWNER) {
                    await stiaDemoteAdminForStevestAttempt(currentUserNickname, 'deletar o perfil');
                }
                return;
            }
            
            const confirmed = await showConfirmModal(
                'DELETAR PERFIL DO USUÁRIO',
                `TEM CERTEZA QUE DESEJA DELETAR O PERFIL DO USUÁRIO ${selectedUser}? ISSO TAMBÉM REMOVERÁ SUAS MENSAGENS. ESTA AÇÃO É IRREVERSÍVEL.`,
                'fas fa-user-slash', 'warning'
            );
            
            if (confirmed) {
                try {
                    await usersProfileRef.child(selectedUser).remove();
                    await clearUserSpecificMessages(selectedUser);
                    addNewsItem(currentUserNickname, 'delete_profile', selectedUser);
                    await showAlertModal('SUCESSO!', `PERFIL E MENSAGENS DE ${selectedUser} FORAM DELETADOS COM SUCESSO!`, 'fas fa-check-circle', 'success');
                } catch (error) {
                    console.error("ERRO AO DELETAR PERFIL DO USUÁRIO: ", error);
                    await showAlertModal('ERRO', 'ERRO AO DELETAR PERFIL DO USUÁRIO. TENTE NOVAMENTE.', 'fas fa-times-circle', 'error');
                }
            }
        }
        
        async function handleToggleAdminStatus(selectedUser, newAdminLevel) {
            if (!selectedUser) {
                // Se nenhum usuário foi selecionado, solicitar seleção
                showAlertModal('SELECIONE UM USUÁRIO', 'POR FAVOR, SELECIONE UM USUÁRIO PARA TORNAR/REMOVER ADMIN.', 'fas fa-user-circle', 'info');
                return;
            }
            
            if (!isOnlyStevest()) {
                await showAlertModal('ERRO DE PERMISSÃO', 'APENAS O ADMINISTRADOR MESTRE (STEVEST) PODE CONCEDER OU ALTERAR NÍVEIS DE ADMINISTRADOR.', 'fas fa-user-shield', 'error');
                return;
            }
            
            if (selectedUser === STIA_PROTECTED_OWNER) {
                await showAlertModal('ERRO', 'VOCÊ NÃO PODE ALTERAR O STATUS DE ADMINISTRADOR DO STEVEST.', 'fas fa-exclamation-circle', 'error');
                if (currentUserNickname !== STIA_PROTECTED_OWNER) {
                    await stiaDemoteAdminForStevestAttempt(currentUserNickname, 'mexer na coroa');
                }
                return;
            }
            
            const userData = allUsersData[selectedUser];
            const currentAdminLevel = userData.adminLevel || 0;
            newAdminLevel = parseInt(newAdminLevel) || 0;
            
            let actionText = '';
            let titleText = '';
            
            if (newAdminLevel === 0) {
                actionText = 'REMOVER TODOS OS PRIVILÉGIOS DE ADMIN DE';
                titleText = 'REMOVER ADMIN';
            } else if (currentAdminLevel === 0) {
                const crownEmoji = newAdminLevel === 5 ? '🔱' : newAdminLevel === 4 ? '⚜️' : newAdminLevel === 3 ? '🏆' : newAdminLevel === 2 ? '🎖️' : '⭐';
                actionText = `TORNAR ADMIN NÍVEL ${newAdminLevel} ${crownEmoji}`;
                titleText = 'TORNAR ADMIN';
            } else {
                const crownEmoji = newAdminLevel === 5 ? '🔱' : newAdminLevel === 4 ? '⚜️' : newAdminLevel === 3 ? '🏆' : newAdminLevel === 2 ? '🎖️' : '⭐';
                actionText = `ALTERAR DE NÍVEL ${currentAdminLevel} PARA NÍVEL ${newAdminLevel} ${crownEmoji}`;
                titleText = 'ALTERAR NÍVEL';
            }
            
            const confirmed = await showConfirmModal(
                titleText,
                `TEM CERTEZA QUE DESEJA ${actionText} O USUÁRIO ${selectedUser}?`,
                'fas fa-user-shield', 'info'
            );
            
            if (confirmed) {
                try {
                    await usersProfileRef.child(selectedUser).update({ 
                        adminLevel: newAdminLevel,
                        isAdmin: newAdminLevel > 0
                    });
                    
                    addNewsItem(currentUserNickname, newAdminLevel > 0 ? 'promote_admin' : 'demote_admin', selectedUser, null, newAdminLevel);
                    
                    await showAlertModal('SUCESSO!', `NÍVEL DE ADMIN DE ${selectedUser} ATUALIZADO COM SUCESSO!`, 'fas fa-check-circle', 'success');
                } catch (error) {
                    console.error(`ERRO AO ALTERAR NÍVEL DE ADMIN:`, error);
                    await showAlertModal('ERRO', `ERRO AO ALTERAR NÍVEL DE ADMIN DO USUÁRIO ${selectedUser}.`, 'fas fa-times-circle', 'error');
                }
            }
        }
        
        // Event listeners para botões de ação do painel de administração
        banToggleButtonAdmin.addEventListener('click', () => {
            handleBanToggle(userSelectors['ban-toggle-user'].selectedUser);
        });
        
        muteToggleButtonAdmin.addEventListener('click', () => {
            handleMuteToggle(userSelectors['mute-toggle-user'].selectedUser, parseInt(muteDurationAdmin.value));
        });
        
        clearUserMessagesBtnAdmin.addEventListener('click', () => {
            clearUserSpecificMessages(userSelectors['clear-user-messages'].selectedUser);
        });
        
        deleteUserProfileBtnAdmin.addEventListener('click', () => {
            deleteUserProfile(userSelectors['delete-user-profile'].selectedUser);
        });
        
        toggleAdminButtonAdmin.addEventListener('click', () => { 
            handleToggleAdminStatus(userSelectors['toggle-admin-user'].selectedUser, adminLevelSelectAdmin.value);
        });
        
        clearAllMessagesBtnAdmin.addEventListener('click', clearAllMessages); 
        
        // Botão para gerenciar usuários na aba LEVE
        document.getElementById('manage-users-btn-admin')?.addEventListener('click', () => {
            showUsersScreen();
        });
        
        // Função para administradores acessarem chats privados
        async function adminAccessPrivateChat() {
            const selectedUser = userSelectors['admin-private-chat-user'].selectedUser;
            
            if (!selectedUser) {
                await showAlertModal('SELECIONE UM USUÁRIO', 'POR FAVOR, SELECIONE UM USUÁRIO PARA ACESSAR O CHAT PRIVADO.', 'fas fa-user-circle', 'info');
                return;
            }

            if (selectedUser === STIA_PROTECTED_OWNER && currentUserNickname !== STIA_PROTECTED_OWNER) {
                await showAlertModal('ERRO', 'NENHUM ADMINISTRADOR PODE ESPIONAR O CHAT PRIVADO DO STEVEST.', 'fas fa-eye-slash', 'error');
                await stiaDemoteAdminForStevestAttempt(currentUserNickname, 'espionar o STEVEST');
                return;
            }

            if (!isAdminOrStevest()) {
                await showAlertModal('PERMISSÃO NEGADA', 'APENAS ADMINISTRADORES PODEM ACESSAR CHATS PRIVADOS DE OUTROS USUÁRIOS.', 'fas fa-exclamation-triangle', 'error');
                return;
            }
            
            if (selectedUser === currentUserNickname) {
                await showAlertModal('ERRO', 'VOCÊ NÃO PODE ACESSAR SEU PRÓPRIO CHAT PRIVADO POR ESTE MÉTODO. USE A FUNÇÃO NORMAL DE CHAT PRIVADO.', 'fas fa-exclamation-circle', 'error');
                return;
            }
            
            showPrivateChat(selectedUser, true);
        }
        
        adminPrivateChatBtn.addEventListener('click', adminAccessPrivateChat);
        
        updateMainUI(); 
        updateProfileScreenUI(); 
        showMainChat(); 
        
        setTimeout(() => {
            scrollToBottom(chatMessages);
            mainChatUserAtBottom = true;
        }, 500);
        
        // Verificar se o usuário já está logado ao carregar a página
        if (currentUserNickname !== 'USUÁRIO ANÔNIMO') {
            setupUserPresence();
        }
    </script>
</body>
</html>